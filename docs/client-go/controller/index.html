<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-client-go/controller">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Controller | 《从零实现Kubernetes自定义控制器》</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://caozhuozi.github.io/crd-controller-from-scratch/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://caozhuozi.github.io/crd-controller-from-scratch/img/logo.png"><meta data-rh="true" property="og:url" content="https://caozhuozi.github.io/crd-controller-from-scratch/docs/client-go/controller"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Controller | 《从零实现Kubernetes自定义控制器》"><meta data-rh="true" name="description" content="在本节中，我们将正式介绍在Kubernetes语境下，控制器（Controller）究竟指的是什么。"><meta data-rh="true" property="og:description" content="在本节中，我们将正式介绍在Kubernetes语境下，控制器（Controller）究竟指的是什么。"><link data-rh="true" rel="icon" href="/crd-controller-from-scratch/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://caozhuozi.github.io/crd-controller-from-scratch/docs/client-go/controller"><link data-rh="true" rel="alternate" href="https://caozhuozi.github.io/crd-controller-from-scratch/docs/client-go/controller" hreflang="en"><link data-rh="true" rel="alternate" href="https://caozhuozi.github.io/crd-controller-from-scratch/docs/client-go/controller" hreflang="x-default"><link rel="stylesheet" href="/crd-controller-from-scratch/assets/css/styles.37df9119.css">
<link rel="preload" href="/crd-controller-from-scratch/assets/js/runtime~main.56e28771.js" as="script">
<link rel="preload" href="/crd-controller-from-scratch/assets/js/main.66bc2718.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#e6f6e6;color:#5f805b" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">🥳v0.6.0-rc2 is released.🎉</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/crd-controller-from-scratch/"><div class="navbar__logo"><img src="/crd-controller-from-scratch/img/logo.png" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/crd-controller-from-scratch/img/logo.png" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/crd-controller-from-scratch/docs/intro">开始</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/caozhuozi/crd-controller-from-scratch" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/crd-controller-from-scratch/docs/intro">前言</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/crd-controller-from-scratch/docs/apimachinery/apimachinery">apimachinery</a><button aria-label="Toggle the collapsible sidebar category &#x27;apimachinery&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/crd-controller-from-scratch/docs/client-go/client-go">client-go</a><button aria-label="Toggle the collapsible sidebar category &#x27;client-go&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/crd-controller-from-scratch/docs/client-go/restclient">RESTClient</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/crd-controller-from-scratch/docs/client-go/controller">Controller</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/crd-controller-from-scratch/docs/client-go/informer-is-all-you-need">informer is all you need</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/crd-controller-from-scratch/docs/client-go/summary">本章小结</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/crd-controller-from-scratch/docs/putting-it-all-together/putting-it-all-together">putting it all together</a><button aria-label="Toggle the collapsible sidebar category &#x27;putting it all together&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/crd-controller-from-scratch/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/crd-controller-from-scratch/docs/client-go/client-go"><span itemprop="name">client-go</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Controller</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Controller</h1><p>在本节中，我们将正式介绍在Kubernetes语境下，<em>控制器（Controller）</em>究竟指的是什么。
在正式介绍<em>Controller</em>概念之前，我们需要铺垫一些辅助概念。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="对象的状态与协调">对象的状态与协调<a href="#对象的状态与协调" class="hash-link" aria-label="Direct link to 对象的状态与协调" title="Direct link to 对象的状态与协调">​</a></h2><p>早在<a href="/crd-controller-from-scratch/docs/apimachinery/kubernetes-api#kubernetes%E5%AF%B9%E8%B1%A1kubernetes-object">Kubernetes对象</a>小节，我们就已经介绍了Kubernetes是一个以Kubernetes API为中心的<em>声明式资源管理系统</em>。
用户向Kubernetes描述资源的期望状态，由Kubernetes系统控制以使资源达到期望状态。
在Kubernetes中，使Kubernetes对象的期望状态与实际状态保持一致的过程被称为<em>协调（reconcile）</em>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="控制器controller">控制器（Controller）<a href="#控制器controller" class="hash-link" aria-label="Direct link to 控制器（Controller）" title="Direct link to 控制器（Controller）">​</a></h2><p>在Kubernetes中，<em>控制器（Controller）</em>是指用于<em>协调</em>的无限循环<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup><sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup>。</p><p>当然，我们也可以从Kubernetes作为一个<em>声明式系统</em>的角度来解释<em>控制器</em>。
在声明式系统中，用户知道系统的期望状态，用户仅向系统提供期望状态的描述，由系统来确定从当前状态达到期望状态所需要的动作序列。
而系统中决定并执行动作序列的组件被称为<em>控制器</em>。</p><p>另外，Kubernetes设计文档<a href="https://github.com/kubernetes/design-proposals-archive/blob/main/architecture/resource-management.md#declarative-control" target="_blank" rel="noopener noreferrer">The Kubernetes Resource Model (KRM) <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 15"><path style="stroke:none;fill-rule:evenodd;fill:#24292f;fill-opacity:1" d="M7.977 0C3.567 0 0 3.438 0 7.691c0 3.399 2.285 6.278 5.453 7.293.399.079.543-.164.543-.367 0-.18-.016-.789-.016-1.426-2.218.457-2.68-.918-2.68-.918-.355-.89-.882-1.12-.882-1.12-.727-.47.05-.47.05-.47.805.051 1.231.79 1.231.79.711 1.172 1.86.84 2.324.636.063-.496.278-.84.5-1.03-1.77-.18-3.632-.84-3.632-3.798 0-.84.316-1.527.82-2.062-.078-.192-.356-.98.078-2.035 0 0 .676-.204 2.191.789a7.99 7.99 0 0 1 3.989 0c1.52-.993 2.195-.79 2.195-.79.434 1.055.156 1.844.078 2.036.516.535.817 1.222.817 2.062 0 2.957-1.86 3.606-3.645 3.797.293.242.543.7.543 1.426 0 1.031-.012 1.86-.012 2.113 0 .203.145.445.54.367 3.171-1.015 5.453-3.894 5.453-7.293C15.953 3.438 12.374 0 7.976 0Zm0 0"></path></svg></a>也对<em>Controller</em>的行为做了规范：</p><blockquote><p>The intent is carried out by asynchronous controllers, which interact through the Kubernetes API.
Controllers don’t access the state store, etcd, directly, and don’t communicate via private direct APIs.</p><p>...</p><p>Controllers continuously strive to make the observed state match the desired state, and report back their status to the apiserver asynchronously.</p></blockquote><p>意思是说控制器<strong>只能</strong>通过与Kubernetes API交互来实施协调动作，而不能直接访问状态集群的存储（etcd）或者其他私有的服务。</p><p>Kubernetes集群内置了一些原生资源的控制器，例如Job控制器等。
当用户声明一个<code>job</code>资源后，Job控制器本身并不创建pod资源来执行任务，它而是通过Kubernetes API来创建pod资源来运行任务<sup id="fnref-4"><a href="#fn-4" class="footnote-ref">4</a></sup>，并同时不断将<code>job</code>对象的状态&quot;汇报&quot;给Kubernetes API以写入<code>etcd</code>中。
可见，Job控制器的所有行为都只与Kubernetes交互。</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>由于资源<em>控制器</em>只能与Kubernetes API交互，我们也可以认为<em>控制器</em>是一种具有特殊行为的资源客户端。</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="控制器与子资源status">控制器与子资源status<a href="#控制器与子资源status" class="hash-link" aria-label="Direct link to 控制器与子资源status" title="Direct link to 控制器与子资源status">​</a></h2><p>在之前<a href="/crd-controller-from-scratch/docs/apimachinery/kubernetes-api#%E5%AD%90%E8%B5%84%E6%BA%90subresource">子资源（subresource）</a>小节中，我们引入了<em>子资源</em>的概念。
我们已经知道引入<code>status</code>子资源的动机是为了将对Kubernetes对象<code>status</code>字段（实际状态）的变更与<code>spec</code>字段（期望状态）的变更分开。
但当时由于缺乏Kubernetes<em>控制器</em>的概念，我们从并发控制的角度去解释分开的原由。在这里，我们可以补充更多的背景。Kubernetes作为一个<em>声明式资源管理系统</em>：</p><ul><li>用户可以写入（或更改）资源的<code>spec</code>（期望状态），但不应更改资源的<code>status</code>字段；</li><li><em>控制器</em>可以写入（或更改）<code>status</code>字段（实际状态），但不应更改资源的<code>spec</code>字段。</li></ul><p>通过资源API创建或者更改资源时，<code>kube-apiserver</code>会自动忽略请求体中<code>status</code>字段中的内容；而通过子资源<code>status</code>API更新资源状态时，<code>kube-apiserver</code>也会忽略请求体中<code>status</code>字段之外的更改。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用restclient更新kubernetes对象状态">使用RESTClient更新Kubernetes对象状态<a href="#使用restclient更新kubernetes对象状态" class="hash-link" aria-label="Direct link to 使用RESTClient更新Kubernetes对象状态" title="Direct link to 使用RESTClient更新Kubernetes对象状态">​</a></h3><p>我们现在已经知道<em>控制器</em>是一种具有特殊行为的Kubernetes客户端，它需要通过Kubernetes子资源API<code>status</code>&quot;汇报&quot;Kubernetes对象的当前状态。幸运的是，<code>client-go</code>作为Kubernetes标准客户端库已经为我们封装了相关方法用于与子资源API交互。</p><p>我们先从<code>client-go</code>封装的<a href="/crd-controller-from-scratch/docs/client-go/restclient#%E8%B5%84%E6%BA%90%E5%AE%A2%E6%88%B7%E7%AB%AF">资源客户端</a>说起。对于那些是<em>Kubernetes对象</em>的资源类型，<code>client-go</code>的原生<em>资源客户端</em>专门封装了一个<code>UpdateStatus()</code>的方法用于更新对象的当前状态。
例如，我们以<code>Pod</code>客户端为例：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodInterface </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CreateOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UpdateOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">UpdateStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UpdateOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeleteOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GetOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ListOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodList</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Watch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ListOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">watch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Interface</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Patch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pt types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PatchType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PatchOptions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> subresources </span><span class="token operator" style="color:#393A34">...</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们在<a href="/crd-controller-from-scratch/docs/client-go/restclient#%E8%B5%84%E6%BA%90%E5%AE%A2%E6%88%B7%E7%AB%AF">资源客户端</a>小节中已经说明了<em>资源客户端</em>使用的是<code>RESTClient</code>组件。我们以<code>pods</code>资源客户端<code>UpdateStatus()</code>方法的实现为例：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pods</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">UpdateStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UpdateOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Namespace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Resource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;pods&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">SubResource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;status&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">VersionedParams</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">opts</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scheme</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ParameterCodec</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Body</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从实现来看，<a href="/crd-controller-from-scratch/docs/client-go/restclient#request%E7%B1%BB%E5%9E%8B"><code>Request</code>类型</a>已经为我们封装了<code>SubResource()</code>方法，使用方式也十分简单，只要填入相应的<em>子资源</em>名称就能与相应的子资源API交互。
在本例中，由于要通过子资源<code>status</code>更新对象的当前状态，只要在参数中填入<code>&quot;status&quot;</code>即可。<a href="/crd-controller-from-scratch/docs/intro#%E7%BA%A6%E5%AE%9A">🎈</a></p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>注</div><div class="admonitionContent_S0QG"><p>通过探究原生<code>pods</code>资源客户端<code>UpdateStatus()</code>的实现，我们其实已经学会了如何使用<code>RESTClient</code>基础组件更新对象的当前状态——我们在编写<em>自定义资源</em>客户端时也需要使用同样的方法。</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="控制器模式">控制器模式<a href="#控制器模式" class="hash-link" aria-label="Direct link to 控制器模式" title="Direct link to 控制器模式">​</a></h2><p>根据<em>控制器</em>的定义，我们可以通过一段伪代码描述一种最为简单基础的控制器实现：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  desired </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getDesiredState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  current </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getCurrentState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">makeChanges</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">desired</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Kubernetes各种控制器的实现本质上都是对此基本框架的优化和扩展。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="被遗忘的监听watch机制">被遗忘的监听（watch）机制<a href="#被遗忘的监听watch机制" class="hash-link" aria-label="Direct link to 被遗忘的监听（watch）机制" title="Direct link to 被遗忘的监听（watch）机制">​</a></h2><p>在上述的结构中，相比于通过轮询不断主动获取资源的状态， 一个明显可以优化的地方是我们可以<strong>被动地</strong>只在<strong>有对象状态发生变更的时候</strong>才触发协调动作。
原因也很简单，只有当对象状态发生变更的时候，才有可能与期望的状态发生偏离，因此我们只要在此时刻触发协调动作即可。</p><p>幸运的是，Kubernetes API支持持续<em>监听（watch）</em>资源的变更（包括<em>新增</em>，<em>修改</em>以及<em>删除</em>事件）。
具体来说，在资源对应的API的基础上加上<code>?watch=true</code>的查询参数（query parameter）就可以对资源的变更进行监听。
例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">GET /api/v1/namespaces/test/pods?watch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Transfer-Encoding: chunked</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ADDED&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;object&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;kind&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Pod&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v1&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;metadata&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;resourceVersion&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10596&quot;</span><span class="token plain">, </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">, </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;MODIFIED&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;object&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;kind&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Pod&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v1&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;metadata&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;resourceVersion&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;11020&quot;</span><span class="token plain">, </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">, </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这些变更事件以HTTP&quot;流&quot;<sup id="fnref-5"><a href="#fn-5" class="footnote-ref">5</a></sup>的形式返回。另外，从上述例子可以看出：每个变更事件包括两个部分：类型（<code>type</code>）以及资源本身（<code>object</code>）。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用restclient监听资源">使用RESTClient监听资源<a href="#使用restclient监听资源" class="hash-link" aria-label="Direct link to 使用RESTClient监听资源" title="Direct link to 使用RESTClient监听资源">​</a></h3><p><code>RESTClient</code>中为我们封装了相关的方法用于对资源类型的监听。我们先来看看如何使用<code>RESTClient</code>来监听资源的一个例子：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Assume restClient is initialized.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">opts </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ListOptions</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">opts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Watch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">watcher</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> restClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Namespace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Resource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;pods&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">VersionedParams</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">opts</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scheme</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ParameterCodec</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">Watch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> event </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> watcher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ResultChan</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Event type: %v\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Pod name: %v\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Object</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>首先我们需要将<code>metav1.ListOptions</code>对象的<code>Watch</code>成员设置为<code>true</code>。<code>metav1.ListOptions</code>对象将最终会被<code>scheme.ParameterCodec</code>编码成请求URL中的<code>?watch=true</code>部分。</li><li><code>Watch()</code>方法返回的一个是<code>StreamWatcher</code>对象。<code>StreamWatcher</code>对象不断将基于返回体中的数据块解码成<code>WatchEvent</code>对象<sup id="fnref-6"><a href="#fn-6" class="footnote-ref">6</a></sup>，并写入channel中（也就是它的<code>ResultChan</code>成员）。</li><li>我们通过迭代<code>ResultChan()</code>就可以&quot;源源不断&quot;的从中获取资源的变更事件。</li></ul><p>下图展示使用<code>RESTClient</code>监听资源时的过程：</p><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 996.339 432.386" width="996.339" height="432.386" style="width:95%"><defs><style>@font-face{font-family:&quot;Virgil&quot;;src:url(https://excalidraw.com/Virgil.woff2)}@font-face{font-family:&quot;Cascadia&quot;;src:url(https://excalidraw.com/Cascadia.woff2)}</style></defs><g stroke-opacity="0.6" fill-opacity="0.6" stroke-linecap="round"><path d="M115.688 125.428h805v139.93h-805" stroke-width="0" fill="#f2ffff"></path><path d="M115.688 125.428h805m0 0v139.93m0 0h-805m0 0v-139.93" stroke="#000" stroke-width="2.5" fill="none" stroke-dasharray="1.5 8"></path></g><g stroke-linecap="round"><path d="M339.302 62.585h106.79m-106.79 0h106.79" stroke="#000" stroke-width="2" fill="none"></path><path d="m446.092 62.585-13.6 6.34v-12.68l13.6 6.34" stroke-width="0" fill-rule="evenodd"></path><path d="M446.092 62.585c-3.63 1.69-7.26 3.38-13.6 6.34m13.6-6.34c-3.19 1.49-6.38 2.97-13.6 6.34m0 0v-12.68m0 12.68v-12.68m0 0c4.85 2.26 9.71 4.53 13.6 6.34m-13.6-6.34c3.34 1.56 6.68 3.12 13.6 6.34m0 0s0 0 0 0m0 0s0 0 0 0" stroke="#000" stroke-width="2" fill="none"></path></g><text font-family="Cascadia, Segoe UI Emoji" font-size="16" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(341.347 41.814)">Namespace()</text><text font-family="Cascadia, Segoe UI Emoji" font-size="16" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(484.324 41.814)">Resource()</text><text font-family="Cascadia, Segoe UI Emoji" font-size="16" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(622.018 42.367)">Name()</text><text font-family="Cascadia, Segoe UI Emoji" font-size="16" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(920.714 83.436)">watch()</text><g stroke-linecap="round"><path d="M10.458 33.135h110v58h-110" stroke-width="0" fill="#eae6ff"></path><path d="M10.458 33.135h110m-110 0h110m0 0v58m0-58v58m0 0h-110m110 0h-110m0 0v-58m0 58v-58" stroke="#000" stroke-width="2" fill="none"></path></g><text x="46.875" font-family="Cascadia, Segoe UI Emoji" font-size="16" text-anchor="middle" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(18.583 52.535)">RESTClient</text><g stroke-linecap="round"><path d="M260.258 33.484h76v58h-76" stroke-width="0" fill="#d5e8d4"></path><path d="M260.258 33.484h76m-76 0h76m0 0v58m0-58v58m0 0h-76m76 0h-76m0 0v-58m0 58v-58" stroke="#000" stroke-width="2" fill="none"></path></g><text x="32.813" font-family="Cascadia, Segoe UI Emoji" font-size="16" text-anchor="middle" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(265.446 67.284)">Request</text><g stroke-linecap="round"><path d="M270.05 38.099h29.26v14.6h-29.26" stroke-width="0" fill="#eae6ff"></path><path d="M270.05 38.099h29.26m-29.26 0h29.26m0 0v14.6m0-14.6v14.6m0 0h-29.26m29.26 0h-29.26m0 0v-14.6m0 14.6v-14.6" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M123.502 61.054h132.99m-132.99 0h132.99" stroke="#000" stroke-width="2" fill="none"></path><path d="m256.492 61.054-13.6 6.34v-12.68l13.6 6.34" stroke-width="0" fill-rule="evenodd"></path><path d="M256.492 61.054c-4.85 2.26-9.7 4.52-13.6 6.34m13.6-6.34c-4.19 1.95-8.39 3.91-13.6 6.34m0 0v-12.68m0 12.68v-12.68m0 0c3.43 1.6 6.85 3.19 13.6 6.34m-13.6-6.34c3.95 1.84 7.91 3.69 13.6 6.34m0 0s0 0 0 0m0 0s0 0 0 0" stroke="#000" stroke-width="2" fill="none"></path></g><text font-family="Cascadia, Segoe UI Emoji" font-size="17.012" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(167.574 40.229)">Get()</text><g stroke-linecap="round"><path d="M121.458 33.835c11.79-2.71 46.14-17.34 70.77-16.25 24.62 1.1 64.15 19.01 76.98 22.82" stroke="#000" stroke-width="2.5" fill="none" stroke-dasharray="1.5 8" stroke-opacity="0.7" fill-opacity="0.7"></path><g stroke-opacity="0.7" fill-opacity="0.7"><path d="m269.208 40.405-14.94 1.32 4.33-11.92 10.61 10.6" stroke-width="0" fill-rule="evenodd"></path><path d="M269.208 40.405c-3.53.31-7.07.62-14.94 1.32m0 0c1.71-4.7 3.41-9.4 4.33-11.92m0 0c3.73 3.73 7.46 7.45 10.61 10.6m0 0s0 0 0 0" stroke="#000" stroke-width="2.5" fill="none"></path></g></g><g stroke-linecap="round"><path d="M448.716 47.367h33.03v30.48h-33.03" stroke-width="0" fill="#d5e8d4"></path><path d="M448.716 47.367h33.03m-33.03 0h33.03m0 0v30.48m0-30.48v30.48m0 0h-33.03m33.03 0h-33.03m0 0v-30.48m0 30.48v-30.48" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M584.058 47.244h33.03v30.48h-33.03" stroke-width="0" fill="#d5e8d4"></path><path d="M584.058 47.244h33.03m-33.03 0h33.03m0 0v30.48m0-30.48v30.48m0 0h-33.03m33.03 0h-33.03m0 0v-30.48m0 30.48v-30.48" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M483.22 62.384h100.01m-100.01 0h100.01" stroke="#000" stroke-width="2" fill="none"></path><path d="m583.23 62.384-13.6 6.34v-12.68l13.6 6.34" stroke-width="0" fill-rule="evenodd"></path><path d="M583.23 62.384c-4.54 2.11-9.07 4.23-13.6 6.34m13.6-6.34c-2.91 1.36-5.83 2.72-13.6 6.34m0 0v-12.68m0 12.68v-12.68m0 0c2.97 1.38 5.93 2.76 13.6 6.34m-13.6-6.34c3 1.4 6 2.8 13.6 6.34m0 0s0 0 0 0m0 0s0 0 0 0" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M694.796 47.244h33.03v30.48h-33.03" stroke-width="0" fill="#d5e8d4"></path><path d="M694.796 47.244h33.03m-33.03 0h33.03m0 0v30.48m0-30.48v30.48m0 0h-33.03m33.03 0h-33.03m0 0v-30.48m0 30.48v-30.48" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M619.442 63.884h73.78m-73.78 0h73.78" stroke="#000" stroke-width="2" fill="none"></path><path d="m693.222 63.884-13.6 6.34v-12.68l13.6 6.34" stroke-width="0" fill-rule="evenodd"></path><path d="M693.222 63.884c-5.02 2.34-10.03 4.68-13.6 6.34m13.6-6.34c-5.41 2.52-10.81 5.04-13.6 6.34m0 0v-12.68m0 12.68v-12.68m0 0c5.4 2.52 10.79 5.03 13.6 6.34m-13.6-6.34c2.91 1.35 5.81 2.71 13.6 6.34m0 0s0 0 0 0m0 0s0 0 0 0" stroke="#000" stroke-width="2" fill="none"></path></g><text font-family="Cascadia, Segoe UI Emoji" font-size="16" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(117.438 170.189)" stroke-opacity="0.6" fill-opacity="0.6">GET /apis/{group}/{version}/namespaces/{namespace}/{resourcetype}/{name}?{watch=true}</text><text font-family="Cascadia, Segoe UI Emoji" font-size="16" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(733.7 44.684)">VersionedParams()</text><g stroke-linecap="round"><path d="M896.755 47.244h33.03v30.48h-33.03" stroke-width="0" fill="#d5e8d4"></path><path d="M896.755 47.244h33.03m-33.03 0h33.03m0 0v30.48m0-30.48v30.48m0 0h-33.03m33.03 0h-33.03m0 0v-30.48m0 30.48v-30.48" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M730.054 64.46c47.66-.16 95.32-.31 166.23-.54m-166.23.54c49.78-.16 99.57-.33 166.23-.54" stroke="#000" stroke-width="2" fill="none"></path><path d="m896.284 63.92-13.58 6.38-.04-12.68 13.62 6.3" stroke-width="0" fill-rule="evenodd"></path><path d="M896.284 63.92c-3.9 1.83-7.79 3.66-13.58 6.38m13.58-6.38c-4.07 1.91-8.13 3.82-13.58 6.38m0 0c-.01-3.55-.02-7.1-.04-12.68m.04 12.68c-.01-3.65-.02-7.3-.04-12.68m0 0c4.71 2.18 9.42 4.36 13.62 6.3m-13.62-6.3 13.62 6.3m0 0s0 0 0 0m0 0s0 0 0 0" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M836.355 68.679c.67 25.32 1.33 50.63 2.68 101.62" stroke="#000" stroke-width="2.5" fill="none" stroke-dasharray="1.5 8" stroke-opacity="0.6" fill-opacity="0.6"></path><g stroke-opacity="0.6" fill-opacity="0.6"><path d="m839.035 170.299-6.7-13.42 12.67-.34-5.97 13.76" stroke-width="0" fill-rule="evenodd"></path><path d="M839.035 170.299c-1.67-3.34-3.34-6.69-6.7-13.42m0 0c4.79-.13 9.59-.25 12.67-.34m0 0c-1.3 3-2.6 6-5.97 13.76m0 0s0 0 0 0" stroke="#000" stroke-width="2.5" fill="none"></path></g></g><g stroke-linecap="round"><path d="M289.325 45.472v98.29" stroke="#000" stroke-width="2.5" fill="none" stroke-dasharray="1.5 8" stroke-opacity="0.6" fill-opacity="0.6"></path><g stroke-opacity="0.6" fill-opacity="0.6"><path d="m289.325 143.762-6.34-13.59h12.68l-6.34 13.59" stroke-width="0" fill-rule="evenodd"></path><path d="M289.325 143.762c-2.46-5.27-4.92-10.54-6.34-13.59m0 0h12.68m0 0c-1.88 4.03-3.76 8.07-6.34 13.59m0 0s0 0 0 0" stroke="#000" stroke-width="2.5" fill="none"></path></g></g><text font-family="Cascadia, Segoe UI Emoji" font-size="36" style="white-space:pre" dominant-baseline="text-before-edge" transform="rotate(91.035 84.732 226.08)" stroke-opacity="0.4" fill-opacity="0.4">{</text><text font-family="Cascadia, Segoe UI Emoji" font-size="16" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(223.202 98.54)" stroke-opacity="0.7" fill-opacity="0.7">versionedAPIPath</text><g stroke-linecap="round"><path d="M402.266 68.354c9.69 5.35 38.55 15.03 58.16 32.09 19.61 17.07 49.57 58.59 59.48 70.31" stroke="#000" stroke-width="2.5" fill="none" stroke-dasharray="1.5 8" stroke-opacity="0.6" fill-opacity="0.6"></path><g stroke-opacity="0.6" fill-opacity="0.6"><path d="m519.906 170.754-13.39-6.74 9.95-7.86 3.44 14.6" stroke-width="0" fill-rule="evenodd"></path><path d="M519.906 170.754c-3.37-1.7-6.75-3.4-13.39-6.74m0 0c2.89-2.29 5.78-4.57 9.95-7.86m0 0c.69 2.93 1.38 5.85 3.44 14.6m0 0s0 0 0 0" stroke="#000" stroke-width="2.5" fill="none"></path></g></g><g stroke-linecap="round"><path d="M529.133 67.626c9.69 5.35 39.88 15.17 58.16 32.09 18.28 16.93 42.94 57.89 51.53 69.47" stroke="#000" stroke-width="2.5" fill="none" stroke-dasharray="1.5 8" stroke-opacity="0.6" fill-opacity="0.6"></path><g stroke-opacity="0.6" fill-opacity="0.6"><path d="m638.823 169.186-12.87-7.69 10.49-7.12 2.38 14.81" stroke-width="0" fill-rule="evenodd"></path><path d="M638.823 169.186c-3.17-1.89-6.34-3.79-12.87-7.69m0 0c3.43-2.33 6.86-4.65 10.49-7.12m0 0c.73 4.51 1.45 9.02 2.38 14.81m0 0s0 0 0 0" stroke="#000" stroke-width="2.5" fill="none"></path></g></g><g stroke-linecap="round"><path d="M648.767 68.494c9.69 5.35 40.97 15.35 58.16 32.09 17.19 16.75 37.47 56.97 44.96 68.36" stroke="#000" stroke-width="2.5" fill="none" stroke-dasharray="1.5 8" stroke-opacity="0.6" fill-opacity="0.6"></path><g stroke-opacity="0.6" fill-opacity="0.6"><path d="m751.887 168.944-12.35-8.51 10.93-6.42 1.42 14.93" stroke-width="0" fill-rule="evenodd"></path><path d="M751.887 168.944c-4.18-2.87-8.35-5.75-12.35-8.51m0 0c4.07-2.39 8.14-4.78 10.93-6.42m0 0c.29 3.03.57 6.06 1.42 14.93m0 0s0 0 0 0" stroke="#000" stroke-width="2.5" fill="none"></path></g></g><g stroke-linecap="round"><path d="M914.97 80.223v118.82m0-118.82v118.82m0 0H109.74m805.23 0H109.74" stroke="#000" stroke-width="2" fill="none"></path><path d="m109.74 199.043 13.6-6.33v12.67l-13.6-6.34" stroke-width="0" fill-rule="evenodd"></path><path d="M109.74 199.043c3.19-1.48 6.38-2.97 13.6-6.33m-13.6 6.33c5.36-2.49 10.71-4.99 13.6-6.33m0 0v12.67m0-12.67v12.67m0 0c-4.35-2.03-8.71-4.05-13.6-6.34m13.6 6.34c-5.4-2.51-10.8-5.03-13.6-6.34m0 0s0 0 0 0m0 0s0 0 0 0" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M725.437 205.855h167v53h-167" stroke-width="0" fill="#f9f7ed"></path><path d="M725.437 205.855h167m-167 0h167m0 0v53m0-53v53m0 0h-167m167 0h-167m0 0v-53m0 53v-53" stroke="#000" stroke-width="2" fill="none"></path></g><text font-family="Cascadia, Segoe UI Emoji" font-size="16" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(730.437 234.655)">StreamWatcher</text><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M10 178.522h96v68H10" stroke-width="0" fill="#6b8eed"></path><path d="M10 178.522h96m-96 0h96m0 0v68m0-68v68m0 0H10m96 0H10m0 0v-68m0 68v-68" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-opacity="0.8" fill-opacity="0.8"><text x="42.188" font-family="Cascadia, Segoe UI Emoji" font-size="16" text-anchor="middle" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(15.813 193.322)">kube-</text><text x="42.188" y="19.2" font-family="Cascadia, Segoe UI Emoji" font-size="16" text-anchor="middle" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(15.813 193.322)">apiserver</text></g><text font-family="Cascadia, Segoe UI Emoji" font-size="16" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(859.187 10)" stroke-opacity="0.7" fill-opacity="0.7">watch</text><g stroke-linecap="round"><path d="M111.13 220.682h803.23m-803.23 0h803.23" stroke="#000" stroke-width="2" fill="none"></path><path d="m914.36 220.682-13.59 6.34v-12.68l13.59 6.34" stroke-width="0" fill-rule="evenodd"></path><path d="M914.36 220.682c-4.31 2.01-8.61 4.02-13.59 6.34m13.59-6.34c-4.48 2.09-8.97 4.18-13.59 6.34m0 0v-12.68m0 12.68v-12.68m0 0c4.79 2.23 9.58 4.47 13.59 6.34m-13.59-6.34c5.31 2.48 10.62 4.96 13.59 6.34m0 0s0 0 0 0m0 0s0 0 0 0" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M882.233 29.292v18.87m0-18.87v18.87" stroke="#000" stroke-width="2" fill="none" stroke-opacity="0.6" fill-opacity="0.6"></path><g stroke-opacity="0.6" fill-opacity="0.6"><path d="m882.233 48.162-3.99-8.55h7.98l-3.99 8.55" stroke-width="0" fill-rule="evenodd"></path><path d="M882.233 48.162c-1-2.14-1.99-4.27-3.99-8.55m3.99 8.55c-.94-2.02-1.88-4.04-3.99-8.55m0 0h7.98m-7.98 0h7.98m0 0c-1.01 2.16-2.01 4.32-3.99 8.55m3.99-8.55c-1.57 3.35-3.13 6.71-3.99 8.55m0 0s0 0 0 0m0 0s0 0 0 0" stroke="#000" stroke-width="2" fill="none"></path></g></g><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M735.421 211.482h19.66v18.42h-19.66" stroke-width="0" fill="#12b886"></path><path d="M735.421 211.482h19.66m-19.66 0h19.66m0 0v18.42m0-18.42v18.42m0 0h-19.66m19.66 0h-19.66m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M765.054 211.482h19.66v18.42h-19.66" stroke-width="0" fill="#12b886"></path><path d="M765.054 211.482h19.66m-19.66 0h19.66m0 0v18.42m0-18.42v18.42m0 0h-19.66m19.66 0h-19.66m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M792.822 211.482h19.66v18.42h-19.66" stroke-width="0" fill="#12b886"></path><path d="M792.822 211.482h19.66m-19.66 0h19.66m0 0v18.42m0-18.42v18.42m0 0h-19.66m19.66 0h-19.66m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M819.652 211.62h19.66v18.42h-19.66" stroke-width="0" fill="#12b886"></path><path d="M819.652 211.62h19.66m-19.66 0h19.66m0 0v18.42m0-18.42v18.42m0 0h-19.66m19.66 0h-19.66m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M848.416 211.482h19.66v18.42h-19.66" stroke-width="0" fill="#12b886"></path><path d="M848.416 211.482h19.66m-19.66 0h19.66m0 0v18.42m0-18.42v18.42m0 0h-19.66m19.66 0h-19.66m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M812.145 260.978c-.02 9.75-.03 19.49-.07 40.9m.07-40.9c-.02 11.19-.04 22.38-.07 40.9" stroke="#000" stroke-width="2" fill="none"></path><path d="m812.075 301.878-6.31-13.6 12.68.02-6.37 13.58" stroke-width="0" fill-rule="evenodd"></path><path d="M812.075 301.878c-1.5-3.24-3.01-6.48-6.31-13.6m6.31 13.6c-1.72-3.72-3.45-7.44-6.31-13.6m0 0c2.81 0 5.62.01 12.68.02m-12.68-.02c3.52 0 7.05.01 12.68.02m0 0c-2.01 4.29-4.02 8.58-6.37 13.58m6.37-13.58c-2.33 4.97-4.66 9.95-6.37 13.58m0 0s0 0 0 0m0 0s0 0 0 0" stroke="#000" stroke-width="2" fill="none"></path></g><text font-family="Cascadia, Segoe UI Emoji" font-size="48.689" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(655.49 176.338)">...</text><g stroke-linecap="round"><path d="M453.915 52.44h11.42v11.28h-11.42" stroke-width="0" fill="#eae6ff"></path><path d="M453.915 52.44h11.42m-11.42 0h11.42m0 0v11.28m0-11.28v11.28m0 0h-11.42m11.42 0h-11.42m0 0V52.44m0 11.28V52.44" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M589.335 52.373h11.42v11.28h-11.42" stroke-width="0" fill="#eae6ff"></path><path d="M589.335 52.373h11.42m-11.42 0h11.42m0 0v11.28m0-11.28v11.28m0 0h-11.42m11.42 0h-11.42m0 0v-11.28m0 11.28v-11.28" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M700.053 51.924h11.42v11.28h-11.42" stroke-width="0" fill="#eae6ff"></path><path d="M700.053 51.924h11.42m-11.42 0h11.42m0 0v11.28m0-11.28v11.28m0 0h-11.42m11.42 0h-11.42m0 0v-11.28m0 11.28v-11.28" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M902.73 51.583h11.42v11.28h-11.42" stroke-width="0" fill="#eae6ff"></path><path d="M902.73 51.583h11.42m-11.42 0h11.42m0 0v11.28m0-11.28v11.28m0 0h-11.42m11.42 0h-11.42m0 0v-11.28m0 11.28v-11.28" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M23.54 403.847H43.2v18.42H23.54" stroke-width="0" fill="#0a11d3"></path><path d="M23.54 403.847H43.2m-19.66 0H43.2m0 0v18.42m0-18.42v18.42m0 0H23.54m19.66 0H23.54m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M23.65 316.72h19.78v30H23.65" stroke-width="0" fill="#d5e8d4"></path><path d="M23.65 316.72h19.78m-19.78 0h19.78m0 0v30m0-30v30m0 0H23.65m19.78 0H23.65m0 0v-30m0 30v-30" stroke="#000" stroke-width="2" fill="none"></path></g><text x="32.813" font-family="Cascadia, Segoe UI Emoji" font-size="16" text-anchor="middle" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(56.082 315.655)" stroke-opacity="0.8" fill-opacity="0.8">Request</text><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M23.648 345.716h19.66v18.42h-19.66" stroke-width="0" fill="#eae6ff"></path><path d="M23.648 345.716h19.66m-19.66 0h19.66m0 0v18.42m0-18.42v18.42m0 0h-19.66m19.66 0h-19.66m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><text x="46.875" font-family="Cascadia, Segoe UI Emoji" font-size="16" text-anchor="middle" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(56.082 345.333)" stroke-opacity="0.8" fill-opacity="0.8">RESTClient</text><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M23.734 375.495h19.66v18.42h-19.66" stroke-width="0" fill="#12b886"></path><path d="M23.734 375.495h19.66m-19.66 0h19.66m0 0v18.42m0-18.42v18.42m0 0h-19.66m19.66 0h-19.66m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><text x="60.938" font-family="Cascadia, Segoe UI Emoji" font-size="16" text-anchor="middle" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(56.082 374.313)" stroke-opacity="0.8" fill-opacity="0.8">response body</text><text x="46.875" font-family="Cascadia, Segoe UI Emoji" font-size="16" text-anchor="middle" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(55.102 403.186)" stroke-opacity="0.8" fill-opacity="0.8">serializer</text><text font-family="Cascadia, Segoe UI Emoji" font-size="20" style="white-space:pre" dominant-baseline="text-before-edge" transform="rotate(.025 -615450.49 266880.844)" stroke-opacity="0.6" fill-opacity="0.6">©Xudong Wang🤖️🎈</text></svg><p>下图展示了<code>StreamWatcher</code>将HTTP返回的数据块转化为事件类型发送到channel的过程：</p><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 511.565 370.69" width="511.565" height="370.69" style="height:320px"><defs><style>@font-face{font-family:&quot;Virgil&quot;;src:url(https://excalidraw.com/Virgil.woff2)}@font-face{font-family:&quot;Cascadia&quot;;src:url(https://excalidraw.com/Cascadia.woff2)}</style></defs><g stroke-linecap="round"><path d="M45.23 58.165h316.05v269.79H45.23" stroke-width="0" fill="#f9f7ed"></path><path d="M45.23 58.165h316.05m-316.05 0h316.05m0 0v269.79m0-269.79v269.79m0 0H45.23m316.05 0H45.23m0 0V58.165m0 269.79V58.165" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-linecap="round"><path d="M12.245 46.44h489.32" stroke="#000" stroke-width="2.5" fill="none" stroke-dasharray="1.5 8" stroke-opacity="0.6" fill-opacity="0.6"></path><g stroke-opacity="0.6" fill-opacity="0.6"><path d="m501.565 46.44-13.6 6.34V40.1l13.6 6.34" stroke-width="0" fill-rule="evenodd"></path><path d="M501.565 46.44c-3.5 1.63-7 3.27-13.6 6.34m0 0V40.1m0 0c3.33 1.55 6.67 3.11 13.6 6.34m0 0s0 0 0 0" stroke="#000" stroke-width="2.5" fill="none"></path></g></g><g stroke-linecap="round"><path d="M499.711 73.955H10.001" stroke="#000" stroke-width="2.5" fill="none" stroke-dasharray="1.5 8" stroke-opacity="0.6" fill-opacity="0.6"></path><g stroke-opacity="0.6" fill-opacity="0.6"><path d="m10.001 73.955 13.59-6.34v12.68l-13.59-6.34" stroke-width="0" fill-rule="evenodd"></path><path d="M10.001 73.955c5.3-2.47 10.6-4.94 13.59-6.34m0 0v12.68m0 0c-4.65-2.17-9.31-4.34-13.59-6.34m0 0s0 0 0 0" stroke="#000" stroke-width="2.5" fill="none"></path></g></g><text font-family="Cascadia, Segoe UI Emoji" font-size="48.689" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(289.031 30.386)">...</text><g stroke-linecap="round"><path d="M203.232 93.683c-.02 13.61-.05 27.22-.07 42.22m.07-42.22c-.02 8.55-.03 17.09-.07 42.22" stroke="#000" stroke-width="2" fill="none"></path><path d="m203.162 135.903-6.32-13.6 12.68.02-6.36 13.58" stroke-width="0" fill-rule="evenodd"></path><path d="M203.162 135.903c-2.04-4.38-4.08-8.77-6.32-13.6m6.32 13.6c-1.28-2.75-2.56-5.5-6.32-13.6m0 0c2.76 0 5.51.01 12.68.02m-12.68-.02c3.38.01 6.76.01 12.68.02m0 0c-1.3 2.77-2.59 5.54-6.36 13.58m6.36-13.58c-1.49 3.18-2.98 6.36-6.36 13.58m0 0s0 0 0 0m0 0s0 0 0 0" stroke="#000" stroke-width="2" fill="none"></path></g><text font-family="Cascadia, Segoe UI Emoji" font-size="20" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(215.967 99.438)">decode</text><g stroke-linecap="round"><path d="M107.704 142.41h191v72h-191" stroke-width="0" fill="#f2ffff"></path><path d="M107.704 142.41h191m-191 0h191m0 0v72m0-72v72m0 0h-191m191 0h-191m0 0v-72m0 72v-72" stroke="#000" stroke-width="2" fill="none"></path></g><text font-family="Cascadia, Segoe UI Emoji" font-size="16" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(112.704 147.41)">type Event struct {</text><text y="19.2" font-family="Cascadia, Segoe UI Emoji" font-size="16" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(112.704 147.41)">  // ...</text><text y="38.4" font-family="Cascadia, Segoe UI Emoji" font-size="16" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(112.704 147.41)">}</text><g stroke-opacity="0.8" fill-opacity="0.8" fill-rule="evenodd" stroke-linecap="round"><path d="m218.29 326.026-.604-64.967-1.396-2.707-4.683-2.374-7.888-.683-7.517 1.284-3.972 2.918-.536 2.436-.086-.57.673 65.797.163-.651 1.708 2.843 3.536 1.626 8.043 1.311 6.432-.893 5.032-2.869 1.096-2.5" stroke-width="0" fill="#40c057"></path><path d="M218.29 326.026c-.104-9.7-.552-47.397-.657-58.196-.106-10.8.25-5.043.025-6.63-.226-1.579-.36-1.977-1.368-2.848-1.009-.87-2.588-1.864-4.683-2.374-2.096-.51-5.318-.778-7.888-.683-2.569.105-5.604.585-7.517 1.284-1.914.698-3.22 2.021-3.972 2.918-.751.888-.439 1.135-.536 2.436-.098 1.29-.125-4.58-.028 5.33.096 9.91.462 44.258.588 54.137.137 9.87-.123 3.782.19 5.109s.83 2.102 1.708 2.843c.867.742 1.601 1.134 3.536 1.626 1.935.48 5.632 1.245 8.043 1.311 2.411.067 4.518-.264 6.432-.893 1.914-.628 4.01-1.979 5.032-2.869 1.031-.89.93-2.05 1.106-2.47.186-.413-.01-.02-.01-.03m0 0c-.105-9.7-.553-47.398-.658-58.197-.106-10.8.25-5.043.025-6.63-.226-1.579-.36-1.977-1.368-2.848-1.009-.87-2.588-1.864-4.683-2.374-2.096-.51-5.318-.778-7.888-.683-2.569.105-5.604.585-7.517 1.284-1.914.698-3.22 2.021-3.972 2.918-.751.888-.439 1.135-.536 2.436-.098 1.29-.125-4.58-.028 5.33.096 9.91.462 44.258.588 54.137.137 9.87-.123 3.782.19 5.109s.83 2.102 1.708 2.843c.867.742 1.601 1.134 3.536 1.626 1.935.48 5.632 1.245 8.043 1.311 2.411.067 4.518-.264 6.432-.893 1.914-.628 4.01-1.979 5.032-2.869 1.031-.89.93-2.05 1.106-2.47.186-.413-.01-.02-.01-.03" stroke="#087f5b" stroke-width="2" fill="none"></path></g><path d="M217.54 284.015c-.115-.419-.097-1.749-.695-2.513-.597-.764-1.765-1.533-2.89-2.092-1.116-.55-2.19-1.029-3.833-1.243-1.632-.214-3.822-.192-5.98-.061-2.16.14-5.139.24-6.982.888-1.834.648-3.23 2.082-4.041 3.01-.821.928-.7 2.126-.845 2.548m25.266-.537c-.115-.419-.097-1.749-.695-2.513-.597-.764-1.765-1.533-2.89-2.092-1.116-.55-2.19-1.029-3.833-1.243-1.632-.214-3.822-.192-5.98-.061-2.16.14-5.139.24-6.982.888-1.834.648-3.23 2.082-4.041 3.01-.821.928-.7 2.126-.845 2.548M218.127 306.028c-.113-.339-.094-1.399-.68-2.013-.596-.614-1.762-1.223-2.886-1.672-1.115-.44-2.188-.819-3.82-.983-1.632-.174-3.812-.153-5.96-.042-2.16.121-5.129.2-6.964.728-1.835.518-3.224 1.672-4.037 2.41-.822.748-.703 1.707-.85 2.048m25.197-.476c-.113-.339-.094-1.399-.68-2.013-.596-.614-1.762-1.223-2.886-1.672-1.115-.44-2.188-.819-3.82-.983-1.632-.174-3.812-.153-5.96-.042-2.16.121-5.129.2-6.964.728-1.835.518-3.224 1.672-4.037 2.41-.822.748-.703 1.707-.85 2.048" stroke="#087f5b" stroke-width="2" fill="none" stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"></path><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M192.53 327.34c-.003-.33.063-.661.19-.983.127-.331.314-.653.56-.965.258-.313.565-.616.932-.91a9.707 9.707 0 0 1 1.272-.822c.478-.254 1.005-.5 1.573-.715a19.529 19.529 0 0 1 1.815-.588 27.619 27.619 0 0 1 2.015-.44 28.774 28.774 0 0 1 4.367-.382 29.679 29.679 0 0 1 4.373.297c.691.113 1.372.247 2.014.4.642.164 1.263.348 1.835.552.562.205 1.105.44 1.577.685a9.09 9.09 0 0 1 1.288.798c.373.286.696.583.949.89.253.308.456.626.59.955.122.318.195.648.199.978.003.33-.064.66-.18.992a3.852 3.852 0 0 1-.571.955 5.406 5.406 0 0 1-.931.91 8.265 8.265 0 0 1-1.273.822c-.467.254-1.005.5-1.563.715-.568.216-1.186.412-1.824.588a23.76 23.76 0 0 1-2.006.44c-.699.116-1.428.213-2.157.27a27.274 27.274 0 0 1-4.43.043 24.327 24.327 0 0 1-2.152-.228 23.202 23.202 0 0 1-2.024-.4 19.529 19.529 0 0 1-1.826-.553 13.634 13.634 0 0 1-1.587-.684 8.771 8.771 0 0 1-1.287-.798 5.788 5.788 0 0 1-.95-.89 3.802 3.802 0 0 1-.578-.945c-.134-.329-.168-.818-.21-.988-.032-.16-.028.17 0 0" stroke-width="0" fill="#fff"></path><path d="M192.53 327.34c-.003-.33.063-.661.19-.983.127-.331.314-.653.56-.965.258-.313.565-.616.932-.91a9.707 9.707 0 0 1 1.272-.822c.478-.254 1.005-.5 1.573-.715a19.529 19.529 0 0 1 1.815-.588 27.619 27.619 0 0 1 2.015-.44 28.774 28.774 0 0 1 4.367-.382 29.679 29.679 0 0 1 4.373.297c.691.113 1.372.247 2.014.4.642.164 1.263.348 1.835.552.562.205 1.105.44 1.577.685a9.09 9.09 0 0 1 1.288.798c.373.286.696.583.949.89.253.308.456.626.59.955.122.318.195.648.199.978.003.33-.064.66-.18.992a3.852 3.852 0 0 1-.571.955 5.406 5.406 0 0 1-.931.91 8.265 8.265 0 0 1-1.273.822c-.467.254-1.005.5-1.563.715-.568.216-1.186.412-1.824.588a23.76 23.76 0 0 1-2.006.44c-.699.116-1.428.213-2.157.27a27.274 27.274 0 0 1-4.43.043 24.327 24.327 0 0 1-2.152-.228 23.202 23.202 0 0 1-2.024-.4 19.529 19.529 0 0 1-1.826-.553 13.634 13.634 0 0 1-1.587-.684 8.771 8.771 0 0 1-1.287-.798 5.788 5.788 0 0 1-.95-.89 3.802 3.802 0 0 1-.578-.945c-.134-.329-.168-.818-.21-.988-.032-.16-.028.17 0 0" stroke="#087f5b" stroke-width="2" fill="none"></path></g><text font-family="Cascadia, Segoe UI Emoji" font-size="20" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(226.88 271.246)">channel</text><g stroke-linecap="round"><path d="M204.94 215.41c.05 14.14.1 28.27.13 35.91m-.13-35.91c.03 8.06.06 16.12.13 35.91" stroke="#000" stroke-width="2" fill="none"></path><path d="m205.07 251.32-6.39-13.57 12.68-.04-6.29 13.61" stroke-width="0" fill-rule="evenodd"></path><path d="M205.07 251.32c-2.52-5.34-5.03-10.68-6.39-13.57m6.39 13.57c-1.44-3.04-2.87-6.09-6.39-13.57m0 0c4.07-.01 8.14-.03 12.68-.04m-12.68.04c4.99-.02 9.99-.03 12.68-.04m0 0-6.29 13.61m6.29-13.61c-2.03 4.38-4.05 8.76-6.29 13.61m0 0s0 0 0 0m0 0s0 0 0 0" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M109.733 65.557h19.66v18.42h-19.66" stroke-width="0" fill="#12b886"></path><path d="M109.733 65.557h19.66m-19.66 0h19.66m0 0v18.42m0-18.42v18.42m0 0h-19.66m19.66 0h-19.66m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M137.502 65.557h19.66v18.42h-19.66" stroke-width="0" fill="#12b886"></path><path d="M137.502 65.557h19.66m-19.66 0h19.66m0 0v18.42m0-18.42v18.42m0 0h-19.66m19.66 0h-19.66m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M164.331 65.557h19.66v18.42h-19.66" stroke-width="0" fill="#12b886"></path><path d="M164.331 65.557h19.66m-19.66 0h19.66m0 0v18.42m0-18.42v18.42m0 0h-19.66m19.66 0h-19.66m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M193.964 65.557h19.66v18.42h-19.66" stroke-width="0" fill="#12b886"></path><path d="M193.964 65.557h19.66m-19.66 0h19.66m0 0v18.42m0-18.42v18.42m0 0h-19.66m19.66 0h-19.66m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M221.732 65.557h19.66v18.42h-19.66" stroke-width="0" fill="#12b886"></path><path d="M221.732 65.557h19.66m-19.66 0h19.66m0 0v18.42m0-18.42v18.42m0 0h-19.66m19.66 0h-19.66m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M248.562 65.695h19.66v18.42h-19.66" stroke-width="0" fill="#12b886"></path><path d="M248.562 65.695h19.66m-19.66 0h19.66m0 0v18.42m0-18.42v18.42m0 0h-19.66m19.66 0h-19.66m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><g stroke-opacity="0.8" fill-opacity="0.8" stroke-linecap="round"><path d="M277.326 65.695h19.66v18.42h-19.66" stroke-width="0" fill="#12b886"></path><path d="M277.326 65.695h19.66m-19.66 0h19.66m0 0v18.42m0-18.42v18.42m0 0h-19.66m19.66 0h-19.66m0 0v-18.42m0 18.42v-18.42" stroke="#000" stroke-width="2" fill="none"></path></g><text font-family="Cascadia, Segoe UI Emoji" font-size="16" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(47.546 304.787)" stroke-opacity="0.8" fill-opacity="0.8">StreamWatcher</text><text font-family="Cascadia, Segoe UI Emoji" font-size="20" style="white-space:pre" dominant-baseline="text-before-edge" transform="rotate(.025 -756645.119 103542.561)" stroke-opacity="0.6" fill-opacity="0.6">©Xudong Wang🤖️🎈</text><text font-family="Cascadia, Segoe UI Emoji" font-size="20" fill="#1e1e1e" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(175.187 10)">request</text><text font-family="Cascadia, Segoe UI Emoji" font-size="20" fill="#1e1e1e" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(381.548 80.462)">response</text><text font-family="Cascadia, Segoe UI Emoji" font-size="16" fill="#099268" style="white-space:pre" dominant-baseline="text-before-edge" transform="translate(71.45 109.134)">data chunk</text><g stroke-linecap="round"><path d="M120.922 90.141c.04 3.37.19 16.85.23 20.22m-.23-20.22c.04 3.37.19 16.85.23 20.22" stroke="#099268" stroke-width="2" fill="none"></path><path d="m120.922 90.141 4.38 9.11-8.55.1 4.17-9.21" stroke-width="0" fill="#099268" fill-rule="evenodd"></path><path d="M120.922 90.141c1.57 3.27 3.14 6.54 4.38 9.11m-4.38-9.11c1.42 2.95 2.84 5.91 4.38 9.11m0 0c-1.97.03-3.94.05-8.55.1m8.55-.1c-1.97.03-3.94.05-8.55.1m0 0c1.45-3.21 2.91-6.42 4.17-9.21m-4.17 9.21c1.65-3.63 3.29-7.27 4.17-9.21m0 0s0 0 0 0m0 0s0 0 0 0" stroke="#099268" stroke-width="2" fill="none"></path></g></svg><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>注</div><div class="admonitionContent_S0QG"><p>至此，我们已经学会使用<code>RESTClient</code>监听资源的变更。<a href="/crd-controller-from-scratch/docs/intro#%E7%BA%A6%E5%AE%9A">🎈</a></p></div></div><p>通过监听资源的变更事件，我们可以将上述控制器基础版伪代码优化为：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> event </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> eventChannel </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  desired </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getDesiredState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  current </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getCurrentState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">makeChanges</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">desired</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们再稍稍补上一点细节：根据控制器的定义，<em>控制器</em>本身要有检索某种（或者多种<sup id="fnref-7"><a href="#fn-7" class="footnote-ref">7</a></sup>）资源类型的期望状态与实际状态的能力。
一种简单直接的方式是通过Kubernetes API来获取此刻的资源的集合：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> event </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> eventChannel </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resources </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getResourceListFromK8sAPI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> resource </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> resources </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function" style="color:#d73a49">makeChanges</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">desired</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然而这其实并不是一种好的办法。
一方面，通过Kubernetes API检索资源集合本身并不高效<sup id="fnref-8"><a href="#fn-8" class="footnote-ref">8</a></sup>。另一方面，在控制器中，<em>协调</em>是控制器中需要频繁发生的动作。</p><p>那么在控制器中，我们该如何高效地获取资源集合呢？
我们不妨换一种思路，Kubernetes API的watch机制不仅仅可以让我们有监听资源变更的能力，我们理论上是也可以<strong>利用watch机制本身在本地维护一套资源当前的最新副本</strong>——资源最新的状态其实等同于该资源最新的事件。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="从watch机制到informer">从watch机制到Informer<a href="#从watch机制到informer" class="hash-link" aria-label="Direct link to 从watch机制到Informer" title="Direct link to 从watch机制到Informer">​</a></h3><p>幸运的是在<code>client-go</code>中，官方开发者已经为我们实现了<strong>基于watch机制的本地资源缓存机制</strong>——<code>Informer</code>组件。它设计的初衷旨在让开发者尽量避免直接通过Kubernetes API检索资源集合从而达到减轻Kubernetes服务端压力。
当然，它也完美契合了我们对于控制器的需求：</p><ol><li>资源变更事件的通知——以优化协调动作的触发时机。</li><li>Kubernetes资源的本地缓存——让我们拥有一个高效检索Kubernetes资源集合的方式。</li></ol><div class="footnotes"><hr><ol><li id="fn-2"><p>这个定义其实是整合了官方文档中两个对控制器的描述：</p><ul><li><p><a href="https://kubernetes.io/docs/concepts/architecture/controller/" target="_blank" rel="noopener noreferrer">Controllers <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 15"><path style="stroke:none;fill-rule:nonzero;fill:#326ce5;fill-opacity:1" d="M7.945 0c-.14.008-.28.043-.41.102L1.973 2.668c-.29.137-.5.39-.575.691L.028 9.13a.976.976 0 0 0 .202.86l3.852 4.624c.203.242.508.387.832.387l6.172-.004c.324 0 .633-.14.832-.383l3.852-4.625a.987.987 0 0 0 .203-.863l-1.375-5.766a1.01 1.01 0 0 0-.575-.691L8.461.102C8.3.027 8.12-.008 7.945 0Zm0 0"></path><path style="stroke:none;fill-rule:nonzero;fill:#fff;fill-opacity:1" d="M8 1.965c-.184 0-.332.16-.332.355v.012c0 .023-.004.059 0 .082.004.113.027.2.043.305.031.222.055.41.039.582a.382.382 0 0 1-.11.168l-.007.136c-.2.016-.403.043-.602.09a4.299 4.299 0 0 0-2.176 1.2l-.12-.082c-.06.007-.118.023-.196-.02a3.193 3.193 0 0 1-.45-.39c-.073-.079-.128-.153-.218-.227-.02-.016-.05-.04-.074-.055a.411.411 0 0 0-.235-.086.328.328 0 0 0-.265.113c-.113.141-.074.352.082.477h.008c.02.02.047.04.066.055.098.066.184.101.277.156.2.117.364.219.497.336.05.055.058.144.066.187l.105.09a4.057 4.057 0 0 0-.68 2.903l-.136.039c-.039.046-.09.117-.144.14-.172.051-.364.07-.598.094-.11.008-.203.004-.32.023a.554.554 0 0 1-.086.02l-.004.004h-.004c-.2.047-.324.219-.281.39.039.172.23.278.43.235h.007c.031-.008.063-.012.086-.02.117-.03.2-.074.3-.109.22-.078.403-.14.583-.168.074-.004.152.047.191.066l.145-.023a4.207 4.207 0 0 0 1.918 2.316l-.059.141c.02.055.047.129.027.18-.062.164-.175.336-.3.523-.059.09-.121.156-.176.258-.016.023-.031.062-.043.086-.086.18-.024.383.14.457.165.078.372-.004.458-.18h.003c.012-.027.028-.058.04-.082.046-.105.062-.195.097-.297.086-.215.137-.437.258-.578.031-.039.086-.05.145-.066l.074-.133a4.385 4.385 0 0 0 3.07.008c.024.035.063.105.074.125.055.015.117.027.168.097.09.153.153.329.23.543.032.102.048.188.094.293l.043.082c.09.18.293.262.461.184.164-.078.227-.281.141-.457-.012-.027-.031-.063-.043-.086-.055-.102-.117-.168-.18-.258-.125-.191-.23-.347-.293-.511-.027-.083.004-.133.024-.188-.012-.016-.04-.094-.055-.129a4.21 4.21 0 0 0 1.918-2.336c.043.008.117.02.145.027.05-.035.093-.074.183-.066.18.024.364.086.582.164.102.035.184.082.301.11.023.007.059.011.086.02h.004c.004 0 .004 0 .004.003.199.039.39-.066.43-.238.042-.172-.083-.344-.282-.39-.027-.009-.066-.017-.094-.024-.117-.02-.21-.016-.32-.024a3.314 3.314 0 0 1-.598-.094c-.07-.027-.12-.105-.144-.14l-.133-.04a4.065 4.065 0 0 0-.695-2.895c.035-.026.101-.085.117-.1.008-.059.004-.118.063-.18.132-.121.296-.219.496-.34.093-.05.183-.086.277-.152.023-.016.05-.043.074-.059.16-.125.195-.336.082-.472-.117-.141-.336-.153-.496-.032-.023.02-.055.04-.074.059-.09.074-.145.148-.223.223a2.991 2.991 0 0 1-.445.394c-.066.035-.16.024-.203.02l-.13.09a4.415 4.415 0 0 0-2.76-1.294 2.321 2.321 0 0 1-.009-.14c-.043-.043-.097-.074-.109-.164-.016-.172.008-.36.04-.582.015-.106.038-.192.042-.305.004-.027 0-.066 0-.094 0-.195-.148-.355-.332-.355Zm-.418 2.492-.098 1.688-.007.003a.292.292 0 0 1-.293.274.282.282 0 0 1-.172-.055h-.004l-1.434-.98a3.459 3.459 0 0 1 1.653-.867c.12-.028.238-.047.355-.063Zm.836 0a3.52 3.52 0 0 1 1.992.93l-1.422.976-.004-.004a.302.302 0 0 1-.402-.05.3.3 0 0 1-.066-.164ZM5.055 6.02l1.308 1.128v.008a.27.27 0 0 1 .035.387.28.28 0 0 1-.152.098v.007l-1.676.465a3.214 3.214 0 0 1 .485-2.093Zm5.879 0a3.262 3.262 0 0 1 .5 2.09L9.75 7.64v-.007a.282.282 0 0 1-.21-.336.306.306 0 0 1 .093-.152ZM7.73 7.234h.536l.336.403-.122.5-.48.226-.484-.226-.118-.5ZM9.45 8.61c.023 0 .046.004.066.008l.004-.004 1.734.282a3.347 3.347 0 0 1-1.39 1.683l-.673-1.57h.004c-.062-.14 0-.301.14-.367a.289.289 0 0 1 .114-.032Zm-2.915.008c.133.004.254.09.285.223a.285.285 0 0 1-.02.172l.009.008-.668 1.554a3.372 3.372 0 0 1-1.383-1.672l1.719-.285.003.004c.02-.004.04-.004.055-.004Zm1.453.68a.28.28 0 0 1 .137.031c.059.027.105.07.133.121h.008l.847 1.477a3.586 3.586 0 0 1-2.219 0l.844-1.477h.004a.29.29 0 0 1 .246-.152Zm0 0"></path></svg></a></p><blockquote><p>In robotics and automation, a control loop is a non-terminating loop that regulates the state of a system.</p><p>In Kubernetes, controllers are control loops that watch the state of your cluster, then make or request changes where needed.
Each controller tries to move the current cluster state closer to the desired state.</p></blockquote></li><li><p><a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-api-machinery/controllers.md" target="_blank" rel="noopener noreferrer">Writing Controllers <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 15"><path style="stroke:none;fill-rule:evenodd;fill:#24292f;fill-opacity:1" d="M7.977 0C3.567 0 0 3.438 0 7.691c0 3.399 2.285 6.278 5.453 7.293.399.079.543-.164.543-.367 0-.18-.016-.789-.016-1.426-2.218.457-2.68-.918-2.68-.918-.355-.89-.882-1.12-.882-1.12-.727-.47.05-.47.05-.47.805.051 1.231.79 1.231.79.711 1.172 1.86.84 2.324.636.063-.496.278-.84.5-1.03-1.77-.18-3.632-.84-3.632-3.798 0-.84.316-1.527.82-2.062-.078-.192-.356-.98.078-2.035 0 0 .676-.204 2.191.789a7.99 7.99 0 0 1 3.989 0c1.52-.993 2.195-.79 2.195-.79.434 1.055.156 1.844.078 2.036.516.535.817 1.222.817 2.062 0 2.957-1.86 3.606-3.645 3.797.293.242.543.7.543 1.426 0 1.031-.012 1.86-.012 2.113 0 .203.145.445.54.367 3.171-1.015 5.453-3.894 5.453-7.293C15.953 3.438 12.374 0 7.976 0Zm0 0"></path></svg></a></p><blockquote><p>A Kubernetes controller is an active reconciliation process.
That is, it watches some object for the world&#x27;s desired state, and it watches the world&#x27;s actual state, too.
Then, it sends instructions to try and make the world&#x27;s current state be more like the desired state.</p></blockquote></li></ul><p><a href="#fnref-2" class="footnote-backref">↩</a></p></li><li id="fn-3"><p>Kubernetes控制器其实借用了自动化中<em><a href="https://en.wikipedia.org/wiki/Closed-loop_controller" target="_blank" rel="noopener noreferrer">closed-loop controller</a></em>这个概念。在自动化里，closed-loop controller使用反馈来控制动态系统的状态或输出。它们在本质上是相通的。<a href="#fnref-3" class="footnote-backref">↩</a></p></li><li id="fn-4"><p>在Kubernetes系统中，真正创建pod资源的动作由<code>kubelet</code>组件完成。<a href="#fnref-4" class="footnote-backref">↩</a></p></li><li id="fn-5"><p>所谓HTTP&quot;流&quot;指的是HTTP 1.1的<em>分块传输编码</em>（<a href="https://en.wikipedia.org/wiki/Chunked_transfer_encoding" target="_blank" rel="noopener noreferrer">HTTP/1.1 Chunked Transfer Coding</a>）。
<code>kube-apiserver</code>会在返回的头（header）中
设置<code>Transfer-Encoding</code>为<code>chunked</code>，表示采用分块传输编码，客户端每读完一个数据块（即资源的变更事件）后，会继续读取或等待下一个数据块，直到客户端主动终止连接或者读到长度为0的数据分块为止。
每个数据块由两部分组成，第一部分是以十六进制形式表示的分块长度，后面紧跟着 <code>\r\n</code>以告知客户端分块的大小。第二部分是分块数据本身，后面也是 <code>\r\n</code>， 终止块则是一个长度为0的分块。<a href="#fnref-5" class="footnote-backref">↩</a></p></li><li id="fn-6"><p><code>WatchEvent</code>由于是Kubernetes API返回体的解码后的Go类型，所以根据定义，它仍然是kind，并且属于kind的第三种类。<a href="#fnref-6" class="footnote-backref">↩</a></p></li><li id="fn-7"><p>对于复杂的控制器可能需要同时管理<code>pods</code>, <code>services</code>，<code>configmaps</code>等多种资源类型。<a href="#fnref-7" class="footnote-backref">↩</a></p></li><li id="fn-8"><p><a href="https://kubernetes.io/docs/reference/using-api/api-concepts" target="_blank" rel="noopener noreferrer">Kubernetes API Concepts <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 15"><path style="stroke:none;fill-rule:nonzero;fill:#326ce5;fill-opacity:1" d="M7.945 0c-.14.008-.28.043-.41.102L1.973 2.668c-.29.137-.5.39-.575.691L.028 9.13a.976.976 0 0 0 .202.86l3.852 4.624c.203.242.508.387.832.387l6.172-.004c.324 0 .633-.14.832-.383l3.852-4.625a.987.987 0 0 0 .203-.863l-1.375-5.766a1.01 1.01 0 0 0-.575-.691L8.461.102C8.3.027 8.12-.008 7.945 0Zm0 0"></path><path style="stroke:none;fill-rule:nonzero;fill:#fff;fill-opacity:1" d="M8 1.965c-.184 0-.332.16-.332.355v.012c0 .023-.004.059 0 .082.004.113.027.2.043.305.031.222.055.41.039.582a.382.382 0 0 1-.11.168l-.007.136c-.2.016-.403.043-.602.09a4.299 4.299 0 0 0-2.176 1.2l-.12-.082c-.06.007-.118.023-.196-.02a3.193 3.193 0 0 1-.45-.39c-.073-.079-.128-.153-.218-.227-.02-.016-.05-.04-.074-.055a.411.411 0 0 0-.235-.086.328.328 0 0 0-.265.113c-.113.141-.074.352.082.477h.008c.02.02.047.04.066.055.098.066.184.101.277.156.2.117.364.219.497.336.05.055.058.144.066.187l.105.09a4.057 4.057 0 0 0-.68 2.903l-.136.039c-.039.046-.09.117-.144.14-.172.051-.364.07-.598.094-.11.008-.203.004-.32.023a.554.554 0 0 1-.086.02l-.004.004h-.004c-.2.047-.324.219-.281.39.039.172.23.278.43.235h.007c.031-.008.063-.012.086-.02.117-.03.2-.074.3-.109.22-.078.403-.14.583-.168.074-.004.152.047.191.066l.145-.023a4.207 4.207 0 0 0 1.918 2.316l-.059.141c.02.055.047.129.027.18-.062.164-.175.336-.3.523-.059.09-.121.156-.176.258-.016.023-.031.062-.043.086-.086.18-.024.383.14.457.165.078.372-.004.458-.18h.003c.012-.027.028-.058.04-.082.046-.105.062-.195.097-.297.086-.215.137-.437.258-.578.031-.039.086-.05.145-.066l.074-.133a4.385 4.385 0 0 0 3.07.008c.024.035.063.105.074.125.055.015.117.027.168.097.09.153.153.329.23.543.032.102.048.188.094.293l.043.082c.09.18.293.262.461.184.164-.078.227-.281.141-.457-.012-.027-.031-.063-.043-.086-.055-.102-.117-.168-.18-.258-.125-.191-.23-.347-.293-.511-.027-.083.004-.133.024-.188-.012-.016-.04-.094-.055-.129a4.21 4.21 0 0 0 1.918-2.336c.043.008.117.02.145.027.05-.035.093-.074.183-.066.18.024.364.086.582.164.102.035.184.082.301.11.023.007.059.011.086.02h.004c.004 0 .004 0 .004.003.199.039.39-.066.43-.238.042-.172-.083-.344-.282-.39-.027-.009-.066-.017-.094-.024-.117-.02-.21-.016-.32-.024a3.314 3.314 0 0 1-.598-.094c-.07-.027-.12-.105-.144-.14l-.133-.04a4.065 4.065 0 0 0-.695-2.895c.035-.026.101-.085.117-.1.008-.059.004-.118.063-.18.132-.121.296-.219.496-.34.093-.05.183-.086.277-.152.023-.016.05-.043.074-.059.16-.125.195-.336.082-.472-.117-.141-.336-.153-.496-.032-.023.02-.055.04-.074.059-.09.074-.145.148-.223.223a2.991 2.991 0 0 1-.445.394c-.066.035-.16.024-.203.02l-.13.09a4.415 4.415 0 0 0-2.76-1.294 2.321 2.321 0 0 1-.009-.14c-.043-.043-.097-.074-.109-.164-.016-.172.008-.36.04-.582.015-.106.038-.192.042-.305.004-.027 0-.066 0-.094 0-.195-.148-.355-.332-.355Zm-.418 2.492-.098 1.688-.007.003a.292.292 0 0 1-.293.274.282.282 0 0 1-.172-.055h-.004l-1.434-.98a3.459 3.459 0 0 1 1.653-.867c.12-.028.238-.047.355-.063Zm.836 0a3.52 3.52 0 0 1 1.992.93l-1.422.976-.004-.004a.302.302 0 0 1-.402-.05.3.3 0 0 1-.066-.164ZM5.055 6.02l1.308 1.128v.008a.27.27 0 0 1 .035.387.28.28 0 0 1-.152.098v.007l-1.676.465a3.214 3.214 0 0 1 .485-2.093Zm5.879 0a3.262 3.262 0 0 1 .5 2.09L9.75 7.64v-.007a.282.282 0 0 1-.21-.336.306.306 0 0 1 .093-.152ZM7.73 7.234h.536l.336.403-.122.5-.48.226-.484-.226-.118-.5ZM9.45 8.61c.023 0 .046.004.066.008l.004-.004 1.734.282a3.347 3.347 0 0 1-1.39 1.683l-.673-1.57h.004c-.062-.14 0-.301.14-.367a.289.289 0 0 1 .114-.032Zm-2.915.008c.133.004.254.09.285.223a.285.285 0 0 1-.02.172l.009.008-.668 1.554a3.372 3.372 0 0 1-1.383-1.672l1.719-.285.003.004c.02-.004.04-.004.055-.004Zm1.453.68a.28.28 0 0 1 .137.031c.059.027.105.07.133.121h.008l.847 1.477a3.586 3.586 0 0 1-2.219 0l.844-1.477h.004a.29.29 0 0 1 .246-.152Zm0 0"></path></svg></a></p><blockquote><p><a href="https://kubernetes.io/docs/reference/using-api/api-concepts/#retrieving-large-results-sets-in-chunks" target="_blank" rel="noopener noreferrer">Retrieving large results sets in chunks</a></p><p>On large clusters, retrieving the collection of some resource types may result in very large responses that can impact the server and client.
For instance, a cluster may have tens of thousands of Pods, each of which is equivalent to roughly 2 KiB of encoded JSON. Retrieving all pods across all namespaces may result in a very large response (10-20MB) and consume a large amount of server resources.</p></blockquote><p><a href="#fnref-8" class="footnote-backref">↩</a></p></li></ol></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/crd-controller-from-scratch/docs/client-go/restclient"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">RESTClient</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/crd-controller-from-scratch/docs/client-go/informer-is-all-you-need"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">informer is all you need</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#对象的状态与协调" class="table-of-contents__link toc-highlight">对象的状态与协调</a></li><li><a href="#控制器controller" class="table-of-contents__link toc-highlight">控制器（Controller）</a></li><li><a href="#控制器与子资源status" class="table-of-contents__link toc-highlight">控制器与子资源status</a><ul><li><a href="#使用restclient更新kubernetes对象状态" class="table-of-contents__link toc-highlight">使用RESTClient更新Kubernetes对象状态</a></li></ul></li><li><a href="#控制器模式" class="table-of-contents__link toc-highlight">控制器模式</a></li><li><a href="#被遗忘的监听watch机制" class="table-of-contents__link toc-highlight">被遗忘的监听（watch）机制</a><ul><li><a href="#使用restclient监听资源" class="table-of-contents__link toc-highlight">使用RESTClient监听资源</a></li><li><a href="#从watch机制到informer" class="table-of-contents__link toc-highlight">从watch机制到Informer</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Xudong Wang, Under license <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>, Built with Docusaurus.🎈</div></div></div></footer></div>
<script src="/crd-controller-from-scratch/assets/js/runtime~main.56e28771.js"></script>
<script src="/crd-controller-from-scratch/assets/js/main.66bc2718.js"></script>
</body>
</html>