<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-client-go/informer-is-all-you-need">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">informer is all you need | 《从零实现Kubernetes自定义控制器》</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://caozhuozi.github.io/crd-controller-from-scratch/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://caozhuozi.github.io/crd-controller-from-scratch/img/logo.png"><meta data-rh="true" property="og:url" content="https://caozhuozi.github.io/crd-controller-from-scratch/docs/client-go/informer-is-all-you-need"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="informer is all you need | 《从零实现Kubernetes自定义控制器》"><meta data-rh="true" name="description" content="在前面Controller小节中，我们以优化控制器为线索正式引入了client-go中的Informer组件。"><meta data-rh="true" property="og:description" content="在前面Controller小节中，我们以优化控制器为线索正式引入了client-go中的Informer组件。"><link data-rh="true" rel="icon" href="/crd-controller-from-scratch/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://caozhuozi.github.io/crd-controller-from-scratch/docs/client-go/informer-is-all-you-need"><link data-rh="true" rel="alternate" href="https://caozhuozi.github.io/crd-controller-from-scratch/docs/client-go/informer-is-all-you-need" hreflang="en"><link data-rh="true" rel="alternate" href="https://caozhuozi.github.io/crd-controller-from-scratch/docs/client-go/informer-is-all-you-need" hreflang="x-default"><link rel="stylesheet" href="/crd-controller-from-scratch/assets/css/styles.37df9119.css">
<link rel="preload" href="/crd-controller-from-scratch/assets/js/runtime~main.56e28771.js" as="script">
<link rel="preload" href="/crd-controller-from-scratch/assets/js/main.66bc2718.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#e6f6e6;color:#5f805b" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">🥳v0.6.0-rc2 is released.🎉</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/crd-controller-from-scratch/"><div class="navbar__logo"><img src="/crd-controller-from-scratch/img/logo.png" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/crd-controller-from-scratch/img/logo.png" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/crd-controller-from-scratch/docs/intro">开始</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/caozhuozi/crd-controller-from-scratch" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/crd-controller-from-scratch/docs/intro">前言</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/crd-controller-from-scratch/docs/apimachinery/apimachinery">apimachinery</a><button aria-label="Toggle the collapsible sidebar category &#x27;apimachinery&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/crd-controller-from-scratch/docs/client-go/client-go">client-go</a><button aria-label="Toggle the collapsible sidebar category &#x27;client-go&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/crd-controller-from-scratch/docs/client-go/restclient">RESTClient</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/crd-controller-from-scratch/docs/client-go/controller">Controller</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/crd-controller-from-scratch/docs/client-go/informer-is-all-you-need">informer is all you need</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/crd-controller-from-scratch/docs/client-go/summary">本章小结</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/crd-controller-from-scratch/docs/putting-it-all-together/putting-it-all-together">putting it all together</a><button aria-label="Toggle the collapsible sidebar category &#x27;putting it all together&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/crd-controller-from-scratch/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/crd-controller-from-scratch/docs/client-go/client-go"><span itemprop="name">client-go</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">informer is all you need</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>informer is all you need</h1><p>在前面<a href="/crd-controller-from-scratch/docs/client-go/controller">Controller</a>小节中，我们以优化控制器为线索正式引入了<code>client-go</code>中的<code>Informer</code>组件。
<code>Informer</code>本质上是一种本地资源缓存机制，旨在与集群的<code>etcd</code>同步。因此，它被定义在<code>k8s.io/client-go/tools/cache</code>包中。</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>注</div><div class="admonitionContent_S0QG"><p>在本节中，我们并不准备带读者进行<code>Informer</code>的代码走读。<code>Informer</code>为了可靠和高效在实现上远比我们想象的复杂。
为了便于让读者理解<code>Informer</code>的主要逻辑，
本节的内容基于<code>client-go</code> <a href="https://github.com/kubernetes/client-go/tree/v1.5.0" target="_blank" rel="noopener noreferrer">v1.5.0</a>——这是<code>client-go</code>库正式引入<code>Informer</code>框架的最初版本<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>，它与现在趋于稳定的版本已经接近，同时又相对精简，是我们了解informer框架非常好的材料。</p></div></div><p>由于<code>Informer</code>组件众多，在正式介绍<code>Informer</code>之前，我们会先从介绍构成<code>Informer</code>的组件开始讲起。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="reflector组件">Reflector组件<a href="#reflector组件" class="hash-link" aria-label="Direct link to Reflector组件" title="Direct link to Reflector组件">​</a></h2><p><code>Reflector</code>是构成<code>Informer</code>框架的一部分，它最主要作用是监听资源的变更。</p><img loading="lazy" src="/crd-controller-from-scratch/assets/images/reflector-simple-c504c0b022f49f536d49ed11c426a105.png" width="280px" class="img_ev3q"><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span><mdxadmonitiontitle><code>Reflector</code>组件的历史</mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p><code>Reflector</code>的出现甚至要早于<code>Informer</code>本身，<code>Reflector</code>的概念在<a href="https://github.com/kubernetes/kubernetes/pull/758" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 15"><path style="stroke:none;fill-rule:evenodd;fill:#24292f;fill-opacity:1" d="M7.977 0C3.567 0 0 3.438 0 7.691c0 3.399 2.285 6.278 5.453 7.293.399.079.543-.164.543-.367 0-.18-.016-.789-.016-1.426-2.218.457-2.68-.918-2.68-.918-.355-.89-.882-1.12-.882-1.12-.727-.47.05-.47.05-.47.805.051 1.231.79 1.231.79.711 1.172 1.86.84 2.324.636.063-.496.278-.84.5-1.03-1.77-.18-3.632-.84-3.632-3.798 0-.84.316-1.527.82-2.062-.078-.192-.356-.98.078-2.035 0 0 .676-.204 2.191.789a7.99 7.99 0 0 1 3.989 0c1.52-.993 2.195-.79 2.195-.79.434 1.055.156 1.844.078 2.036.516.535.817 1.222.817 2.062 0 2.957-1.86 3.606-3.645 3.797.293.242.543.7.543 1.426 0 1.031-.012 1.86-.012 2.113 0 .203.145.445.54.367 3.171-1.015 5.453-3.894 5.453-7.293C15.953 3.438 12.374 0 7.976 0Zm0 0"></path></svg> Pull Request #758</a>时引入。
官方开发者这样描述<code>Reflector</code>：</p><blockquote><p>Reflector watches a specified resource and causes all changes to be reflected in the given store.</p></blockquote><p>意思是说，<code>Reflector</code>监听指定的资源类型并使所有的变更事件<strong>反映</strong>到指定的存储（缓存）中。这就是<code>Reflector</code>名称的由来。
关于&quot;指定的存储（缓存）&quot;我们在接下来我们还会详细介绍。在这里，我们只想告诉你<code>Reflector</code>的由来。</p></div></div><p>不过，<code>Reflector</code>本身并不含有任何用于监听的组件，我们需要在创建<code>Reflector</code>时，由调用者传入&quot;监听逻辑&quot;，<code>Reflector</code>帮助我们执行监听。
为了便于说明，我们以<code>Reflector</code>的初始化函数作为对照：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NewReflector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">     lw ListerWatcher</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     expectedType </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     store Store</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     resyncPeriod time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Duration</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Reflector </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们先忽略创建<code>Reflector</code>的其他三个参数，仅关注<code>lw</code>这个参数，它就是需要由调用者提供的&quot;监听逻辑&quot;。它的类型是<code>ListerWatcher</code>：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> ListerWatcher </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ListOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Object</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Watch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ListOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">watch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Interface</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们可以看到<code>ListerWatcher</code>包含一个<code>Watch()</code>方法——这就是我们所说的调用者需要提供的&quot;监听逻辑&quot;。
除此以外，<code>ListerWatcher</code>还包括一个<code>List()</code>方法用于获取资源集合——在这里我们先暂且不说明需要它的原因，此刻我们还没有介绍<code>Reflector</code>组件整体的运行逻辑，贸然的解释或许只会让你更加疑惑。</p><p><code>client-go</code>中任何一个<a href="/crd-controller-from-scratch/docs/client-go/restclient#%E8%B5%84%E6%BA%90%E5%AE%A2%E6%88%B7%E7%AB%AF"><em>资源客户端</em></a>其实都&quot;满足&quot;这个接口。例如，<code>pods</code>资源客户端：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">k8s.io/client-go/kubernetes/typed/core/v1/pod.go</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodInterface </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">UpdateStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeleteOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">DeleteCollection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeleteOptions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> listOptions v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ListOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">opts v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ListOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodList</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Watch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">opts v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ListOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">watch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Interface</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Patch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pt api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PatchType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> subresources </span><span class="token operator" style="color:#393A34">...</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>注</div><div class="admonitionContent_S0QG"><p>其实，站在Go语法的角度，<em>资源客户端</em>并没有真正意义上实现<code>ListerWatcher</code>接口。我们以上述Pod资源客户端为例，请注意它的<code>List()</code>方法的返回类型上与<code>ListerWatcher</code>的细微差别：Pod资源客户端的<code>List()</code>返回类型是<strong><code>*v1.PodList</code></strong>。
在Go语言中，<code>List(opts v1.ListOptions) (*v1.PodList, error)</code>并不等同于实现了<code>ListerWatcher</code>的<code>List(options api.ListOptions) (runtime.Object, error)</code>
方法，尽管<code>*v1.PodList</code>类实现了<code>runtime.Object</code>接口。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// ❌ can not compile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> ListerWatcher </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clientset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Core</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Pods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当然，这涉及到Go语法本身的内容，不在我们的讨论范围之内。</p><p>我们通常在创建<code>ListerWatcher</code>类时，其实我们只需要借助<code>client-go</code>为我们预先准备好的<code>cache.ListWatch</code><sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup>类型再稍加结合<em>资源客户端</em>本身就可以快捷地创建出一个<code>ListerWatcher</code>对象。例如：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">lw </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ListWatch</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ListFunc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ListOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Object</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> clientset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Core</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Pods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        WatchFunc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ListOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">watch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Interface</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> clientset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Core</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Pods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Watch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ✅ can compile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> ListerWatcher </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><p>除了&quot;监听逻辑&quot;以外，<code>Reflector</code>中还包括两个<strong>缓存</strong>组件：<code>DeltaFIFO</code>以及<code>Indexer</code>。其中：</p><ul><li><code>Indexer</code>缓存也需要在创建<code>Reflector</code>时由调用者传入;</li><li><code>DeltaFIFO</code>缓存则是在<code>Reflector</code>内被创建。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deltafifo">DeltaFIFO<a href="#deltafifo" class="hash-link" aria-label="Direct link to DeltaFIFO" title="Direct link to DeltaFIFO">​</a></h3><p><code>DeltaFIFO</code>中的&quot;Delta&quot;可以理解为&quot;变更&quot;，它用于保存被监听资源的每一个变更事件（例如<code>Added</code>，<code>Updated</code>，<code>Deleted</code>）。
&quot;FIFO&quot; 表示同时它也是一个先入先出队列。保存其实就是&quot;入队&quot;的过程。</p><p><code>DeltaFIFO</code>中的基本单元&quot;变更&quot;<code>Delta</code>的定义为：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">k8s.io/client-go/tools/cache/delta_fifo.go</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Delta </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type   DeltaType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>它包括具体的变更类型（<code>Added</code>，<code>Updated</code>，<code>Deleted</code>）以及变更后的资源对象本身。</p><img loading="lazy" src="/crd-controller-from-scratch/assets/images/delta-a6ea8ba459485eb2d12a79967fe7a0f0.png" style="width:50%" class="img_ev3q"><p>注意，队列本身的粒度是资源，而非事件。每个资源对应一个保存本资源变更事件的切片（<code>[]Delta</code>）。
意思是说，当我们从这个队列pop出一项时，我们得到的是某个资源对应的当前所有变更事件的<strong>序列</strong>。</p><p>下图大致总结了<code>DeltaFIFO</code>的内部结构：</p><img loading="lazy" src="/crd-controller-from-scratch/assets/images/deltafifo-c9024ef5e41fb19bd487ce5d1e119311.png" style="width:80%" class="img_ev3q"><p>其中<code>queue</code>结构是队列的本体，而<code>items</code>结构则用于辅助保存每个资源对应变更事件切片。</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span><mdxadmonitiontitle><code>DeltaFIFO</code>的历史</mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p>在最初版本的<code>Reflector</code>中，其实并不包含<code>DeltaFIFO</code>组件，<code>Reflector</code>会把监听到的资源变更事件<strong>直接</strong>&quot;反映&quot;到指定资源缓存。
<code>DeltaFIFO</code>的历史最早可以追溯到<a href="https://github.com/kubernetes/kubernetes/pull/5473" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 15"><path style="stroke:none;fill-rule:evenodd;fill:#24292f;fill-opacity:1" d="M7.977 0C3.567 0 0 3.438 0 7.691c0 3.399 2.285 6.278 5.453 7.293.399.079.543-.164.543-.367 0-.18-.016-.789-.016-1.426-2.218.457-2.68-.918-2.68-.918-.355-.89-.882-1.12-.882-1.12-.727-.47.05-.47.05-.47.805.051 1.231.79 1.231.79.711 1.172 1.86.84 2.324.636.063-.496.278-.84.5-1.03-1.77-.18-3.632-.84-3.632-3.798 0-.84.316-1.527.82-2.062-.078-.192-.356-.98.078-2.035 0 0 .676-.204 2.191.789a7.99 7.99 0 0 1 3.989 0c1.52-.993 2.195-.79 2.195-.79.434 1.055.156 1.844.078 2.036.516.535.817 1.222.817 2.062 0 2.957-1.86 3.606-3.645 3.797.293.242.543.7.543 1.426 0 1.031-.012 1.86-.012 2.113 0 .203.145.445.54.367 3.171-1.015 5.453-3.894 5.453-7.293C15.953 3.438 12.374 0 7.976 0Zm0 0"></path></svg> Pull Request #5437</a>。
它作为作者将要引入的<code>Informer</code>框架的一部分而被引入。</p><p>在该PR中，根据作者对<code>DeltaFIFO</code>的注释：</p><blockquote><p>DeltaFIFO is a producer-consumer queue, where a Reflector is
indended to be the producer, and the consumer is whatever calls
the Pop() method.</p><p>DeltaFIFO solves this use case:</p><ul><li>You want to process every object change (delta) at most once.</li><li>When you process an object, you want to see everything
that&#x27;s happened to it since you last processed it.</li><li>You want to process the deletion of objects.</li><li>You might want to periodically reprocess objects.</li></ul></blockquote><p>可以看出<code>DeltaFIFO</code>设计之初就有意识地以资源作为队列&quot;粒度&quot;——以便在处理一个资源时（从队列中pop出一项），可以看到自从上一次处理它时<strong>所有</strong>的变更事件。
另外，一个值得注意的细节是，作者在设计<code>DeltaFIFO</code>伊始就有意识地让这个结构可以<strong>阶段性地重新处理所有事件</strong>。这个&quot;阶段性地重新处理&quot;我们还会在后续<a href="#reflector%E7%9A%84resync%E6%9C%BA%E5%88%B6">Reflector的resync机制</a>中详细介绍。</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="indexer">Indexer<a href="#indexer" class="hash-link" aria-label="Direct link to Indexer" title="Direct link to Indexer">​</a></h3><p><code>Indexer</code>则是真正的本地资源缓存——它保存的并不是资源变更事件，而是资源对象本身。
另外我们从它的名字——<em>索引器</em>可以看出它更侧重于对本地缓存资源的索引能力。
<em>索引器</em>支持自定义添加索引逻辑（函数），以让索引器可以根据不同条件检索资源。</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>如何向<em>索引器</em>添加索引逻辑不在本书的讨论范围之内。<code>Indexer</code>已经内置了一个名为<code>MetaNamespaceIndexFunc</code>的索引函数，因此，<code>Indexer</code>默认可以按照命名为空间来检索资源。</p></div></div><p>下图大致总结了<code>Indexer</code>的内部结构：</p><img loading="lazy" src="/crd-controller-from-scratch/assets/images/indexer-42cd7459ac2570b4f241e928e076dc9f.png" style="width:100%" class="img_ev3q"><p>其中<code>indexes</code>结构用于保存索引函数，<code>indices</code>结构保存则是索引函数建立的索引，<code>items</code>结构保存的才是资源对象。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reflector的运转">Reflector的运转<a href="#reflector的运转" class="hash-link" aria-label="Direct link to Reflector的运转" title="Direct link to Reflector的运转">​</a></h3><p>至此，我们已经把构成<code>Reflector</code>的模块介绍完毕。接下来，我们将介绍<code>Reflector</code>这些模块之间是如何产生联系的。</p><p><code>Reflector</code>组件通过<code>Run()</code>方法开启运转，<code>Run()</code>函数的主体是执行<code>ListAndWatch()</code>方法：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">k8s.io/client-go/tools/cache/reflector.go</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Reflector</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stopCh </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BackoffUntil</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ListAndWatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stopCh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">watchErrorHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backoffManager</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stopCh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>而<code>ListAndWatch()</code>方法中则会使用传入的<code>ListerWatcher</code>结构<code>lw</code>。
具体来说，在<code>ListAndWatch()</code>方法中：</p><ol><li><code>lw</code>的<code>List()</code>会被首先执行并且它<strong>仅被执行一次</strong>，用于先一次性获取所有资源集合，得到的结果将存入<code>Indexer</code>缓存中；</li><li>之后通过调用<code>lw</code>的<code>Watch()</code>函数<strong>持续</strong>获取资源的变更事件并将结果压入<code>DeltaFIFO</code>缓存中。</li></ol><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>注</div><div class="admonitionContent_S0QG"><p>我们也可以把<code>Reflector</code>的<code>ListAndWatch()</code>方法理解成<code>DeltaFIFO</code>的&quot;生产者&quot;。</p></div></div><p>需要注意的是，<code>Reflector</code>组件通过<code>Run()</code>函数启动之后，<code>DeltaFIFO</code>缓存开始持续不断加入变更事件。而另一个<code>Indexer</code>缓存在一次性获得资源集合后就没有再变动了。
<code>Indexer</code>缓存之后的增、删、改则依赖另一个叫做<a href="#controller%E7%BB%84%E4%BB%B6"><code>Controller</code></a>的组件驱动。</p><img loading="lazy" src="/crd-controller-from-scratch/assets/images/reflector-b1ce04f9492625eb3bb8ae4103d61ddd.png" style="height:280px" class="img_ev3q"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="controller组件">Controller组件<a href="#controller组件" class="hash-link" aria-label="Direct link to Controller组件" title="Direct link to Controller组件">​</a></h2><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>注</div><div class="admonitionContent_S0QG"><p>注意本小节的<code>Controller</code>并不是我们上一节所说的<em>Kubernetes控制器</em>，本节的<code>Controller</code>仅是<code>client-go</code>中的一个数据结构，也是构成<code>Informer</code>的直接组件。</p></div></div><p>在结构上，上文介绍的<code>Reflector</code>其实是<code>Controller</code>组件内的一个模块。并且<code>Controller</code>组件就是<code>DeltaFIFO</code>的&quot;消费者&quot;。
下面我们将通过<code>Controller</code>的运转逻辑来介绍<code>Controller</code>是如何消费`<code>DeltaFIFO</code>队列的。</p><p><code>Controller</code>通过<code>Run()</code>方法开启运转：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">k8s.io/client-go/tools/cache/controller.go</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">controller</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stopCh </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Until</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">processLoop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stopCh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>Run()</code>函数的主体是<code>processLoop()</code>函数，它直接负责持续驱动组件的运转。</p><p><code>Controller</code>的<code>processLoop()</code>方法如下所示，逻辑非常简单：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">k8s.io/client-go/tools/cache/controller.go</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">controller</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">processLoop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">        obj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">PopProcessFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Process</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> ErrFIFOClosed </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RetryOnError </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddIfNotPresent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>它会持续不断（<code>for</code>循环）从<code>Reflector</code>子组件的<code>DeltaFIFO</code>队列（<code>c.config.Queue</code>）中pop出一项（即某资源的<strong>完整</strong>变更事件切片<code>Deltas</code>），同时交由<code>Controller</code>的<code>Process</code>函数（上述代码的<code>c.config.Process</code>）处理，<code>Process</code>函数如下所示：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">k8s.io/client-go/tools/cache/controller.go</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// from oldest to newest</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Deltas</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Type </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Synced</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Added</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Updated</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> old</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exists</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> clientState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> exists </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> clientState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OnUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">old</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> clientState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OnAdd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Deleted</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> clientState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      h</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OnDelete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>Process</code>函数以一个资源完整的变更事件切片（<code>Deltas</code>）为输入：</p><ol><li>针对资源的每个变更事件（<code>for</code>循环），根据类型（<code>witch</code>语句），触发相应的&quot;回调函数&quot;：<code>OnUpdate()</code>，<code>OnUpdate()</code>，<code>OnDelete()</code>——这些&quot;回调函数&quot;在创建<code>Controller</code>组件时传入。
<strong>它们实际可以认为是<code>Controller</code>对外提供的资源变更事件的通知及处理机制</strong>；<div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>注</div><div class="admonitionContent_S0QG"><p>请暂时忽略代码中出现的<code>Synced</code>事件类型，从Kubernetes API Server中返回的资源变更事件仅有<code>Added</code>，<code>Updated</code>，<code>Deleted</code> 这三种。我们在后续<a href="#reflector%E7%9A%84resync%E6%9C%BA%E5%88%B6">Reflector的resync机制</a>会介绍<code>Synced</code>事件类型的产生。</p></div></div></li><li>针对资源的每个变更事件，根据类型，调用<code>Reflector</code>的<code>Indexer</code>索引缓存子组件（在上述代码中对应<code>clientState</code>）的相应方法更新（<code>Update()</code>）、新增（<code>Add()</code>）、删除（<code>Delete()</code>）相应资源——因此，我们也可以认为在<code>Controller</code>的驱动下，<strong><code>Indexer</code>缓存才开始真正成为&quot;反映&quot;<code>etcd</code>的本地缓存</strong>。</li></ol><img loading="lazy" src="/crd-controller-from-scratch/assets/images/controller-cb81fbd08516c12b703787eacfdc6c19.png" style="height:460px" class="img_ev3q"><p>至此，我们发现<code>Controller</code>组件似乎已经完全契合我们之前<a href="/crd-controller-from-scratch/docs/client-go/controller#%E4%BB%8Ewatch%E6%9C%BA%E5%88%B6%E5%88%B0informer">watch机制到Informer</a>小节中对Kubernetes控制器的两个要求。</p><blockquote><ol><li>资源变更事件的通知；</li><li>资源的本地缓存。</li></ol></blockquote><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span><mdxadmonitiontitle><code>Controller</code>组件的历史</mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p><code>Controller</code>的出现要早于<code>Informer</code>。
<code>Controller</code>最早可以追溯到<a href="https://github.com/kubernetes/kubernetes/issues/4877" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 15"><path style="stroke:none;fill-rule:evenodd;fill:#24292f;fill-opacity:1" d="M7.977 0C3.567 0 0 3.438 0 7.691c0 3.399 2.285 6.278 5.453 7.293.399.079.543-.164.543-.367 0-.18-.016-.789-.016-1.426-2.218.457-2.68-.918-2.68-.918-.355-.89-.882-1.12-.882-1.12-.727-.47.05-.47.05-.47.805.051 1.231.79 1.231.79.711 1.172 1.86.84 2.324.636.063-.496.278-.84.5-1.03-1.77-.18-3.632-.84-3.632-3.798 0-.84.316-1.527.82-2.062-.078-.192-.356-.98.078-2.035 0 0 .676-.204 2.191.789a7.99 7.99 0 0 1 3.989 0c1.52-.993 2.195-.79 2.195-.79.434 1.055.156 1.844.078 2.036.516.535.817 1.222.817 2.062 0 2.957-1.86 3.606-3.645 3.797.293.242.543.7.543 1.426 0 1.031-.012 1.86-.012 2.113 0 .203.145.445.54.367 3.171-1.015 5.453-3.894 5.453-7.293C15.953 3.438 12.374 0 7.976 0Zm0 0"></path></svg> Issue #4877</a>，作者提到：</p><blockquote><p>There are pitfalls when using the watch + list pattern. Many of our controllers use this pattern, and we expect many future pieces of code to use this pattern.
Therefore, we&#x27;d like to provide a framework/example which lets you fill out three functions (list, watch, and process) to get a shiny new bug-free (at least the list+watch part) controller.</p></blockquote><p>可见<code>Controller</code>的提出是为了解决使用&quot;<code>watch+list</code>模式&quot;编写控制器时容易产生bug的问题。官方开发者希望提供一个控制器框架让编写控制器变得简单并且不易发生错误。
最终，<code>Controller</code>的PR<a href="https://github.com/kubernetes/kubernetes/pull/5270" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 15"><path style="stroke:none;fill-rule:evenodd;fill:#24292f;fill-opacity:1" d="M7.977 0C3.567 0 0 3.438 0 7.691c0 3.399 2.285 6.278 5.453 7.293.399.079.543-.164.543-.367 0-.18-.016-.789-.016-1.426-2.218.457-2.68-.918-2.68-.918-.355-.89-.882-1.12-.882-1.12-.727-.47.05-.47.05-.47.805.051 1.231.79 1.231.79.711 1.172 1.86.84 2.324.636.063-.496.278-.84.5-1.03-1.77-.18-3.632-.84-3.632-3.798 0-.84.316-1.527.82-2.062-.078-.192-.356-.98.078-2.035 0 0 .676-.204 2.191.789a7.99 7.99 0 0 1 3.989 0c1.52-.993 2.195-.79 2.195-.79.434 1.055.156 1.844.078 2.036.516.535.817 1.222.817 2.062 0 2.957-1.86 3.606-3.645 3.797.293.242.543.7.543 1.426 0 1.031-.012 1.86-.012 2.113 0 .203.145.445.54.367 3.171-1.015 5.453-3.894 5.453-7.293C15.953 3.438 12.374 0 7.976 0Zm0 0"></path></svg> Pull Request #5270</a>被合入<a href="https://github.com/kubernetes/kubernetes/tree/v0.15.0" target="_blank" rel="noopener noreferrer">Kubernetes v0.15.0</a>中。</p></div></div><p>那么我们所说的<code>Informer</code>组件又是什么呢？</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="informer">Informer<a href="#informer" class="hash-link" aria-label="Direct link to Informer" title="Direct link to Informer">​</a></h2><p><code>Informer</code>包含了一个<code>Controller</code>组件。除去<code>Controller</code>本身，<code>Informer</code>本身并不含有任何实质性的组件或者驱动组件运行的模块。</p><p><code>Informer</code>的作用像是一个专门给调用者封装的简单易用的交互&quot;壳&quot;，它负责：</p><ol><li>传入<code>Controller</code>组件所需要的：<ul><li>&quot;回调函数&quot;——在代码中对应的封装类型为<code>ResourceEventHandlerFuncs</code></li><li><code>Reflector</code>子组件的<code>ListerWatcher</code>结构；</li></ul></li><li>初始化<code>Controller</code>组件；</li><li>并且向调用者返回：<ol><li><code>Controller</code>组件的<strong>引用</strong>以便调用者可以控制它的启停;</li><li><code>Reflector</code>子组件的<code>Indexer</code>缓存的<strong>引用</strong>以便调用者可以用它检索资源。</li></ol></li></ol><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>在本节中，我们没有给出<code>Informer</code>的创建函数的源码作为参照。原因是由于所含组件众多，<code>Informer</code>初始化函数本身逻辑较为混乱。感兴趣的读者可以根据上述说明自行找源码对照理解。</p></div></div><p> <code>Informer</code>的整体结构如下图所示：</p><img loading="lazy" src="/crd-controller-from-scratch/assets/images/informer-06403449a2fe37394a1abe3d62c4c64b.png" style="height:620px" class="img_ev3q"><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span><mdxadmonitiontitle><code>Informer</code>的历史</mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p><code>Informer</code>的历史最早可以追溯到<a href="https://github.com/kubernetes/kubernetes/pull/6546" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 15"><path style="stroke:none;fill-rule:evenodd;fill:#24292f;fill-opacity:1" d="M7.977 0C3.567 0 0 3.438 0 7.691c0 3.399 2.285 6.278 5.453 7.293.399.079.543-.164.543-.367 0-.18-.016-.789-.016-1.426-2.218.457-2.68-.918-2.68-.918-.355-.89-.882-1.12-.882-1.12-.727-.47.05-.47.05-.47.805.051 1.231.79 1.231.79.711 1.172 1.86.84 2.324.636.063-.496.278-.84.5-1.03-1.77-.18-3.632-.84-3.632-3.798 0-.84.316-1.527.82-2.062-.078-.192-.356-.98.078-2.035 0 0 .676-.204 2.191.789a7.99 7.99 0 0 1 3.989 0c1.52-.993 2.195-.79 2.195-.79.434 1.055.156 1.844.078 2.036.516.535.817 1.222.817 2.062 0 2.957-1.86 3.606-3.645 3.797.293.242.543.7.543 1.426 0 1.031-.012 1.86-.012 2.113 0 .203.145.445.54.367 3.171-1.015 5.453-3.894 5.453-7.293C15.953 3.438 12.374 0 7.976 0Zm0 0"></path></svg> Pull Request #6546</a>。
引入<code>Informer</code>结构的动机根据作者commit信息（<a href="https://github.com/lavalamp/kubernetes/commit/880f922bb673e4e9010cd848fe76e9c5b0d2bd1f" target="_blank" rel="noopener noreferrer">880f922</a>）:</p><blockquote><p>Add easy setup for simple controller</p></blockquote><p>可见<code>Informer</code>就是作为辅助便于创建<code>Controller</code>结构而存在的。</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="reflector的resync机制">Reflector的resync机制<a href="#reflector的resync机制" class="hash-link" aria-label="Direct link to Reflector的resync机制" title="Direct link to Reflector的resync机制">​</a></h2><p>在最后，为了让本节所有知识形成闭环，我们还需要再介绍一下<code>Reflector</code>组件的<em>resync机制</em>。</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>注</div><div class="admonitionContent_S0QG"><p>我们并没有把此小节并入<a href="#Reflector%E7%BB%84%E4%BB%B6">Reflector组件</a>中主要有两个原因。一方面是不想加重读者的阅读负担，
另一方面，在该小节中，我们仅仅知道了<code>DeltaFIFO</code>的&quot;生产者&quot;——<code>ListAndWatch()</code>函数，彼时还没有介绍<code>DeltaFIFO</code>的&quot;消费者&quot;——<a href="#Controller%E7%BB%84%E4%BB%B6">Controller组件</a>中的&quot;回调函数&quot;。在没有知道完整的背景之前，不利于我们对<em>resync机制</em>的理解。</p></div></div><p><em>resync机制</em>是指<strong>定时</strong>将<code>Indexer</code>组件中的数据重新同步回<code>DeltaFIFO</code>队列中。</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>注</div><div class="admonitionContent_S0QG"><p>在很多文章或者技术博客中，它们称之为<code>Informer</code>的resync机制。其实定时的<code>resync</code>是在<code>Reflector</code>的<code>ListAndWatch()</code>方法中启动的。
另外，<em>resync</em>动作是<code>Reflector</code>中两个缓存组件<code>DeltaFIFO</code>和<code>Indexer</code>之间的数据同步，
同时也正如我们在<a href="#informer">Informer</a>小节中所强调的那样，<code>Informer</code>是一个给调用者封装的一个&quot;壳&quot;。
因此，<code>Reflector</code>的<em>resync机制</em>是一种更为严谨的表述。</p></div></div><p>那么为什么要引入<em>resync机制</em>呢？
官方开发者考虑到回调函数在处理（消费）从<code>DeltaFIFO</code>队列中pop出的事件时，可能会存在处理失败的情况，引入定时的<em>resync机制</em>让这些处理失败的事件有了重新被处理的机会。</p><p>那么经过<em>resync</em>重新放入<code>DeltaFIFO</code>队列的事件，和直接从<code>kube-apiserver</code> 中监听到的事件有什么不一样呢？
首先，不同于<code>kube-apiserver</code>中监听到的三种事件类型（<code>Added</code>，<code>Updated</code>，<code>Deleted</code>），它的类型为<code>Sync</code>。</p><p>除此以外，<code>Sync</code>类型的事件在压入<code>DeltaFIFO</code>时，会检查<code>DeltaFIFO</code>中该资源的事件切片（<code>[]Delta</code>）此刻是否已经含有事件了（事件切片长度大于0），如果有，那么则放弃<em>resync</em>。
原因是<code>DeltaFIFO</code>中此刻已经存在的资源的事件（从<code>kube-apiserver</code>中&quot;新鲜出炉&quot;）一定比<em>resync</em>机制中&quot;已经出炉&quot;但准备&quot;回炉重造&quot;的资源更&quot;新&quot;。这种压入前的检查会减少<strong>重复消费</strong>发生的机率。</p><p>另外，<code>Reflector</code>组件也支持通过参数指定<em>resync</em>动作的发生频率。现在我们再回过头来看看<code>Reflector</code>的初始化函数：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func NewReflector(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     lw ListerWatcher,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     expectedType interface{},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     store Store,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     resyncPeriod time.Duration) *Reflector {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这四个参数分别是：</p><ul><li><code>lw</code>——某资源类型的监听函数</li><li><code>expectedType</code>——所监听资源类型的<em>kind</em></li><li><code>store</code>——资源本地缓存<code>Indexer</code></li><li><code>resyncPeriod</code>——<strong>用于指定<em>resync</em>动作的发生频率</strong>（<code>0</code>表示不执行<em>resync</em>）</li></ul><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span><mdxadmonitiontitle><code>resync</code>机制的历史</mdxadmonitiontitle></div><div class="admonitionContent_S0QG"><p><em>resync</em>机制的引入最早可以追溯到<a href="https://github.com/kubernetes/kubernetes/pull/4923" target="_blank" rel="noopener noreferrer">Pull Request #4923</a>。正如作者起的PR标题一样：</p><blockquote><p>Allow reflector to do full resync periodically</p></blockquote><p>意思是说允许<strong><code>Reflector</code></strong>可以周期性地做<strong>全同步</strong>。
不过最初版本的<em>resync</em>其实并不是指从<code>Indexer</code>中同步回<code>DeltaFIFO</code>中，在此PR中，作者所谓的<strong>全同步</strong>就是指周期性地重新<strong><code>List()</code></strong>一次。</p><p>直到<a href="https://github.com/kubernetes/kubernetes/issues/23394" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 15"><path style="stroke:none;fill-rule:evenodd;fill:#24292f;fill-opacity:1" d="M7.977 0C3.567 0 0 3.438 0 7.691c0 3.399 2.285 6.278 5.453 7.293.399.079.543-.164.543-.367 0-.18-.016-.789-.016-1.426-2.218.457-2.68-.918-2.68-.918-.355-.89-.882-1.12-.882-1.12-.727-.47.05-.47.05-.47.805.051 1.231.79 1.231.79.711 1.172 1.86.84 2.324.636.063-.496.278-.84.5-1.03-1.77-.18-3.632-.84-3.632-3.798 0-.84.316-1.527.82-2.062-.078-.192-.356-.98.078-2.035 0 0 .676-.204 2.191.789a7.99 7.99 0 0 1 3.989 0c1.52-.993 2.195-.79 2.195-.79.434 1.055.156 1.844.078 2.036.516.535.817 1.222.817 2.062 0 2.957-1.86 3.606-3.645 3.797.293.242.543.7.543 1.426 0 1.031-.012 1.86-.012 2.113 0 .203.145.445.54.367 3.171-1.015 5.453-3.894 5.453-7.293C15.953 3.438 12.374 0 7.976 0Zm0 0"></path></svg> Issue #23394</a>，社区开发者才决定将<code>List()</code>从<em>resync</em>中分离。
最终，将<code>List()</code>从<em>resync</em>机制中分离的<a href="https://github.com/kubernetes/kubernetes/pull/24142" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 15"><path style="stroke:none;fill-rule:evenodd;fill:#24292f;fill-opacity:1" d="M7.977 0C3.567 0 0 3.438 0 7.691c0 3.399 2.285 6.278 5.453 7.293.399.079.543-.164.543-.367 0-.18-.016-.789-.016-1.426-2.218.457-2.68-.918-2.68-.918-.355-.89-.882-1.12-.882-1.12-.727-.47.05-.47.05-.47.805.051 1.231.79 1.231.79.711 1.172 1.86.84 2.324.636.063-.496.278-.84.5-1.03-1.77-.18-3.632-.84-3.632-3.798 0-.84.316-1.527.82-2.062-.078-.192-.356-.98.078-2.035 0 0 .676-.204 2.191.789a7.99 7.99 0 0 1 3.989 0c1.52-.993 2.195-.79 2.195-.79.434 1.055.156 1.844.078 2.036.516.535.817 1.222.817 2.062 0 2.957-1.86 3.606-3.645 3.797.293.242.543.7.543 1.426 0 1.031-.012 1.86-.012 2.113 0 .203.145.445.54.367 3.171-1.015 5.453-3.894 5.453-7.293C15.953 3.438 12.374 0 7.976 0Zm0 0"></path></svg> Pull Request #24142</a>被合并入<a href="https://github.com/kubernetes/kubernetes/tree/v1.3.0-alpha.5" target="_blank" rel="noopener noreferrer">Kubernetes v1.3.0-alpha.5</a>。</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用informer">使用Informer<a href="/crd-controller-from-scratch/docs/intro#%E7%BA%A6%E5%AE%9A">🎈</a><a href="#使用informer" class="hash-link" aria-label="Direct link to 使用informer" title="Direct link to 使用informer">​</a></h2><p>可以说本小节之前的所有内容都在为如何使用<code>Informer</code>组件做铺垫。
我们首先来看如何初始化一个<code>Informer</code>：</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>初始化Informer（基于client-go v1.5.2）</summary><div><div class="collapsibleContent_i85q"><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;fmt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;k8s.io/client-go/1.5/kubernetes&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;k8s.io/client-go/1.5/pkg/api&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v1 </span><span class="token string" style="color:#e3116c">&quot;k8s.io/client-go/1.5/pkg/api/v1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;k8s.io/client-go/1.5/pkg/runtime&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;k8s.io/client-go/1.5/pkg/watch&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;k8s.io/client-go/1.5/rest&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;k8s.io/client-go/1.5/tools/cache&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// creates the in-cluster config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> rest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InClusterConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// creates the clientset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clientset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> kubernetes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewForConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewInformer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ListWatch</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ListFunc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ListOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Object</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> clientset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Core</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Pods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        WatchFunc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ListOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">watch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Interface</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> clientset</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Core</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Pods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Watch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ResourceEventHandlerFuncs</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AddFunc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                p </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;pod %s is added&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            UpdateFunc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">oldObj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newObj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                o </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> oldObj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                n </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> newObj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;pod %s is updated from %v to %v&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DeleteFunc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                p </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;pod %s is deleted&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>初始化<code>Informer</code>一共需要四个参数：</p><ul><li>某资源类型的监听函数</li><li>所监听资源类型的<em>kind</em></li><li>resync发生频率</li><li>三种事件对应的回调函数（<code>AddFunc</code>，<code>UpdateFunc</code>，<code>DeleteFunc</code>）</li></ul><p>这四个参数已经在之前相应的各个组件中介绍过了，在这里我们不再赘述。</p><p>接下来我们看看如何使用<code>Informer</code>。正如我们在前面所说，<code>Informer</code>组件本身并不具有任何实质性的组件，我们使用<code>Informer</code>本质上在使用它所<strong>代为创建</strong>的两个组件<code>Controller</code>和<code>Indexer</code>。</p><p><code>NewInformer</code>函数将代为创建的这两个组件返回以供调者使用：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">localCache</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> controller  </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewInformer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>之后我们可以通过调用<code>Controller</code>的<code>Run()</code>函数让整个<code>Informer</code>运转起来。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">controller</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>而<code>Indexer</code>作为一个本地缓存结构，<code>client-go</code>为它提供了丰富的方法以供检索资源：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">k8s.io/client-go/tools/cache/store.go</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Store </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ListKeys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exists </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">GetByKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exists </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="小结">小结<a href="#小结" class="hash-link" aria-label="Direct link to 小结" title="Direct link to 小结">​</a></h2><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>小结</div><div class="admonitionContent_S0QG"><p>我们从构成<code>Informer</code>的基本组件说起，最终描绘了<code>Informer</code>的整体结构。</p><p>简单来说，你可以把<code>Informer</code>理解成一个由某一资源类型的<code>List()</code>和<code>Watch()</code>函数驱动的本地资源缓存，同时它也提供了针对资源变更事件的通知及处理机制；</p></div></div><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>注</div><div class="admonitionContent_S0QG"><p>不同于其他文章或者博客介绍<code>Informer</code>的思路，在本节中：</p><ol><li>我们没有基于<code>client-go</code>中更被广泛使用的<code>SharedIndexInformer</code>。我们认为介绍更为基础的<code>Informer</code>结构更容易让读者接受。另外，为了让实现的控制器尽可能保持精简，我们使用的也是<code>Informer</code>而非<code>SharedIndexInformer</code>。因此，我们不再介绍<code>SharedIndexInformer</code>的有关内容。</li><li>我们并没有在介绍<code>Informer</code>的同时引入<code>client-go</code>中的<code>workqueue</code>。
根据<code>Informer</code>的源码，它本身运行并不需要<code>workqueue</code>组件。<code>client-go</code>中提供的<code>workqueue</code>仅仅是一种<strong>增强</strong>。
它可以被使用在本节所说的&quot;回调函数&quot;中，相比于在&quot;回调函数&quot;中单独<strong>直接</strong>处理各个事件，
我们可以在各个&quot;回调函数&quot;里把事件先暂时放入到<code>workqueue</code>中，我们再统一从<code>workqueue</code>中&quot;捞取&quot;并处理这些事件。
<code>client-go</code>中已经为我们提供了多种队列类型：通用队列、限速队列、延时队列等，我们可以借助这些官方开发者实现高效且可靠安全的队列来帮助我们编写高质量的程序。
为了降低读者阅读的负担，并且由于本书实现的控制器极为精简，它没有再利用<code>workqueue</code>增强，我们在本小节也不再赘述<code>workqueue</code>组件。</li></ol></div></div><div class="footnotes"><hr><ol><li id="fn-1"><p>请注意，informer框架本身并不是在<a href="https://github.com/kubernetes/kubernetes/tree/v1.5.0" target="_blank" rel="noopener noreferrer">Kubernetes v1.5.0</a>时才提出。在<a href="https://github.com/kubernetes/kubernetes/tree/v1.5.0" target="_blank" rel="noopener noreferrer">Kubernetes v1.5.0</a>之前，informer框架耦合在<code>kubernetes</code>库内（<code>k8s.io/kubernetes/pkg/controller/framework/informers</code>）。
在<a href="https://github.com/kubernetes/kubernetes/tree/v1.4.0-alpha.3" target="_blank" rel="noopener noreferrer">Kubernetes v1.4.0-alpha.3</a>，Kubernetes社区才开始有了单独的客户端库<code>client-go</code>。在<a href="https://github.com/kubernetes/kubernetes/tree/v1.5.0" target="_blank" rel="noopener noreferrer">Kubernetes v1.5.0</a>时完成了informer框架到<code>client-go</code>的迁移。</p><p>  关于<code>client-go</code>库的历史可以参考Kubernetes的<a href="https://github.com/kubernetes/kubernetes/issues/28559" target="_blank" rel="noopener noreferrer">Issue #28559</a>。</p><p>  关于informer框架迁入<code>client-go</code>的历史可以参考<code>client-go</code>的<a href="https://github.com/kubernetes/client-go/issues/4" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 15"><path style="stroke:none;fill-rule:evenodd;fill:#24292f;fill-opacity:1" d="M7.977 0C3.567 0 0 3.438 0 7.691c0 3.399 2.285 6.278 5.453 7.293.399.079.543-.164.543-.367 0-.18-.016-.789-.016-1.426-2.218.457-2.68-.918-2.68-.918-.355-.89-.882-1.12-.882-1.12-.727-.47.05-.47.05-.47.805.051 1.231.79 1.231.79.711 1.172 1.86.84 2.324.636.063-.496.278-.84.5-1.03-1.77-.18-3.632-.84-3.632-3.798 0-.84.316-1.527.82-2.062-.078-.192-.356-.98.078-2.035 0 0 .676-.204 2.191.789a7.99 7.99 0 0 1 3.989 0c1.52-.993 2.195-.79 2.195-.79.434 1.055.156 1.844.078 2.036.516.535.817 1.222.817 2.062 0 2.957-1.86 3.606-3.645 3.797.293.242.543.7.543 1.426 0 1.031-.012 1.86-.012 2.113 0 .203.145.445.54.367 3.171-1.015 5.453-3.894 5.453-7.293C15.953 3.438 12.374 0 7.976 0Zm0 0"></path></svg> Issue #4</a>以及Kubernetes的<a href="https://github.com/kubernetes/kubernetes/pull/32718" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 15"><path style="stroke:none;fill-rule:evenodd;fill:#24292f;fill-opacity:1" d="M7.977 0C3.567 0 0 3.438 0 7.691c0 3.399 2.285 6.278 5.453 7.293.399.079.543-.164.543-.367 0-.18-.016-.789-.016-1.426-2.218.457-2.68-.918-2.68-.918-.355-.89-.882-1.12-.882-1.12-.727-.47.05-.47.05-.47.805.051 1.231.79 1.231.79.711 1.172 1.86.84 2.324.636.063-.496.278-.84.5-1.03-1.77-.18-3.632-.84-3.632-3.798 0-.84.316-1.527.82-2.062-.078-.192-.356-.98.078-2.035 0 0 .676-.204 2.191.789a7.99 7.99 0 0 1 3.989 0c1.52-.993 2.195-.79 2.195-.79.434 1.055.156 1.844.078 2.036.516.535.817 1.222.817 2.062 0 2.957-1.86 3.606-3.645 3.797.293.242.543.7.543 1.426 0 1.031-.012 1.86-.012 2.113 0 .203.145.445.54.367 3.171-1.015 5.453-3.894 5.453-7.293C15.953 3.438 12.374 0 7.976 0Zm0 0"></path></svg> Pull Request #32718</a>和<a href="https://github.com/kubernetes/kubernetes/pull/34989" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 15"><path style="stroke:none;fill-rule:evenodd;fill:#24292f;fill-opacity:1" d="M7.977 0C3.567 0 0 3.438 0 7.691c0 3.399 2.285 6.278 5.453 7.293.399.079.543-.164.543-.367 0-.18-.016-.789-.016-1.426-2.218.457-2.68-.918-2.68-.918-.355-.89-.882-1.12-.882-1.12-.727-.47.05-.47.05-.47.805.051 1.231.79 1.231.79.711 1.172 1.86.84 2.324.636.063-.496.278-.84.5-1.03-1.77-.18-3.632-.84-3.632-3.798 0-.84.316-1.527.82-2.062-.078-.192-.356-.98.078-2.035 0 0 .676-.204 2.191.789a7.99 7.99 0 0 1 3.989 0c1.52-.993 2.195-.79 2.195-.79.434 1.055.156 1.844.078 2.036.516.535.817 1.222.817 2.062 0 2.957-1.86 3.606-3.645 3.797.293.242.543.7.543 1.426 0 1.031-.012 1.86-.012 2.113 0 .203.145.445.54.367 3.171-1.015 5.453-3.894 5.453-7.293C15.953 3.438 12.374 0 7.976 0Zm0 0"></path></svg> Pull Request #34989</a>。<a href="#fnref-1" class="footnote-backref">↩</a></p></li><li id="fn-2"><p>在本节中，<code>cache</code>指的是<code>client-go</code>的<code>tools</code>包中的<code>cache</code>子包。<a href="#fnref-2" class="footnote-backref">↩</a></p></li></ol></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/crd-controller-from-scratch/docs/client-go/controller"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Controller</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/crd-controller-from-scratch/docs/client-go/summary"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">本章小结</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#reflector组件" class="table-of-contents__link toc-highlight">Reflector组件</a><ul><li><a href="#deltafifo" class="table-of-contents__link toc-highlight">DeltaFIFO</a></li><li><a href="#indexer" class="table-of-contents__link toc-highlight">Indexer</a></li><li><a href="#reflector的运转" class="table-of-contents__link toc-highlight">Reflector的运转</a></li></ul></li><li><a href="#controller组件" class="table-of-contents__link toc-highlight">Controller组件</a></li><li><a href="#informer" class="table-of-contents__link toc-highlight">Informer</a></li><li><a href="#reflector的resync机制" class="table-of-contents__link toc-highlight">Reflector的resync机制</a></li><li><a href="#使用informer" class="table-of-contents__link toc-highlight">使用Informer🎈</a></li><li><a href="#小结" class="table-of-contents__link toc-highlight">小结</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Xudong Wang, Under license <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>, Built with Docusaurus.🎈</div></div></div></footer></div>
<script src="/crd-controller-from-scratch/assets/js/runtime~main.56e28771.js"></script>
<script src="/crd-controller-from-scratch/assets/js/main.66bc2718.js"></script>
</body>
</html>