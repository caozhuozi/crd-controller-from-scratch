---
sidebar_position: 3
---

import DeltaFIFOPNG from '@site/static/img/deltafifo.png';
import IndexerPNG from '@site/static/img/indexer.png';
import DeltaPNG from '@site/static/img/delta.png';
import ReflectorPNG from '@site/static/img/reflector.png';
import ControllerPNG from '@site/static/img/controller.png';
import InformerPNG from '@site/static/img/informer.png';


# informer is all you need

åœ¨å‰é¢[controller](./controller)ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»¥ä¼˜åŒ–æ§åˆ¶å™¨ä¸ºçº¿ç´¢æ­£å¼å¼•å…¥äº†`client-go`ä¸­çš„`Informer`ç»„ä»¶ã€‚
`Informer`æœ¬è´¨ä¸Šæ˜¯ä¸€ç§æœ¬åœ°èµ„æºç¼“å­˜æœºåˆ¶ï¼Œæ—¨åœ¨ä¸é›†ç¾¤çš„etcdåŒæ­¥ã€‚å› æ­¤ï¼Œå®ƒè¢«å®šä¹‰åœ¨`k8s.io/client-go/tools/cache`åŒ…ä¸­ã€‚

:::note
åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸å‡†å¤‡å¸¦è¯»è€…è¿›è¡Œinformerçš„ä»£ç èµ°è¯»ã€‚
åŒä¹‹å‰[åºåˆ—åŒ–å™¨ä¸åºåˆ—åŒ–å™¨å·¥å‚](../apimachinery/serializer)ç« èŠ‚ä¸€æ ·ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¹Ÿå¹¶ä¸è¿½æ±‚informerå®ç°ä¸Šçš„ç»†èŠ‚ï¼Œå®ƒä¸ºäº†å¯é å’Œé«˜æ•ˆåœ¨å®ç°ä¸Šè¿œæ¯”æˆ‘ä»¬æƒ³è±¡çš„å¤æ‚ã€‚
æœ¬èŠ‚ä»‹ç»çš„informerå·¥ä½œæœºåˆ¶ä»…ç”¨äºç†è§£æœ€ç»ˆæˆ‘ä»¬å®ç°çš„è‡ªå®šä¹‰æ§åˆ¶å™¨ã€‚

ä¹Ÿå› æ­¤ï¼Œä¸ºäº†ä¾¿äºè®©è¯»è€…ç†è§£informerçš„ä¸»è¦é€»è¾‘ï¼Œ
æœ¬èŠ‚çš„å†…å®¹åŸºäº`client-go` [v1.5.0](https://github.com/kubernetes/client-go/tree/v1.5.0)â€”â€”è¿™æ˜¯`client-go`åº“æ­£å¼å¼•å…¥informeræ¡†æ¶çš„æœ€åˆç‰ˆæœ¬[^1]ï¼Œå®ƒä¸ç°åœ¨è¶‹äºç¨³å®šçš„ç‰ˆæœ¬å·²ç»æ¥è¿‘ï¼ŒåŒæ—¶åˆç›¸å¯¹ç²¾ç®€ï¼Œæ˜¯æˆ‘ä»¬äº†è§£informeræ¡†æ¶éå¸¸å¥½çš„ææ–™ã€‚
:::

åœ¨æ­£å¼ä»‹ç»informerä¹‹å‰ï¼ŒæŒ‰ç…§æƒ¯ä¾‹ï¼Œæˆ‘ä»¬ä¼šå…ˆä»ä»‹ç»æ„æˆinformerçš„ç»„ä»¶å¼€å§‹è®²èµ·ã€‚

## Reflectorç»„ä»¶

Reflectorç”±ä¸¤ä¸ª**ç¼“å­˜**ç»„ä»¶`DeltaFIFO`ä»¥åŠ`Indexer`ç»„æˆã€‚

å…¶ä¸­ï¼Œ`DeltaFIFO`çš„"Delta"å¯ä»¥ç†è§£ä¸º"å˜æ›´"ï¼Œå®ƒä¿å­˜è¢«ç›‘å¬èµ„æºçš„æ¯ä¸€ä¸ªå˜æ›´äº‹ä»¶ï¼ˆä¾‹å¦‚`Added`ï¼Œ`Updated`ï¼Œ`Deleted`ï¼‰ã€‚"FIFO" è¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªå…ˆå…¥å…ˆå‡ºé˜Ÿåˆ—ã€‚é˜Ÿåˆ—é¡ºåºçš„ç²’åº¦æ˜¯èµ„æºï¼Œè€Œéäº‹ä»¶ã€‚æ¯ä¸ªèµ„æºå¯¹åº”ä¸€ä¸ªä¿å­˜æœ¬èµ„æºå˜æ›´äº‹ä»¶çš„åˆ‡ç‰‡ï¼ˆ`[]Delta`ï¼‰ã€‚
å½“ç›‘å¬åˆ°æŸèµ„æºçš„å˜æ›´äº‹ä»¶ï¼Œå¦‚æœè¯¥èµ„æºå·²ç»åœ¨é˜Ÿåˆ—ä¸­äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªå˜æ›´äº‹ä»¶åªä¼šè¿½åŠ åˆ°è¯¥èµ„æºå¯¹åº”çš„å˜æ›´äº‹ä»¶åˆ‡ç‰‡ä¸­ï¼Œè€Œå¹¶ä¸ä¼šå½±å“è¯¥èµ„æºæœ¬èº«åœ¨é˜Ÿåˆ—ä¸­çš„é¡ºåºã€‚

<img src={DeltaFIFOPNG} style= {{width: "80%"}}/>

å…¶ä¸­ï¼Œ`DeltaFIFO`ä¸­çš„åŸºæœ¬å•å…ƒ"å˜æ›´"`Delta`çš„å®šä¹‰ä¸ºï¼š
```go title="k8s.io/client-go/tools/cache/delta_fifo.go"
type Delta struct {
	Type   DeltaType
	Object interface{}
}
```
å®ƒåŒ…æ‹¬å…·ä½“çš„å˜æ›´ç±»å‹ï¼ˆ`Added`ï¼Œ`Updated`ï¼Œ`Deleted`ï¼‰ä»¥åŠå˜æ›´åçš„èµ„æºå¯¹è±¡æœ¬èº«ã€‚

<img src={DeltaPNG}  style= {{width: "50%"}}/>


`Indexer`åˆ™å¯ä»¥ç†è§£æˆæœ¬åœ°èµ„æºç¼“å­˜çš„*ç´¢å¼•å™¨*ï¼Œé¦–å…ˆå®ƒä¿å­˜çš„å¹¶ä¸æ˜¯èµ„æºå˜æ›´äº‹ä»¶ï¼Œè€Œæ˜¯èµ„æºå¯¹è±¡æœ¬èº«ã€‚å…¶æ¬¡å®ƒä¾§é‡äºå¯¹æœ¬åœ°ç¼“å­˜èµ„æºçš„ç´¢å¼•èƒ½åŠ›ã€‚
ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç´¢å¼•å™¨ä¸­å®šä¹‰ä¸€ä¸ªåä¸º"`namespace`"çš„ç´¢å¼•é¡¹ï¼Œå®ƒå¯ä»¥ä»¥namespaceä¸ºå•ä½ï¼Œæ£€ç´¢å„ä¸ªnamespaceä¸‹æ‰€æœ‰æœ¬åœ°ç¼“å­˜èµ„æºã€‚


<img src={IndexerPNG} style= {{width: "100%"}}/>

`Reflector`ç»„ä»¶é€šè¿‡`Run()`æ–¹æ³•å¼€å¯è¿è½¬ï¼Œ`Run()`å‡½æ•°é‡Œå¯åŠ¨æ‰§è¡Œçš„`ListAndWatch()`æ–¹æ³•**æŒç»­**é€šè¿‡Kubernetes APIç›‘å¬èµ„æºå˜æ›´äº‹ä»¶å¹¶å°†å˜æ›´äº‹ä»¶åŠ å…¥åˆ°`DeltaFIFO`ç¼“å­˜ä¸­ï¼š
```go title="k8s.io/client-go/tools/cache/reflector.go"
func (r *Reflector) Run(stopCh <-chan struct{}) {
	wait.BackoffUntil(func() {
		if err := r.ListAndWatch(stopCh); err != nil {
			r.watchErrorHandler(r, err)
		}
	}, r.backoffManager, true, stopCh)
}
```
å…¶ä¸­`ListAndWatch()`æ–¹æ³•åœ¨åˆ›å»º`Reflector`ç»„ä»¶æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå®ƒéœ€è¦è°ƒç”¨`List()`å’Œ`Watch()`ä¸¤ä¸ªå‡½æ•°ï¼Œ`List()`åœ¨å¯åŠ¨`Reflector`ç»„ä»¶æ—¶å…ˆä¸€æ¬¡æ€§å‘Kubernetes APIè·å–æŸä¸€èµ„æºç±»å‹çš„æ‰€æœ‰èµ„æºé›†åˆï¼Œä¹‹ååˆ™é€šè¿‡`Watch()`å‡½æ•°æŒç»­é€šè¿‡Kubernetes APIç›‘å¬èµ„æºçš„å˜æ›´äº‹ä»¶[^2]ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`Reflector`ç»„ä»¶é€šè¿‡`Run()`å‡½æ•°å¯åŠ¨ä¹‹åï¼Œä»…æœ‰`DeltaFIFO`ç¼“å­˜å¼€å§‹ä¸æ–­åŠ å…¥å˜æ›´äº‹ä»¶ï¼Œ
ä½†æ˜¯å¦ä¸€ä¸ª`Indexer`èµ„æºç¼“å­˜ç»„ä»¶å¹¶æ²¡æœ‰å®é™…å¼€å§‹ä¿å­˜ä»»ä½•èµ„æºå¯¹è±¡å®ƒâ€”â€”å®ƒä»ç„¶æ˜¯ä¸€ä¸ªç©ºçš„ç¼“å­˜ã€‚`Indexer`ç¼“å­˜ä»ç„¶éœ€è¦é¢å¤–çš„æ–¹æ³•è°ƒç”¨å¾€å…¶ä¸­æ·»åŠ æ•°æ®ã€‚

<img src={ReflectorPNG} style= {{height: "280px"}}/>



## Controllerç»„ä»¶
:::note
æ³¨æ„æœ¬å°èŠ‚çš„`Controller`å¹¶ä¸æ˜¯æˆ‘ä»¬ä¸Šä¸€èŠ‚æ‰€è¯´çš„*Kubernetesæ§åˆ¶å™¨*ï¼Œæœ¬èŠ‚çš„`Controller`ä»…æ˜¯`client-go`ä¸­çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œä¹Ÿæ˜¯æ„æˆ`Informer`çš„ç›´æ¥ç»„ä»¶ã€‚
:::

`Controller`å†…å«æœ‰ä¸€ä¸ª`Reflector`ç»„ä»¶ï¼Œ`Controller`é€šè¿‡å…¶`Run()`æ–¹æ³•å¼€å¯ç»„ä»¶çš„è¿è½¬ã€‚æ›´å…·ä½“æ¥è¯´ï¼Œåœ¨`Run()`å‡½æ•°é‡Œï¼Œ`processLoop()`æ–¹æ³•è¢«è°ƒç”¨ï¼Œå®ƒç›´æ¥è´Ÿè´£æŒç»­é©±åŠ¨ç»„ä»¶çš„è¿è½¬ã€‚
```go title="k8s.io/client-go/tools/cache/controller.go"
func (c *controller) Run(stopCh <-chan struct{}) {
   // ...
	wait.Until(c.processLoop, time.Second, stopCh)
	wg.Wait()
}
```

`Controller`çš„`processLoop()`æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼Œé€»è¾‘éå¸¸ç®€å•ï¼š
```go title="k8s.io/client-go/tools/cache/controller.go"
func (c *controller) processLoop() {
	for {
	    // highlight-next-line
		obj, err := c.config.Queue.Pop(PopProcessFunc(c.config.Process))
		if err != nil {
			if err == ErrFIFOClosed {
				return
			}
			if c.config.RetryOnError {
				c.config.Queue.AddIfNotPresent(obj)
			}
		}
	}
}
```
å®ƒä¼šæŒç»­ä¸æ–­ï¼ˆä¸Šè¿°ä»£ç çš„`for`å¾ªç¯ï¼‰ä»`Reflector`å­ç»„ä»¶çš„`DeltaFIFO`é˜Ÿåˆ—ï¼ˆä¸Šè¿°ä»£ç çš„`c.config.Queue`ï¼‰ä¸­popå‡ºä¸€é¡¹ï¼ˆå³æŸèµ„æºçš„**å®Œæ•´**å˜æ›´äº‹ä»¶åˆ‡ç‰‡`Deltas`ï¼‰ï¼ŒåŒæ—¶äº¤ç”±`Controller`çš„`Process`å‡½æ•°ï¼ˆä¸Šè¿°ä»£ç çš„`c.config.Process`ï¼‰å¤„ç†ï¼š
```go title="k8s.io/client-go/tools/cache/controller.go"
func(obj interface{}) error {
  // from oldest to newest
  for _, d := range obj.(Deltas) {
    // ...
  	switch d.Type {
  	case Sync, Replaced, Added, Updated:
  	  if old, exists, err := clientState.Get(obj); err == nil && exists {
  	  	if err := clientState.Update(obj); err != nil {
  	  	  return err
  	  	}
  	  	h.OnUpdate(old, obj)
  	  } else {
  	  	if err := clientState.Add(obj); err != nil {
  	  	  return err
  	  	}
  	  	h.OnAdd(obj)
  	  }
  	case Deleted:
  	  if err := clientState.Delete(obj); err != nil {
  	  	return err
  	  }
  	  h.OnDelete(obj)
  	}
  }
  return nil
}
```
`Process`å‡½æ•°ä»¥ä¸€ä¸ªèµ„æºçš„å˜æ›´äº‹ä»¶åˆ‡ç‰‡ï¼ˆ`Deltas`ï¼‰ä¸ºè¾“å…¥ï¼š

1. é’ˆå¯¹èµ„æºçš„æ¯ä¸ªå˜æ›´äº‹ä»¶ï¼ˆä¸Šè¿°ä»£ç ä¸­çš„`for`å¾ªç¯ï¼‰ï¼Œæ ¹æ®ç±»å‹ï¼ˆä¸Šè¿°ä»£ç ä¸­çš„`switch`è¯­å¥ï¼‰ï¼Œ**è§¦å‘**ç›¸åº”çš„"é’©å­å‡½æ•°ï¼ˆå›è°ƒå‡½æ•°ï¼‰"ï¼š`OnUpdate()`ï¼Œ`OnUpdate()`ï¼Œ`OnDelete()`ã€‚è¿™äº›"å›è°ƒå‡½æ•°"æ˜¯åœ¨åˆ›å»º`Controller`ç»„ä»¶æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚
   **å®ƒä»¬çš„ä½œç”¨å…¶å®å¯ä»¥è®¤ä¸ºæ˜¯`Controller`å¯¹å¤–æä¾›çš„èµ„æºå˜æ›´äº‹ä»¶çš„é€šçŸ¥åŠå¤„ç†æœºåˆ¶**ï¼›
2. é’ˆå¯¹èµ„æºçš„æ¯ä¸ªå˜æ›´äº‹ä»¶ï¼Œæ ¹æ®ç±»å‹ï¼Œè°ƒç”¨`Reflector`çš„`Indexer`ç´¢å¼•ç¼“å­˜å­ç»„ä»¶ï¼ˆåœ¨ä¸Šè¿°ä»£ç ä¸­å¯¹åº”`clientState`ï¼‰çš„ç›¸åº”æ–¹æ³•æ›´æ–°ï¼ˆ`Update()`ï¼‰ã€æ–°å¢ï¼ˆ`Add()`ï¼‰ã€åˆ é™¤ï¼ˆ`Delete()`ï¼‰ç›¸åº”èµ„æºâ€”â€”å› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®¤ä¸ºåœ¨`Controller`çš„é©±åŠ¨ä¸‹ï¼Œ`Indexer`ç¼“å­˜åœ¨**å°½åŠ›ä¸etcdä¿æŒåŒæ­¥**ã€‚

<img src={ControllerPNG} style={{height: "460px"}}/>

è‡³æ­¤ï¼Œæˆ‘ä»¬å‘ç°`Controller`ç»„ä»¶ä¼¼ä¹å·²ç»å®Œå…¨å¥‘åˆæˆ‘ä»¬ä¹‹å‰[ä»Kubernetes watchæœºåˆ¶åˆ°Informer](./controller#ä»kubernetes-watchæœºåˆ¶åˆ°informer)å°èŠ‚ä¸­å¯¹Kubernetesæ§åˆ¶å™¨çš„ä¸¤ä¸ªè¦æ±‚ã€‚

> 1. èµ„æºå˜æ›´äº‹ä»¶çš„é€šçŸ¥ï¼›
> 2. æœ¬åœ°èµ„æºçš„ç¼“å­˜ã€‚


é‚£ä¹ˆæˆ‘ä»¬æ‰€è¯´çš„`Informer`ç»„ä»¶åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ


## Informer

`Informer`åŒ…å«äº†ä¸€ä¸ª`Controller`ç»„ä»¶ã€‚é™¤å»`Controller`æœ¬èº«ï¼Œ`Informer`æœ¬èº«å¹¶ä¸å«æœ‰ä»»ä½•å®è´¨æ€§çš„ç»„ä»¶æˆ–è€…é©±åŠ¨ç»„ä»¶è¿è¡Œçš„æ¨¡å—ã€‚



`Informer`çš„ä½œç”¨åƒæ˜¯ä¸€ä¸ªä¸“é—¨ç»™è°ƒç”¨è€…å°è£…çš„ç®€å•æ˜“ç”¨çš„äº¤äº’"å£³"ï¼Œå®ƒè´Ÿè´£ï¼š

1. ä¼ å…¥`Controller`ç»„ä»¶æ‰€éœ€è¦çš„ï¼š
    * "å›è°ƒå‡½æ•°"â€”â€”åœ¨ä»£ç ä¸­ä¸ºè¢«ç§°ä¸º`ResourceEventHandlerFuncs`ï¼Œä»¥åŠ
    * ï¼ˆ`Controller`å†…ï¼‰`Reflector`ç»„ä»¶çš„`ListWatch()`å‡½æ•°ï¼›
2. åˆå§‹åŒ–`Controller`ç»„ä»¶ï¼›
3. å¹¶ä¸”å‘è°ƒç”¨è€…è¿”å›ï¼š
    1.  `Controller`ç»„ä»¶çš„å¼•ç”¨ä»¥ä¾¿è°ƒç”¨è€…å¯ä»¥æ§åˆ¶å®ƒçš„å¯åœ;
    2. ï¼ˆ`Controller`ä¸­ï¼‰`Reflector`ç»„ä»¶çš„`Indexer`ç¼“å­˜çš„å¼•ç”¨ä»¥ä¾¿è°ƒç”¨è€…å¯ä»¥ç›´æ¥æ£€ç´¢èµ„æºã€‚

å¯¹åº”åˆ°æºç ï¼Œ`newInformer`
```go title="k8s.io/client-go/tools/cache/controller.go"
func newInformer(
	lw ListerWatcher,
	objType runtime.Object,
	resyncPeriod time.Duration,
	h ResourceEventHandler,
	clientState Store,
	transformer TransformFunc,
) Controller {
	fifo := NewDeltaFIFOWithOptions(DeltaFIFOOptions{
		KnownObjects:          clientState,
		EmitDeltaTypeReplaced: true,
		Transformer:           transformer,
	})

	cfg := &Config{
		Queue:            fifo,
		ListerWatcher:    lw,
		ObjectType:       objType,
		FullResyncPeriod: resyncPeriod,
		RetryOnError:     false,

		Process: func(obj interface{}, isInInitialList bool) error {
			if deltas, ok := obj.(Deltas); ok {
				return processDeltas(h, clientState, deltas, isInInitialList)
			}
			return errors.New("object given as Process argument is not Deltas")
		},
	}
	return New(cfg)
}
```



<img src={InformerPNG} style={{height: "620px"}}/>

## Reflectorçš„resyncæœºåˆ¶
å¦å¤–ï¼Œå€¼å¾—ä¸€æçš„æ˜¯`Reflector`ç»„ä»¶çš„*resyncæœºåˆ¶*ã€‚
:::note
æˆ‘ä»¬å¹¶æ²¡æœ‰æŠŠæ­¤å°å§å¹¶å…¥[Reflectorç»„ä»¶](#Reflectorç»„ä»¶)å°èŠ‚ä¸­ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ã€‚ä¸€æ–¹é¢æ˜¯å› ä¸ºä¸æƒ³åŠ é‡è¯»è€…çš„é˜…è¯»è´Ÿæ‹…ï¼Œ
å¦ä¸€æ–¹é¢ï¼Œåœ¨è¯¥å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»…ä»…çŸ¥é“äº†`DeltaFIFO`çš„"ç”Ÿäº§è€…"â€”â€”`ListAndWatch()`ï¼Œå½¼æ—¶è¿˜æ²¡æœ‰ä»‹ç»`DeltaFIFO`çš„"æ¶ˆè´¹è€…"â€”â€”[Controllerç»„ä»¶](#Controllerç»„ä»¶)ä¸­çš„å›è°ƒå‡½æ•°ï¼Œåœ¨æ²¡æœ‰çŸ¥é“å®Œæ•´çš„èƒŒæ™¯ä¹‹å‰ï¼Œä¸åˆ©äºæˆ‘ä»¬å¯¹*resyncæœºåˆ¶*çš„ç†è§£ã€‚
:::

*resyncæœºåˆ¶*æ˜¯æŒ‡**å®šæ—¶**å°†`Indexer`ç»„ä»¶ä¸­çš„æ•°æ®é‡æ–°åŒæ­¥å›`DeltaFIFO`é˜Ÿåˆ—ç»„ä»¶ã€‚
:::note
åœ¨å¾ˆå¤šæ–‡ç« æˆ–è€…æŠ€æœ¯åšå®¢ä¸­ï¼Œå®ƒä»¬ç§°ä¹‹ä¸º`Informer`çš„resyncæœºåˆ¶ã€‚å…¶å®å®šæ—¶çš„`resync`æ˜¯åœ¨`Reflector`çš„`ListAndWatch()`æ–¹æ³•ä¸­å¯åŠ¨çš„ã€‚
```go title="k8s.io/client-go/tools/cache/reflector.go"
func (r *Reflector) ListAndWatch(stopCh <-chan struct{}) error {
  // ...
  go func() {
    resyncCh, cleanup := r.resyncChan()
    defer func() {
    	cleanup() // Call the last one written into cleanup
    }()
    for {
      select {
      case <-resyncCh:
      case <-stopCh:
      	return
      case <-cancelCh:
      	return
      }
      if r.ShouldResync == nil || r.ShouldResync() {
      	klog.V(4).Infof("%s: forcing resync", r.name)
      	if err := r.store.Resync(); err != nil {
          resyncerrc <- err
          return
      	}
      }
      cleanup()
      resyncCh, cleanup = r.resyncChan()
    }
}
```
å¦å¤–ï¼Œ*resync*åŠ¨ä½œæ˜¯`Reflector`ä¸­ä¸¤ä¸ªç¼“å­˜ç»„ä»¶`DeltaFIFO`å’Œ`Indexer`ä¹‹é—´çš„æ•°æ®åŒæ­¥ï¼Œ
åŒæ—¶ä¹Ÿæ­£å¦‚æˆ‘ä»¬åœ¨[Informer](#Informer)å°èŠ‚ä¸­æ‰€å¼ºè°ƒçš„é‚£æ ·ï¼Œ`Informer`æ˜¯ä¸€ä¸ªç»™è°ƒç”¨è€…å°è£…çš„ä¸€ä¸ª"å£³"ã€‚
å› æ­¤ï¼Œ`Reflector`çš„*resyncæœºåˆ¶*æ˜¯ä¸€ç§æ›´ä¸ºä¸¥è°¨çš„è¡¨è¿°ã€‚
:::

é‚£ä¹ˆä¸ºä»€ä¹ˆè¦å¼•å…¥*resyncæœºåˆ¶*å‘¢ï¼Ÿ
å®˜æ–¹å¼€å‘è€…è€ƒè™‘åˆ°å›è°ƒå‡½æ•°åœ¨å¤„ç†ï¼ˆæ¶ˆè´¹ï¼‰ä»`DeltaFIFO`é˜Ÿåˆ—ä¸­popå‡ºçš„äº‹ä»¶æ—¶ï¼Œå¯èƒ½ä¼šå­˜åœ¨å¤„ç†å¤±è´¥çš„æƒ…å†µï¼Œå¼•å…¥å®šæ—¶çš„resyncæœºåˆ¶è®©è¿™äº›å¤„ç†å¤±è´¥çš„äº‹ä»¶æœ‰äº†é‡æ–°è¢«å¤„ç†çš„æœºä¼šã€‚

é‚£ä¹ˆç»è¿‡resyncé‡æ–°æ”¾å…¥`DeltaFIFO`é˜Ÿåˆ—çš„äº‹ä»¶ï¼Œå’Œç›´æ¥ä»`kube-apiserver` ä¸­ç›‘å¬åˆ°çš„äº‹ä»¶æœ‰ä»€ä¹ˆä¸ä¸€æ ·å‘¢ï¼Ÿ
é¦–å…ˆï¼Œä¸åŒäº`kube-apiserver`ä¸­ç›‘å¬åˆ°çš„äº‹ä»¶ç±»å‹ï¼ˆ`Added`ï¼Œ`Updated`ï¼Œ`Deleted`ï¼‰ï¼Œå®ƒçš„ç±»å‹ä¸º`Sync`ã€‚

é™¤æ­¤ä»¥å¤–ï¼Œ`Sync`ç±»å‹çš„äº‹ä»¶åœ¨å‹å…¥`DeltaFIFO`æ—¶ï¼Œä¼šæ£€æŸ¥`DeltaFIFO`ä¸­è¯¥èµ„æºçš„äº‹ä»¶åˆ‡ç‰‡ï¼ˆ`[]Delta`ï¼‰æ­¤åˆ»æ˜¯å¦å·²ç»å«æœ‰äº‹ä»¶äº†ï¼ˆä¹Ÿå°±æ˜¯äº‹ä»¶åˆ‡ç‰‡é•¿åº¦å¤§äº0ï¼‰ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆåˆ™æ”¾å¼ƒè¿½åŠ ã€‚
å› ä¸º`DeltaFIFO`ä¸­çš„èµ„æºçš„æœ€æ–°äº‹ä»¶ï¼ˆå¯¹åº”çš„èµ„æºç‰ˆæœ¬ï¼‰ä¸€å®šæ¯”`resync`æœºåˆ¶é‡æ–°åŒæ­¥çš„èµ„æºç‰ˆæœ¬æ›´æ–°ã€‚

åœ¨`DeltaFIFO`çš„æ¶ˆè´¹ç«¯ï¼Œä¹Ÿå°±æ˜¯Controllerç»„ä»¶çš„`Process`å‡½æ•°ï¼Œå¯¹äº`Sync`ç±»å‹çš„å˜æ›´äº‹ä»¶ï¼Œè§¦å‘çš„æ˜¯`OnUpdate`å›è°ƒå‡½æ•°ã€‚

å½“ç„¶ï¼Œresyncæœºåˆ¶ä¹Ÿä¸å¯é¿å…åœ°ä¼šé€ æˆé‡å¤æ¶ˆè´¹çš„æƒ…å†µã€‚[ğŸŒ§ï¸](../intro#çº¦å®š)

[comment]: # (TODO: Resyncå‡½æ•°ä½“)
[comment]: # (TODO[figure]: è¡¥ä¸€å¼ resyncçš„reflectorå›¾)

## å°ç»“

:::tip
æˆ‘ä»¬ä»æ„æˆ`Informer`çš„åŸºæœ¬ç»„ä»¶è¯´èµ·ï¼Œæœ€ç»ˆæç»˜äº†`Informer`çš„æ•´ä½“ç»“æ„ã€‚

ç®€å•æ¥è¯´ï¼Œä½ å¯ä»¥æŠŠ`Informer`ç†è§£æˆä¸€ä¸ªç”±æŸä¸€èµ„æºç±»å‹çš„`List()`å’Œ`Watch()`å‡½æ•°é©±åŠ¨çš„æœ¬åœ°èµ„æºç¼“å­˜ï¼ŒåŒæ—¶å®ƒä¹Ÿæä¾›äº†é’ˆå¯¹èµ„æºå˜æ›´äº‹ä»¶çš„é€šçŸ¥åŠå¤„ç†æœºåˆ¶ï¼›

å¦å¤–ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ä¸åŒäºå…¶ä»–æŠ€æœ¯åšå®¢ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ä»‹ç»`workqueue`ã€‚
æ ¹æ®`Informer`çš„æºç ï¼Œå®ƒæœ¬èº«è¿è¡Œå¹¶ä¸éœ€è¦`workqueue`ç»„ä»¶ã€‚`client-go`ä¸­æä¾›çš„`workqueue`ä»…ä»…æ˜¯ä¸€ç§**å¢å¼º**ã€‚
å®ƒå¯ä»¥è¢«ä½¿ç”¨åœ¨æœ¬èŠ‚å™è¿°çš„"é’©å­å‡½æ•°"ä¸­ï¼Œç›¸æ¯”äºåœ¨"é’©å­å‡½æ•°"é‡Œ**ç›´æ¥**å¤„ç†å„ä¸ªäº‹ä»¶ï¼Œ
æˆ‘ä»¬å¯ä»¥åœ¨å„ä¸ª"é’©å­å‡½æ•°"é‡ŒæŠŠäº‹ä»¶å…ˆæš‚æ—¶æ”¾å…¥åˆ°`workqueue`ä¸­ï¼Œæˆ‘ä»¬å†å¦å¤–å¦ç»Ÿä¸€ä»`workqueue`ä¸­"æå–"å¹¶å¤„ç†è¿™äº›äº‹ä»¶ã€‚
`client-go`ä¸­å·²ç»ä¸ºæˆ‘ä»¬æä¾›äº†é€šç”¨é˜Ÿåˆ—ã€é™é€Ÿé˜Ÿåˆ—ã€å»¶æ—¶é˜Ÿåˆ—ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿™äº›å®˜æ–¹å¼€å‘è€…å®ç°é«˜æ•ˆä¸”å¯é å®‰å…¨çš„é˜Ÿåˆ—æ¥å¸®åŠ©æˆ‘ä»¬ç¼–å†™é«˜è´¨é‡çš„ç¨‹åºã€‚
ç”±äºæœ¬ä¹¦æœ€åå®ç°çš„æ§åˆ¶å™¨æä¸ºç²¾ç®€ï¼Œå¹¶æ²¡æœ‰å†åˆ©ç”¨`workqueue`å¢å¼ºï¼Œä¸ºäº†é™ä½è¯»è€…é˜…è¯»çš„è´Ÿæ‹…ï¼Œæˆ‘ä»¬ä¹Ÿä¸å†èµ˜è¿°`workqueue`ç»„ä»¶ã€‚
:::
[^1]: è¯·æ³¨æ„ï¼Œinformeræ¡†æ¶æœ¬èº«å¹¶ä¸æ˜¯åœ¨Kubernetes [v1.5.0](https://github.com/kubernetes/kubernetes/tree/v1.5.0)æ—¶æ‰æå‡ºã€‚åœ¨Kubernetes [v1.5.0](https://github.com/kubernetes/kubernetes/tree/v1.5.0)ä¹‹å‰ï¼Œ informeræ¡†æ¶è€¦åˆåœ¨Kubernetesæºç å†…ï¼ˆ`k8s.io/kubernetes/pkg/controller/framework/informers`ï¼‰ã€‚
      åœ¨Kubernetes [v1.4.0-alpha.3](https://github.com/kubernetes/kubernetes/tree/v1.4.0-alpha.3)ï¼ŒKubernetesç¤¾åŒºæ‰å¼€å§‹æœ‰äº†å•ç‹¬çš„å®¢æˆ·ç«¯åº“`client-go`ã€‚è€Œåœ¨Kubernetes [v1.5.0](https://github.com/kubernetes/kubernetes/tree/v1.5.0)æ—¶å®Œæˆäº†informeræ¡†æ¶åˆ°`client-go`çš„è¿ç§»ã€‚

      å…³äº`client-go`åº“çš„å†å²å¯ä»¥å‚è€ƒKubernetesçš„[Issue #28559](https://github.com/kubernetes/kubernetes/issues/28559)ã€‚

      å…³äºinformeræ¡†æ¶è¿å…¥`client-go`çš„å†å²å¯ä»¥å‚è€ƒclient-goçš„[Issue #4](https://github.com/kubernetes/client-go/issues/4)ä»¥åŠKubernetesçš„[Pull Request #32718](https://github.com/kubernetes/kubernetes/pull/32718)å’ŒKubernetesçš„[CHANGELOG v1.4.1-beta.2](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.4.md#v141-beta2)ä»¥åŠ[Pull Request #34989](https://github.com/kubernetes/kubernetes/pull/34989)å’ŒKubernetes [CHANGELOG v1.5.0-alpha.2](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.5.md#v150-alpha2)ã€‚

      å¦å¤–ï¼Œinformeræ¡†æ¶æœ¬èº«çš„å¼•å…¥æœ€æ—©å¯ä»¥è¿½æº¯åˆ°Kubernetesçš„[Issue #4877](https://github.com/kubernetes/kubernetes/issues/4877)ï¼Œå®˜æ–¹å¼€å‘è€…æåˆ°ï¼š
      > There are pitfalls when using the watch + list pattern. Many of our controllers use this pattern, and we expect many future pieces of code to use this pattern.
      > Therefore, we'd like to provide a framework/example which lets you fill out three functions (list, watch, and process) to get a shiny new bug-free (at least the list+watch part) controller.

      å¯è§informeræ¡†æ¶çš„æå‡ºæ˜¯ä¸ºäº†è§£å†³ä½¿ç”¨"`watch+list`æ¨¡å¼"ç¼–å†™æ§åˆ¶å™¨æ—¶å®¹æ˜“äº§ç”Ÿbugçš„é—®é¢˜ã€‚å®˜æ–¹å¼€å‘è€…å¸Œæœ›æä¾›ä¸€ä¸ªæ§åˆ¶å™¨æ¡†æ¶è®©ç¼–å†™æ§åˆ¶å™¨å˜å¾—ç®€å•å¹¶ä¸”ä¸æ˜“å‘ç”Ÿé”™è¯¯ã€‚
      æœ€ç»ˆï¼Œinformerçš„PR[Pull Request #5270](https://github.com/kubernetes/kubernetes/pull/5270)è¢«åˆå…¥Kubernetes [v0.15.0](https://github.com/kubernetes/kubernetes/tree/v0.15.0)ä¸­ã€‚

[^2]: æ­£æ–‡ä¸­ä¸ºäº†å‡è½»è¯»è€…é˜…è¯»è´Ÿæ‹…å’Œå™è¿°çš„è¿è´¯æ€§ï¼Œå¿½ç•¥äº†ä¸€äº›ç»†èŠ‚ï¼š

      å…¶ä¸­`ListAndWatch()`æ–¹æ³•é‡Œä¼šä½¿ç”¨åˆ°listerWatcher`æˆå‘˜å˜é‡ï¼Œè¿™ä¸ªæˆå‘˜å˜é‡çš„ç±»å‹æ˜¯ï¼š

      ```go title="k8s.io/client-go/tools/cache/listwatch.go"
      type ListWatch struct {
      	ListFunc  ListFunc
      	WatchFunc WatchFunc
      	// DisableChunking requests no chunking for this list watcher.
      	DisableChunking bool
      }
      ```
      å®ƒåŒ…å«ä¸¤ä¸ªå‡½æ•°ï¼š`ListFunc`æ˜¯å‘Kubernetes APIè·å–æŸä¸€èµ„æºç±»å‹èµ„æºé›†åˆçš„è¯·æ±‚å‡½æ•°ï¼›`WatchFunc`æ˜¯å‘Kubernetes APIç›‘æŸä¸€èµ„æºç±»å‹å˜æ›´äº‹ä»¶çš„è¯·æ±‚å‡½æ•°ã€‚
      è¿™ä¸¤ä¸ªå‡½æ•°åœ¨åˆ›å»º`Reflector`æ—¶é€šè¿‡å‚æ•°ä¼ å…¥ï¼š
      ```go
      r := NewReflector(
      // ...
      listerWatcher: &ListWatch{ListFunc: ..., WatchFunc: ...}
      // other parameters are ignored.
      )
      ```
      `Reflector`çš„`ListAndWatch()`æ–¹æ³•åˆ™é€šè¿‡`r.listerWatcher.List()`ä»¥åŠ`r.listerWatcher.Watch()`æ¥è§¦å‘è°ƒç”¨ä¼ å…¥çš„è¯·æ±‚å‡½æ•°ã€‚


