---
sidebar_position: 3
---

import ReflectorSimplePNG from '@site/static/img/reflector-simple.png';
import DeltaFIFOPNG from '@site/static/img/deltafifo.png';
import IndexerPNG from '@site/static/img/indexer.png';

import DeltaPNG from '@site/static/img/delta.png';
import ReflectorPNG from '@site/static/img/reflector.png';
import ControllerPNG from '@site/static/img/controller.png';
import InformerPNG from '@site/static/img/informer.png';

import GitHubSVG from '@site/static/img/github-mark.svg';


# informer is all you need

åœ¨å‰é¢[Controller](./controller)å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»¥ä¼˜åŒ–æ§åˆ¶å™¨ä¸ºçº¿ç´¢æ­£å¼å¼•å…¥äº†`client-go`ä¸­çš„`Informer`ç»„ä»¶ã€‚
`Informer`æœ¬è´¨ä¸Šæ˜¯ä¸€ç§æœ¬åœ°èµ„æºç¼“å­˜æœºåˆ¶ï¼Œæ—¨åœ¨ä¸é›†ç¾¤çš„`etcd`åŒæ­¥ã€‚å› æ­¤ï¼Œå®ƒè¢«å®šä¹‰åœ¨`k8s.io/client-go/tools/cache`åŒ…ä¸­ã€‚

:::tip æ³¨
åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸å‡†å¤‡å¸¦è¯»è€…è¿›è¡Œ`Informer`çš„ä»£ç èµ°è¯»ã€‚`Informer`ä¸ºäº†å¯é å’Œé«˜æ•ˆåœ¨å®ç°ä¸Šè¿œæ¯”æˆ‘ä»¬æƒ³è±¡çš„å¤æ‚ã€‚
ä¸ºäº†ä¾¿äºè®©è¯»è€…ç†è§£`Informer`çš„ä¸»è¦é€»è¾‘ï¼Œ
æœ¬èŠ‚çš„å†…å®¹åŸºäº`client-go` [v1.5.0](https://github.com/kubernetes/client-go/tree/v1.5.0)â€”â€”è¿™æ˜¯`client-go`åº“æ­£å¼å¼•å…¥`Informer`æ¡†æ¶çš„æœ€åˆç‰ˆæœ¬[^1]ï¼Œå®ƒä¸ç°åœ¨è¶‹äºç¨³å®šçš„ç‰ˆæœ¬å·²ç»æ¥è¿‘ï¼ŒåŒæ—¶åˆç›¸å¯¹ç²¾ç®€ï¼Œæ˜¯æˆ‘ä»¬äº†è§£informeræ¡†æ¶éå¸¸å¥½çš„ææ–™ã€‚
:::

ç”±äº`Informer`ç»„ä»¶ä¼—å¤šï¼Œåœ¨æ­£å¼ä»‹ç»`Informer`ä¹‹å‰ï¼Œæˆ‘ä»¬ä¼šå…ˆä»ä»‹ç»æ„æˆ`Informer`çš„ç»„ä»¶å¼€å§‹è®²èµ·ã€‚

## Reflectorç»„ä»¶

`Reflector`æ˜¯æ„æˆ`Informer`æ¡†æ¶çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæœ€ä¸»è¦ä½œç”¨æ˜¯ç›‘å¬èµ„æºçš„å˜æ›´ã€‚


<img src={ReflectorSimplePNG} width="280px"/>

:::tip `Reflector`ç»„ä»¶çš„å†å²
`Reflector`çš„å‡ºç°ç”šè‡³è¦æ—©äº`Informer`æœ¬èº«ï¼Œ`Reflector`çš„æ¦‚å¿µåœ¨[<GitHubSVG /> Pull Request #758](https://github.com/kubernetes/kubernetes/pull/758)æ—¶å¼•å…¥ã€‚
å®˜æ–¹å¼€å‘è€…è¿™æ ·æè¿°`Reflector`ï¼š
> Reflector watches a specified resource and causes all changes to be reflected in the given store.

æ„æ€æ˜¯è¯´ï¼Œ`Reflector`ç›‘å¬æŒ‡å®šçš„èµ„æºç±»å‹å¹¶ä½¿æ‰€æœ‰çš„å˜æ›´äº‹ä»¶**åæ˜ **åˆ°æŒ‡å®šçš„å­˜å‚¨ï¼ˆç¼“å­˜ï¼‰ä¸­ã€‚è¿™å°±æ˜¯`Reflector`åç§°çš„ç”±æ¥ã€‚
å…³äº"æŒ‡å®šçš„å­˜å‚¨ï¼ˆç¼“å­˜ï¼‰"æˆ‘ä»¬åœ¨æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜ä¼šè¯¦ç»†ä»‹ç»ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åªæƒ³å‘Šè¯‰ä½ `Reflector`çš„ç”±æ¥ã€‚

:::

ä¸è¿‡ï¼Œ`Reflector`æœ¬èº«å¹¶ä¸å«æœ‰ä»»ä½•ç”¨äºç›‘å¬çš„ç»„ä»¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åˆ›å»º`Reflector`æ—¶ï¼Œç”±è°ƒç”¨è€…ä¼ å…¥"ç›‘å¬é€»è¾‘"ï¼Œ`Reflector`å¸®åŠ©æˆ‘ä»¬æ‰§è¡Œç›‘å¬ã€‚
ä¸ºäº†ä¾¿äºè¯´æ˜ï¼Œæˆ‘ä»¬ä»¥`Reflector`çš„åˆå§‹åŒ–å‡½æ•°ä½œä¸ºå¯¹ç…§ï¼š
```go
func NewReflector(
     // highlight-next-line
     lw ListerWatcher,
     expectedType interface{},
     store Store,
     resyncPeriod time.Duration) *Reflector {
	// ...
}
```
æˆ‘ä»¬å…ˆå¿½ç•¥åˆ›å»º`Reflector`çš„å…¶ä»–ä¸‰ä¸ªå‚æ•°ï¼Œä»…å…³æ³¨`lw`è¿™ä¸ªå‚æ•°ï¼Œå®ƒå°±æ˜¯éœ€è¦ç”±è°ƒç”¨è€…æä¾›çš„"ç›‘å¬é€»è¾‘"ã€‚å®ƒçš„ç±»å‹æ˜¯`ListerWatcher`ï¼š
```go
type ListerWatcher interface {
	List(options api.ListOptions) (runtime.Object, error)
	Watch(options api.ListOptions) (watch.Interface, error)
}
```
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`ListerWatcher`åŒ…å«ä¸€ä¸ª`Watch()`æ–¹æ³•â€”â€”è¿™å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„è°ƒç”¨è€…éœ€è¦æä¾›çš„"ç›‘å¬é€»è¾‘"ã€‚
é™¤æ­¤ä»¥å¤–ï¼Œ`ListerWatcher`è¿˜åŒ…æ‹¬ä¸€ä¸ª`List()`æ–¹æ³•ç”¨äºè·å–èµ„æºé›†åˆâ€”â€”åœ¨è¿™é‡Œæˆ‘ä»¬å…ˆæš‚ä¸”ä¸è¯´æ˜éœ€è¦å®ƒçš„åŸå› ï¼Œæ­¤åˆ»æˆ‘ä»¬è¿˜æ²¡æœ‰ä»‹ç»`Reflector`ç»„ä»¶æ•´ä½“çš„è¿è¡Œé€»è¾‘ï¼Œè´¸ç„¶çš„è§£é‡Šæˆ–è®¸åªä¼šè®©ä½ æ›´åŠ ç–‘æƒ‘ã€‚


`client-go`ä¸­ä»»ä½•ä¸€ä¸ª[*èµ„æºå®¢æˆ·ç«¯*](./restclient#èµ„æºå®¢æˆ·ç«¯)å…¶å®éƒ½"æ»¡è¶³"è¿™ä¸ªæ¥å£ã€‚ä¾‹å¦‚ï¼Œ`pods`èµ„æºå®¢æˆ·ç«¯ï¼š
```go title="k8s.io/client-go/kubernetes/typed/core/v1/pod.go"
type PodInterface interface {
	Create(*v1.Pod) (*v1.Pod, error)
	Update(*v1.Pod) (*v1.Pod, error)
	UpdateStatus(*v1.Pod) (*v1.Pod, error)
	Delete(name string, options *v1.DeleteOptions) error
	DeleteCollection(options *v1.DeleteOptions, listOptions v1.ListOptions) error
	Get(name string) (*v1.Pod, error)
	// highlight-next-line
	List(opts v1.ListOptions) (*v1.PodList, error)
	// highlight-next-line
	Watch(opts v1.ListOptions) (watch.Interface, error)
	Patch(name string, pt api.PatchType, data []byte, subresources ...string) (result *v1.Pod, err error)
	// ...
}
```
:::tip æ³¨
å…¶å®ï¼Œç«™åœ¨Goè¯­æ³•çš„è§’åº¦ï¼Œ*èµ„æºå®¢æˆ·ç«¯*å¹¶æ²¡æœ‰çœŸæ­£æ„ä¹‰ä¸Šå®ç°`ListerWatcher`æ¥å£ã€‚æˆ‘ä»¬ä»¥ä¸Šè¿°Podèµ„æºå®¢æˆ·ç«¯ä¸ºä¾‹ï¼Œè¯·æ³¨æ„å®ƒçš„`List()`æ–¹æ³•çš„è¿”å›ç±»å‹ä¸Šä¸`ListerWatcher`çš„ç»†å¾®å·®åˆ«ï¼šPodèµ„æºå®¢æˆ·ç«¯çš„`List()`è¿”å›ç±»å‹æ˜¯**`*v1.PodList`**ã€‚
åœ¨Goè¯­è¨€ä¸­ï¼Œ`List(opts v1.ListOptions) (*v1.PodList, error)`å¹¶ä¸ç­‰åŒäºå®ç°äº†`ListerWatcher`çš„`List(options api.ListOptions) (runtime.Object, error)`
æ–¹æ³•ï¼Œå°½ç®¡`*v1.PodList`ç±»å®ç°äº†`runtime.Object`æ¥å£ã€‚

```go
// âŒ can not compile
var _ ListerWatcher = clientset.Core().Pods("default")
```



å½“ç„¶ï¼Œè¿™æ¶‰åŠåˆ°Goè¯­æ³•æœ¬èº«çš„å†…å®¹ï¼Œä¸åœ¨æˆ‘ä»¬çš„è®¨è®ºèŒƒå›´ä¹‹å†…ã€‚




æˆ‘ä»¬é€šå¸¸åœ¨åˆ›å»º`ListerWatcher`ç±»æ—¶ï¼Œå…¶å®æˆ‘ä»¬åªéœ€è¦å€ŸåŠ©`client-go`ä¸ºæˆ‘ä»¬é¢„å…ˆå‡†å¤‡å¥½çš„`cache.ListWatch`[^2]ç±»å‹å†ç¨åŠ ç»“åˆ*èµ„æºå®¢æˆ·ç«¯*æœ¬èº«å°±å¯ä»¥å¿«æ·åœ°åˆ›å»ºå‡ºä¸€ä¸ª`ListerWatcher`å¯¹è±¡ã€‚ä¾‹å¦‚ï¼š

```go
lw := cache.ListWatch{
		ListFunc: func(options api.ListOptions) (runtime.Object, error) {
			return clientset.Core().Pods("default").List(options)
		},
		WatchFunc: func(options api.ListOptions) (watch.Interface, error) {
			return clientset.Core().Pods("default").Watch(options)
		},
}

// âœ… can compile
var _ ListerWatcher = lw

```
:::


é™¤äº†"ç›‘å¬é€»è¾‘"ä»¥å¤–ï¼Œ`Reflector`ä¸­è¿˜åŒ…æ‹¬ä¸¤ä¸ª**ç¼“å­˜**ç»„ä»¶ï¼š`DeltaFIFO`ä»¥åŠ`Indexer`ã€‚å…¶ä¸­ï¼š

* `Indexer`ç¼“å­˜ä¹Ÿéœ€è¦åœ¨åˆ›å»º`Reflector`æ—¶ç”±è°ƒç”¨è€…ä¼ å…¥;
* `DeltaFIFO`ç¼“å­˜åˆ™æ˜¯åœ¨`Reflector`å†…è¢«åˆ›å»ºã€‚


### DeltaFIFO

`DeltaFIFO`ä¸­çš„"Delta"å¯ä»¥ç†è§£ä¸º"å˜æ›´"ï¼Œå®ƒç”¨äºä¿å­˜è¢«ç›‘å¬èµ„æºçš„æ¯ä¸€ä¸ªå˜æ›´äº‹ä»¶ï¼ˆä¾‹å¦‚`Added`ï¼Œ`Updated`ï¼Œ`Deleted`ï¼‰ã€‚
"FIFO" è¡¨ç¤ºåŒæ—¶å®ƒä¹Ÿæ˜¯ä¸€ä¸ªå…ˆå…¥å…ˆå‡ºé˜Ÿåˆ—ã€‚ä¿å­˜å…¶å®å°±æ˜¯"å…¥é˜Ÿ"çš„è¿‡ç¨‹ã€‚

`DeltaFIFO`ä¸­çš„åŸºæœ¬å•å…ƒ"å˜æ›´"`Delta`çš„å®šä¹‰ä¸ºï¼š
```go title="k8s.io/client-go/tools/cache/delta_fifo.go"
type Delta struct {
	Type   DeltaType
	Object interface{}
}
```
å®ƒåŒ…æ‹¬å…·ä½“çš„å˜æ›´ç±»å‹ï¼ˆ`Added`ï¼Œ`Updated`ï¼Œ`Deleted`ï¼‰ä»¥åŠå˜æ›´åçš„èµ„æºå¯¹è±¡æœ¬èº«ã€‚

<img src={DeltaPNG}  style= {{width: "50%"}}/>


æ³¨æ„ï¼Œé˜Ÿåˆ—æœ¬èº«çš„ç²’åº¦æ˜¯èµ„æºï¼Œè€Œéäº‹ä»¶ã€‚æ¯ä¸ªèµ„æºå¯¹åº”ä¸€ä¸ªä¿å­˜æœ¬èµ„æºå˜æ›´äº‹ä»¶çš„åˆ‡ç‰‡ï¼ˆ`[]Delta`ï¼‰ã€‚
æ„æ€æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬ä»è¿™ä¸ªé˜Ÿåˆ—popå‡ºä¸€é¡¹æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°çš„æ˜¯æŸä¸ªèµ„æºå¯¹åº”çš„å½“å‰æ‰€æœ‰å˜æ›´äº‹ä»¶çš„**åºåˆ—**ã€‚

ä¸‹å›¾å¤§è‡´æ€»ç»“äº†`DeltaFIFO`çš„å†…éƒ¨ç»“æ„ï¼š

<img src={DeltaFIFOPNG} style= {{width: "80%"}}/>

å…¶ä¸­`queue`ç»“æ„æ˜¯é˜Ÿåˆ—çš„æœ¬ä½“ï¼Œè€Œ`items`ç»“æ„åˆ™ç”¨äºè¾…åŠ©ä¿å­˜æ¯ä¸ªèµ„æºå¯¹åº”å˜æ›´äº‹ä»¶åˆ‡ç‰‡ã€‚

:::tip `DeltaFIFO`çš„å†å²

åœ¨æœ€åˆç‰ˆæœ¬çš„`Reflector`ä¸­ï¼Œå…¶å®å¹¶ä¸åŒ…å«`DeltaFIFO`ç»„ä»¶ï¼Œ`Reflector`ä¼šæŠŠç›‘å¬åˆ°çš„èµ„æºå˜æ›´äº‹ä»¶**ç›´æ¥**"åæ˜ "åˆ°æŒ‡å®šèµ„æºç¼“å­˜ã€‚
`DeltaFIFO`çš„å†å²æœ€æ—©å¯ä»¥è¿½æº¯åˆ°[<GitHubSVG /> Pull Request #5437](https://github.com/kubernetes/kubernetes/pull/5473)ã€‚
å®ƒä½œä¸ºä½œè€…å°†è¦å¼•å…¥çš„`Informer`æ¡†æ¶çš„ä¸€éƒ¨åˆ†è€Œè¢«å¼•å…¥ã€‚

åœ¨è¯¥PRä¸­ï¼Œæ ¹æ®ä½œè€…å¯¹`DeltaFIFO`çš„æ³¨é‡Šï¼š


> DeltaFIFO is a producer-consumer queue, where a Reflector is
> indended to be the producer, and the consumer is whatever calls
> the Pop() method.
>
> DeltaFIFO solves this use case:
> * You want to process every object change (delta) at most once.
> * When you process an object, you want to see everything
>   that's happened to it since you last processed it.
> * You want to process the deletion of objects.
> * You might want to periodically reprocess objects.

å¯ä»¥çœ‹å‡º`DeltaFIFO`è®¾è®¡ä¹‹åˆå°±æœ‰æ„è¯†åœ°ä»¥èµ„æºä½œä¸ºé˜Ÿåˆ—"ç²’åº¦"â€”â€”ä»¥ä¾¿åœ¨å¤„ç†ä¸€ä¸ªèµ„æºæ—¶ï¼ˆä»é˜Ÿåˆ—ä¸­popå‡ºä¸€é¡¹ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°è‡ªä»ä¸Šä¸€æ¬¡å¤„ç†å®ƒæ—¶**æ‰€æœ‰**çš„å˜æ›´äº‹ä»¶ã€‚
å¦å¤–ï¼Œä¸€ä¸ªå€¼å¾—æ³¨æ„çš„ç»†èŠ‚æ˜¯ï¼Œä½œè€…åœ¨è®¾è®¡`DeltaFIFO`ä¼Šå§‹å°±æœ‰æ„è¯†åœ°è®©è¿™ä¸ªç»“æ„å¯ä»¥**é˜¶æ®µæ€§åœ°é‡æ–°å¤„ç†æ‰€æœ‰äº‹ä»¶**ã€‚è¿™ä¸ª"é˜¶æ®µæ€§åœ°é‡æ–°å¤„ç†"æˆ‘ä»¬è¿˜ä¼šåœ¨åç»­[Reflectorçš„resyncæœºåˆ¶](#reflectorçš„resyncæœºåˆ¶)ä¸­è¯¦ç»†ä»‹ç»ã€‚
:::


### Indexer

`Indexer`åˆ™æ˜¯çœŸæ­£çš„æœ¬åœ°èµ„æºç¼“å­˜â€”â€”å®ƒä¿å­˜çš„å¹¶ä¸æ˜¯èµ„æºå˜æ›´äº‹ä»¶ï¼Œè€Œæ˜¯èµ„æºå¯¹è±¡æœ¬èº«ã€‚
å¦å¤–æˆ‘ä»¬ä»å®ƒçš„åå­—â€”â€”*ç´¢å¼•å™¨*å¯ä»¥çœ‹å‡ºå®ƒæ›´ä¾§é‡äºå¯¹æœ¬åœ°ç¼“å­˜èµ„æºçš„ç´¢å¼•èƒ½åŠ›ã€‚
*ç´¢å¼•å™¨*æ”¯æŒè‡ªå®šä¹‰æ·»åŠ ç´¢å¼•é€»è¾‘ï¼ˆå‡½æ•°ï¼‰ï¼Œä»¥è®©ç´¢å¼•å™¨å¯ä»¥æ ¹æ®ä¸åŒæ¡ä»¶æ£€ç´¢èµ„æºã€‚

:::tip
å¦‚ä½•å‘*ç´¢å¼•å™¨*æ·»åŠ ç´¢å¼•é€»è¾‘ä¸åœ¨æœ¬ä¹¦çš„è®¨è®ºèŒƒå›´ä¹‹å†…ã€‚`Indexer`å·²ç»å†…ç½®äº†ä¸€ä¸ªåä¸º`MetaNamespaceIndexFunc`çš„ç´¢å¼•å‡½æ•°ï¼Œå› æ­¤ï¼Œ`Indexer`é»˜è®¤å¯ä»¥æŒ‰ç…§å‘½åä¸ºç©ºé—´æ¥æ£€ç´¢èµ„æºã€‚
:::

ä¸‹å›¾å¤§è‡´æ€»ç»“äº†`Indexer`çš„å†…éƒ¨ç»“æ„ï¼š

<img src={IndexerPNG} style= {{width: "100%"}}/>

å…¶ä¸­`indexes`ç»“æ„ç”¨äºä¿å­˜ç´¢å¼•å‡½æ•°ï¼Œ`indices`ç»“æ„ä¿å­˜åˆ™æ˜¯ç´¢å¼•å‡½æ•°å»ºç«‹çš„ç´¢å¼•ï¼Œ`items`ç»“æ„ä¿å­˜çš„æ‰æ˜¯èµ„æºå¯¹è±¡ã€‚

### Reflectorçš„è¿è½¬

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»æŠŠæ„æˆ`Reflector`çš„æ¨¡å—ä»‹ç»å®Œæ¯•ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä»‹ç»`Reflector`è¿™äº›æ¨¡å—ä¹‹é—´æ˜¯å¦‚ä½•äº§ç”Ÿè”ç³»çš„ã€‚

`Reflector`ç»„ä»¶é€šè¿‡`Run()`æ–¹æ³•å¼€å¯è¿è½¬ï¼Œ`Run()`å‡½æ•°çš„ä¸»ä½“æ˜¯æ‰§è¡Œ`ListAndWatch()`æ–¹æ³•ï¼š
```go title="k8s.io/client-go/tools/cache/reflector.go"
func (r *Reflector) Run(stopCh <-chan struct{}) {
	wait.BackoffUntil(func() {
	    // highlight-next-line
		if err := r.ListAndWatch(stopCh); err != nil {
			r.watchErrorHandler(r, err)
		}
	}, r.backoffManager, true, stopCh)
}
```
è€Œ`ListAndWatch()`æ–¹æ³•ä¸­åˆ™ä¼šä½¿ç”¨ä¼ å…¥çš„`ListerWatcher`ç»“æ„`lw`ã€‚
å…·ä½“æ¥è¯´ï¼Œåœ¨`ListAndWatch()`æ–¹æ³•ä¸­ï¼š
1. `lw`çš„`List()`ä¼šè¢«é¦–å…ˆæ‰§è¡Œå¹¶ä¸”å®ƒ**ä»…è¢«æ‰§è¡Œä¸€æ¬¡**ï¼Œç”¨äºå…ˆä¸€æ¬¡æ€§è·å–æ‰€æœ‰èµ„æºé›†åˆï¼Œå¾—åˆ°çš„ç»“æœå°†å­˜å…¥`Indexer`ç¼“å­˜ä¸­ï¼›
2. ä¹‹åé€šè¿‡è°ƒç”¨`lw`çš„`Watch()`å‡½æ•°**æŒç»­**è·å–èµ„æºçš„å˜æ›´äº‹ä»¶å¹¶å°†ç»“æœå‹å…¥`DeltaFIFO`ç¼“å­˜ä¸­ã€‚

:::tip æ³¨
æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠ`Reflector`çš„`ListAndWatch()`æ–¹æ³•ç†è§£æˆ`DeltaFIFO`çš„"ç”Ÿäº§è€…"ã€‚
:::

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`Reflector`ç»„ä»¶é€šè¿‡`Run()`å‡½æ•°å¯åŠ¨ä¹‹åï¼Œ`DeltaFIFO`ç¼“å­˜å¼€å§‹æŒç»­ä¸æ–­åŠ å…¥å˜æ›´äº‹ä»¶ã€‚è€Œå¦ä¸€ä¸ª`Indexer`ç¼“å­˜åœ¨ä¸€æ¬¡æ€§è·å¾—èµ„æºé›†åˆåå°±æ²¡æœ‰å†å˜åŠ¨äº†ã€‚
`Indexer`ç¼“å­˜ä¹‹åçš„å¢ã€åˆ ã€æ”¹åˆ™ä¾èµ–å¦ä¸€ä¸ªå«åš[`Controller`](#controllerç»„ä»¶)çš„ç»„ä»¶é©±åŠ¨ã€‚

<img src={ReflectorPNG} style= {{height: "280px"}}/>




## Controllerç»„ä»¶
:::tip æ³¨
æ³¨æ„æœ¬å°èŠ‚çš„`Controller`å¹¶ä¸æ˜¯æˆ‘ä»¬ä¸Šä¸€èŠ‚æ‰€è¯´çš„*Kubernetesæ§åˆ¶å™¨*ï¼Œæœ¬èŠ‚çš„`Controller`ä»…æ˜¯`client-go`ä¸­çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œä¹Ÿæ˜¯æ„æˆ`Informer`çš„ç›´æ¥ç»„ä»¶ã€‚
:::

åœ¨ç»“æ„ä¸Šï¼Œä¸Šæ–‡ä»‹ç»çš„`Reflector`å…¶å®æ˜¯`Controller`ç»„ä»¶å†…çš„ä¸€ä¸ªæ¨¡å—ã€‚å¹¶ä¸”`Controller`ç»„ä»¶å°±æ˜¯`DeltaFIFO`çš„"æ¶ˆè´¹è€…"ã€‚
ä¸‹é¢æˆ‘ä»¬å°†é€šè¿‡`Controller`çš„è¿è½¬é€»è¾‘æ¥ä»‹ç»`Controller`æ˜¯å¦‚ä½•æ¶ˆè´¹``DeltaFIFO`é˜Ÿåˆ—çš„ã€‚

`Controller`é€šè¿‡`Run()`æ–¹æ³•å¼€å¯è¿è½¬ï¼š
```go title="k8s.io/client-go/tools/cache/controller.go"
func (c *controller) Run(stopCh <-chan struct{}) {
   // ...
	wait.Until(c.processLoop, time.Second, stopCh)
	wg.Wait()
}
```
`Run()`å‡½æ•°çš„ä¸»ä½“æ˜¯`processLoop()`å‡½æ•°ï¼Œå®ƒç›´æ¥è´Ÿè´£æŒç»­é©±åŠ¨ç»„ä»¶çš„è¿è½¬ã€‚

`Controller`çš„`processLoop()`æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼Œé€»è¾‘éå¸¸ç®€å•ï¼š
```go title="k8s.io/client-go/tools/cache/controller.go"
func (c *controller) processLoop() {
	for {
	    // highlight-next-line
		obj, err := c.config.Queue.Pop(PopProcessFunc(c.config.Process))
		if err != nil {
			if err == ErrFIFOClosed {
				return
			}
			if c.config.RetryOnError {
				c.config.Queue.AddIfNotPresent(obj)
			}
		}
	}
}
```
å®ƒä¼šæŒç»­ä¸æ–­ï¼ˆ`for`å¾ªç¯ï¼‰ä»`Reflector`å­ç»„ä»¶çš„`DeltaFIFO`é˜Ÿåˆ—ï¼ˆ`c.config.Queue`ï¼‰ä¸­popå‡ºä¸€é¡¹ï¼ˆå³æŸèµ„æºçš„**å®Œæ•´**å˜æ›´äº‹ä»¶åˆ‡ç‰‡`Deltas`ï¼‰ï¼ŒåŒæ—¶äº¤ç”±`Controller`çš„`Process`å‡½æ•°ï¼ˆä¸Šè¿°ä»£ç çš„`c.config.Process`ï¼‰å¤„ç†ï¼Œ`Process`å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š
```go title="k8s.io/client-go/tools/cache/controller.go"
func(obj interface{}) error {
  // from oldest to newest
  for _, d := range obj.(Deltas) {
    // ...
  	switch d.Type {
  	// highlight-next-line
  	case Synced, Added, Updated:
  	  if old, exists, err := clientState.Get(obj); err == nil && exists {
  	  	if err := clientState.Update(obj); err != nil {
  	  	  return err
  	  	}
  	  	h.OnUpdate(old, obj)
  	  } else {
  	  	if err := clientState.Add(obj); err != nil {
  	  	  return err
  	  	}
  	  	h.OnAdd(obj)
  	  }
  	// highlight-next-line
  	case Deleted:
  	  if err := clientState.Delete(obj); err != nil {
  	  	return err
  	  }
  	  h.OnDelete(obj)
  	}
  }
  return nil
}
```
`Process`å‡½æ•°ä»¥ä¸€ä¸ªèµ„æºå®Œæ•´çš„å˜æ›´äº‹ä»¶åˆ‡ç‰‡ï¼ˆ`Deltas`ï¼‰ä¸ºè¾“å…¥ï¼š

1. é’ˆå¯¹èµ„æºçš„æ¯ä¸ªå˜æ›´äº‹ä»¶ï¼ˆ`for`å¾ªç¯ï¼‰ï¼Œæ ¹æ®ç±»å‹ï¼ˆ`witch`è¯­å¥ï¼‰ï¼Œè§¦å‘ç›¸åº”çš„"å›è°ƒå‡½æ•°"ï¼š`OnUpdate()`ï¼Œ`OnUpdate()`ï¼Œ`OnDelete()`â€”â€”è¿™äº›"å›è°ƒå‡½æ•°"åœ¨åˆ›å»º`Controller`ç»„ä»¶æ—¶ä¼ å…¥ã€‚
   **å®ƒä»¬å®é™…å¯ä»¥è®¤ä¸ºæ˜¯`Controller`å¯¹å¤–æä¾›çš„èµ„æºå˜æ›´äº‹ä»¶çš„é€šçŸ¥åŠå¤„ç†æœºåˆ¶**ï¼›
   :::tip æ³¨
   è¯·æš‚æ—¶å¿½ç•¥ä»£ç ä¸­å‡ºç°çš„`Synced`äº‹ä»¶ç±»å‹ï¼Œä»Kubernetes API Serverä¸­è¿”å›çš„èµ„æºå˜æ›´äº‹ä»¶ä»…æœ‰`Added`ï¼Œ`Updated`ï¼Œ`Deleted` è¿™ä¸‰ç§ã€‚æˆ‘ä»¬åœ¨åç»­[Reflectorçš„resyncæœºåˆ¶](#reflectorçš„resyncæœºåˆ¶)ä¼šä»‹ç»`Synced`äº‹ä»¶ç±»å‹çš„äº§ç”Ÿã€‚
   :::
2. é’ˆå¯¹èµ„æºçš„æ¯ä¸ªå˜æ›´äº‹ä»¶ï¼Œæ ¹æ®ç±»å‹ï¼Œè°ƒç”¨`Reflector`çš„`Indexer`ç´¢å¼•ç¼“å­˜å­ç»„ä»¶ï¼ˆåœ¨ä¸Šè¿°ä»£ç ä¸­å¯¹åº”`clientState`ï¼‰çš„ç›¸åº”æ–¹æ³•æ›´æ–°ï¼ˆ`Update()`ï¼‰ã€æ–°å¢ï¼ˆ`Add()`ï¼‰ã€åˆ é™¤ï¼ˆ`Delete()`ï¼‰ç›¸åº”èµ„æºâ€”â€”å› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®¤ä¸ºåœ¨`Controller`çš„é©±åŠ¨ä¸‹ï¼Œ**`Indexer`ç¼“å­˜æ‰å¼€å§‹çœŸæ­£æˆä¸º"åæ˜ "`etcd`çš„æœ¬åœ°ç¼“å­˜**ã€‚

<img src={ControllerPNG} style={{height: "460px"}}/>

è‡³æ­¤ï¼Œæˆ‘ä»¬å‘ç°`Controller`ç»„ä»¶ä¼¼ä¹å·²ç»å®Œå…¨å¥‘åˆæˆ‘ä»¬ä¹‹å‰[watchæœºåˆ¶åˆ°Informer](./controller#ä»watchæœºåˆ¶åˆ°informer)å°èŠ‚ä¸­å¯¹Kubernetesæ§åˆ¶å™¨çš„ä¸¤ä¸ªè¦æ±‚ã€‚

> 1. èµ„æºå˜æ›´äº‹ä»¶çš„é€šçŸ¥ï¼›
> 2. èµ„æºçš„æœ¬åœ°ç¼“å­˜ã€‚


:::tip `Controller`ç»„ä»¶çš„å†å²

`Controller`çš„å‡ºç°è¦æ—©äº`Informer`ã€‚
`Controller`æœ€æ—©å¯ä»¥è¿½æº¯åˆ°[<GitHubSVG /> Issue #4877](https://github.com/kubernetes/kubernetes/issues/4877)ï¼Œä½œè€…æåˆ°ï¼š
> There are pitfalls when using the watch + list pattern. Many of our controllers use this pattern, and we expect many future pieces of code to use this pattern.
> Therefore, we'd like to provide a framework/example which lets you fill out three functions (list, watch, and process) to get a shiny new bug-free (at least the list+watch part) controller.

å¯è§`Controller`çš„æå‡ºæ˜¯ä¸ºäº†è§£å†³ä½¿ç”¨"`watch+list`æ¨¡å¼"ç¼–å†™æ§åˆ¶å™¨æ—¶å®¹æ˜“äº§ç”Ÿbugçš„é—®é¢˜ã€‚å®˜æ–¹å¼€å‘è€…å¸Œæœ›æä¾›ä¸€ä¸ªæ§åˆ¶å™¨æ¡†æ¶è®©ç¼–å†™æ§åˆ¶å™¨å˜å¾—ç®€å•å¹¶ä¸”ä¸æ˜“å‘ç”Ÿé”™è¯¯ã€‚
æœ€ç»ˆï¼Œ`Controller`çš„PR[<GitHubSVG /> Pull Request #5270](https://github.com/kubernetes/kubernetes/pull/5270)è¢«åˆå…¥[Kubernetes v0.15.0](https://github.com/kubernetes/kubernetes/tree/v0.15.0)ä¸­ã€‚
:::

é‚£ä¹ˆæˆ‘ä»¬æ‰€è¯´çš„`Informer`ç»„ä»¶åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

## Informer

`Informer`åŒ…å«äº†ä¸€ä¸ª`Controller`ç»„ä»¶ã€‚é™¤å»`Controller`æœ¬èº«ï¼Œ`Informer`æœ¬èº«å¹¶ä¸å«æœ‰ä»»ä½•å®è´¨æ€§çš„ç»„ä»¶æˆ–è€…é©±åŠ¨ç»„ä»¶è¿è¡Œçš„æ¨¡å—ã€‚


`Informer`çš„ä½œç”¨åƒæ˜¯ä¸€ä¸ªä¸“é—¨ç»™è°ƒç”¨è€…å°è£…çš„ç®€å•æ˜“ç”¨çš„äº¤äº’"å£³"ï¼Œå®ƒè´Ÿè´£ï¼š

1. ä¼ å…¥`Controller`ç»„ä»¶æ‰€éœ€è¦çš„ï¼š
    * "å›è°ƒå‡½æ•°"â€”â€”åœ¨ä»£ç ä¸­å¯¹åº”çš„å°è£…ç±»å‹ä¸º`ResourceEventHandlerFuncs`
    * `Reflector`å­ç»„ä»¶çš„`ListerWatcher`ç»“æ„ï¼›
2. åˆå§‹åŒ–`Controller`ç»„ä»¶ï¼›
3. å¹¶ä¸”å‘è°ƒç”¨è€…è¿”å›ï¼š
    1. `Controller`ç»„ä»¶çš„**å¼•ç”¨**ä»¥ä¾¿è°ƒç”¨è€…å¯ä»¥æ§åˆ¶å®ƒçš„å¯åœ;
    2. `Reflector`å­ç»„ä»¶çš„`Indexer`ç¼“å­˜çš„**å¼•ç”¨**ä»¥ä¾¿è°ƒç”¨è€…å¯ä»¥ç”¨å®ƒæ£€ç´¢èµ„æºã€‚

:::tip
åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ç»™å‡º`Informer`çš„åˆ›å»ºå‡½æ•°çš„æºç ä½œä¸ºå‚ç…§ã€‚åŸå› æ˜¯ç”±äºæ‰€å«ç»„ä»¶ä¼—å¤šï¼Œ`Informer`åˆå§‹åŒ–å‡½æ•°æœ¬èº«é€»è¾‘è¾ƒä¸ºæ··ä¹±ã€‚æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥æ ¹æ®ä¸Šè¿°è¯´æ˜è‡ªè¡Œæ‰¾æºç å¯¹ç…§ç†è§£ã€‚
:::

 `Informer`çš„æ•´ä½“ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
<img src={InformerPNG} style={{height: "620px"}}/>

:::tip `Informer`çš„å†å²

`Informer`çš„å†å²æœ€æ—©å¯ä»¥è¿½æº¯åˆ°[<GitHubSVG /> Pull Request #6546](https://github.com/kubernetes/kubernetes/pull/6546)ã€‚
å¼•å…¥`Informer`ç»“æ„çš„åŠ¨æœºæ ¹æ®ä½œè€…commitä¿¡æ¯ï¼ˆ[880f922](https://github.com/lavalamp/kubernetes/commit/880f922bb673e4e9010cd848fe76e9c5b0d2bd1f)ï¼‰:
> Add easy setup for simple controller

å¯è§`Informer`å°±æ˜¯ä½œä¸ºè¾…åŠ©ä¾¿äºåˆ›å»º`Controller`ç»“æ„è€Œå­˜åœ¨çš„ã€‚

:::

## Reflectorçš„resyncæœºåˆ¶
åœ¨æœ€åï¼Œä¸ºäº†è®©æœ¬èŠ‚æ‰€æœ‰çŸ¥è¯†å½¢æˆé—­ç¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å†ä»‹ç»ä¸€ä¸‹`Reflector`ç»„ä»¶çš„*resyncæœºåˆ¶*ã€‚
:::tip æ³¨
æˆ‘ä»¬å¹¶æ²¡æœ‰æŠŠæ­¤å°èŠ‚å¹¶å…¥[Reflectorç»„ä»¶](#Reflectorç»„ä»¶)ä¸­ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ã€‚ä¸€æ–¹é¢æ˜¯ä¸æƒ³åŠ é‡è¯»è€…çš„é˜…è¯»è´Ÿæ‹…ï¼Œ
å¦ä¸€æ–¹é¢ï¼Œåœ¨è¯¥å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»…ä»…çŸ¥é“äº†`DeltaFIFO`çš„"ç”Ÿäº§è€…"â€”â€”`ListAndWatch()`å‡½æ•°ï¼Œå½¼æ—¶è¿˜æ²¡æœ‰ä»‹ç»`DeltaFIFO`çš„"æ¶ˆè´¹è€…"â€”â€”[Controllerç»„ä»¶](#Controllerç»„ä»¶)ä¸­çš„"å›è°ƒå‡½æ•°"ã€‚åœ¨æ²¡æœ‰çŸ¥é“å®Œæ•´çš„èƒŒæ™¯ä¹‹å‰ï¼Œä¸åˆ©äºæˆ‘ä»¬å¯¹*resyncæœºåˆ¶*çš„ç†è§£ã€‚
:::

*resyncæœºåˆ¶*æ˜¯æŒ‡**å®šæ—¶**å°†`Indexer`ç»„ä»¶ä¸­çš„æ•°æ®é‡æ–°åŒæ­¥å›`DeltaFIFO`é˜Ÿåˆ—ä¸­ã€‚
:::tip æ³¨
åœ¨å¾ˆå¤šæ–‡ç« æˆ–è€…æŠ€æœ¯åšå®¢ä¸­ï¼Œå®ƒä»¬ç§°ä¹‹ä¸º`Informer`çš„resyncæœºåˆ¶ã€‚å…¶å®å®šæ—¶çš„`resync`æ˜¯åœ¨`Reflector`çš„`ListAndWatch()`æ–¹æ³•ä¸­å¯åŠ¨çš„ã€‚
å¦å¤–ï¼Œ*resync*åŠ¨ä½œæ˜¯`Reflector`ä¸­ä¸¤ä¸ªç¼“å­˜ç»„ä»¶`DeltaFIFO`å’Œ`Indexer`ä¹‹é—´çš„æ•°æ®åŒæ­¥ï¼Œ
åŒæ—¶ä¹Ÿæ­£å¦‚æˆ‘ä»¬åœ¨[Informer](#informer)å°èŠ‚ä¸­æ‰€å¼ºè°ƒçš„é‚£æ ·ï¼Œ`Informer`æ˜¯ä¸€ä¸ªç»™è°ƒç”¨è€…å°è£…çš„ä¸€ä¸ª"å£³"ã€‚
å› æ­¤ï¼Œ`Reflector`çš„*resyncæœºåˆ¶*æ˜¯ä¸€ç§æ›´ä¸ºä¸¥è°¨çš„è¡¨è¿°ã€‚
:::

é‚£ä¹ˆä¸ºä»€ä¹ˆè¦å¼•å…¥*resyncæœºåˆ¶*å‘¢ï¼Ÿ
å®˜æ–¹å¼€å‘è€…è€ƒè™‘åˆ°å›è°ƒå‡½æ•°åœ¨å¤„ç†ï¼ˆæ¶ˆè´¹ï¼‰ä»`DeltaFIFO`é˜Ÿåˆ—ä¸­popå‡ºçš„äº‹ä»¶æ—¶ï¼Œå¯èƒ½ä¼šå­˜åœ¨å¤„ç†å¤±è´¥çš„æƒ…å†µï¼Œå¼•å…¥å®šæ—¶çš„*resyncæœºåˆ¶*è®©è¿™äº›å¤„ç†å¤±è´¥çš„äº‹ä»¶æœ‰äº†é‡æ–°è¢«å¤„ç†çš„æœºä¼šã€‚

é‚£ä¹ˆç»è¿‡*resync*é‡æ–°æ”¾å…¥`DeltaFIFO`é˜Ÿåˆ—çš„äº‹ä»¶ï¼Œå’Œç›´æ¥ä»`kube-apiserver` ä¸­ç›‘å¬åˆ°çš„äº‹ä»¶æœ‰ä»€ä¹ˆä¸ä¸€æ ·å‘¢ï¼Ÿ
é¦–å…ˆï¼Œä¸åŒäº`kube-apiserver`ä¸­ç›‘å¬åˆ°çš„ä¸‰ç§äº‹ä»¶ç±»å‹ï¼ˆ`Added`ï¼Œ`Updated`ï¼Œ`Deleted`ï¼‰ï¼Œå®ƒçš„ç±»å‹ä¸º`Sync`ã€‚

é™¤æ­¤ä»¥å¤–ï¼Œ`Sync`ç±»å‹çš„äº‹ä»¶åœ¨å‹å…¥`DeltaFIFO`æ—¶ï¼Œä¼šæ£€æŸ¥`DeltaFIFO`ä¸­è¯¥èµ„æºçš„äº‹ä»¶åˆ‡ç‰‡ï¼ˆ`[]Delta`ï¼‰æ­¤åˆ»æ˜¯å¦å·²ç»å«æœ‰äº‹ä»¶äº†ï¼ˆäº‹ä»¶åˆ‡ç‰‡é•¿åº¦å¤§äº0ï¼‰ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆåˆ™æ”¾å¼ƒ*resync*ã€‚
åŸå› æ˜¯`DeltaFIFO`ä¸­æ­¤åˆ»å·²ç»å­˜åœ¨çš„èµ„æºçš„äº‹ä»¶ï¼ˆä»`kube-apiserver`ä¸­"æ–°é²œå‡ºç‚‰"ï¼‰ä¸€å®šæ¯”*resync*æœºåˆ¶ä¸­"å·²ç»å‡ºç‚‰"ä½†å‡†å¤‡"å›ç‚‰é‡é€ "çš„èµ„æºæ›´"æ–°"ã€‚è¿™ç§å‹å…¥å‰çš„æ£€æŸ¥ä¼šå‡å°‘**é‡å¤æ¶ˆè´¹**å‘ç”Ÿçš„æœºç‡ã€‚

å¦å¤–ï¼Œ`Reflector`ç»„ä»¶ä¹Ÿæ”¯æŒé€šè¿‡å‚æ•°æŒ‡å®š*resync*åŠ¨ä½œçš„å‘ç”Ÿé¢‘ç‡ã€‚ç°åœ¨æˆ‘ä»¬å†å›è¿‡å¤´æ¥çœ‹çœ‹`Reflector`çš„åˆå§‹åŒ–å‡½æ•°ï¼š
```
func NewReflector(
     lw ListerWatcher,
     expectedType interface{},
     store Store,
     resyncPeriod time.Duration) *Reflector {
	// ...
}
```
è¿™å››ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ï¼š
* `lw`â€”â€”æŸèµ„æºç±»å‹çš„ç›‘å¬å‡½æ•°
* `expectedType`â€”â€”æ‰€ç›‘å¬èµ„æºç±»å‹çš„*kind*
* `store`â€”â€”èµ„æºæœ¬åœ°ç¼“å­˜`Indexer`
* `resyncPeriod`â€”â€”**ç”¨äºæŒ‡å®š*resync*åŠ¨ä½œçš„å‘ç”Ÿé¢‘ç‡**ï¼ˆ`0`è¡¨ç¤ºä¸æ‰§è¡Œ*resync*ï¼‰

:::tip `resync`æœºåˆ¶çš„å†å²
*resync*æœºåˆ¶çš„å¼•å…¥æœ€æ—©å¯ä»¥è¿½æº¯åˆ°[Pull Request #4923](https://github.com/kubernetes/kubernetes/pull/4923)ã€‚æ­£å¦‚ä½œè€…èµ·çš„PRæ ‡é¢˜ä¸€æ ·ï¼š
> Allow reflector to do full resync periodically

æ„æ€æ˜¯è¯´å…è®¸**`Reflector`**å¯ä»¥å‘¨æœŸæ€§åœ°åš**å…¨åŒæ­¥**ã€‚
ä¸è¿‡æœ€åˆç‰ˆæœ¬çš„*resync*å…¶å®å¹¶ä¸æ˜¯æŒ‡ä»`Indexer`ä¸­åŒæ­¥å›`DeltaFIFO`ä¸­ï¼Œåœ¨æ­¤PRä¸­ï¼Œä½œè€…æ‰€è°“çš„**å…¨åŒæ­¥**å°±æ˜¯æŒ‡å‘¨æœŸæ€§åœ°é‡æ–°**`List()`**ä¸€æ¬¡ã€‚

ç›´åˆ°[<GitHubSVG /> Issue #23394](https://github.com/kubernetes/kubernetes/issues/23394)ï¼Œç¤¾åŒºå¼€å‘è€…æ‰å†³å®šå°†`List()`ä»*resync*ä¸­åˆ†ç¦»ã€‚
æœ€ç»ˆï¼Œå°†`List()`ä»*resync*æœºåˆ¶ä¸­åˆ†ç¦»çš„[<GitHubSVG /> Pull Request #24142](https://github.com/kubernetes/kubernetes/pull/24142)è¢«åˆå¹¶å…¥[Kubernetes v1.3.0-alpha.5](https://github.com/kubernetes/kubernetes/tree/v1.3.0-alpha.5)ã€‚

:::


## ä½¿ç”¨Informer[ğŸˆ](../intro#çº¦å®š)

å¯ä»¥è¯´æœ¬å°èŠ‚ä¹‹å‰çš„æ‰€æœ‰å†…å®¹éƒ½åœ¨ä¸ºå¦‚ä½•ä½¿ç”¨`Informer`ç»„ä»¶åšé“ºå«ã€‚
æˆ‘ä»¬é¦–å…ˆæ¥çœ‹å¦‚ä½•åˆå§‹åŒ–ä¸€ä¸ª`Informer`ï¼š
<details>
<summary>åˆå§‹åŒ–Informerï¼ˆåŸºäºclient-go v1.5.2ï¼‰</summary>

```go
import (
	"fmt"

	"k8s.io/client-go/1.5/kubernetes"
	"k8s.io/client-go/1.5/pkg/api"
	v1 "k8s.io/client-go/1.5/pkg/api/v1"
	"k8s.io/client-go/1.5/pkg/runtime"
	"k8s.io/client-go/1.5/pkg/watch"
	"k8s.io/client-go/1.5/rest"
	"k8s.io/client-go/1.5/tools/cache"
)

func main() {
	// creates the in-cluster config
	config, _ := rest.InClusterConfig()
	// creates the clientset
	clientset, _ := kubernetes.NewForConfig(config)

	cache.NewInformer(&cache.ListWatch{
		ListFunc: func(options api.ListOptions) (runtime.Object, error) {
			return clientset.Core().Pods("default").List(options)
		},
		WatchFunc: func(options api.ListOptions) (watch.Interface, error) {
			return clientset.Core().Pods("default").Watch(options)
		},
	},
		&v1.Pod{},
		0,
		cache.ResourceEventHandlerFuncs{
			AddFunc: func(obj interface{}) {
				p := obj.(*v1.Pod)
				fmt.Printf("pod %s is added", p.Name)
			},
			UpdateFunc: func(oldObj, newObj interface{}) {
				o := oldObj.(*v1.Pod)
				n := newObj.(*v1.Pod)
				fmt.Printf("pod %s is updated from %v to %v", o.Name, o.Spec, n.Spec)
			},
			DeleteFunc: func(obj interface{}) {
				p := obj.(*v1.Pod)
				fmt.Printf("pod %s is deleted", p.Name)
			},
		})
}

```
</details>

åˆå§‹åŒ–`Informer`ä¸€å…±éœ€è¦å››ä¸ªå‚æ•°ï¼š
* æŸèµ„æºç±»å‹çš„ç›‘å¬å‡½æ•°
* æ‰€ç›‘å¬èµ„æºç±»å‹çš„*kind*
* resyncå‘ç”Ÿé¢‘ç‡
* ä¸‰ç§äº‹ä»¶å¯¹åº”çš„å›è°ƒå‡½æ•°ï¼ˆ`AddFunc`ï¼Œ`UpdateFunc`ï¼Œ`DeleteFunc`ï¼‰

è¿™å››ä¸ªå‚æ•°å·²ç»åœ¨ä¹‹å‰ç›¸åº”çš„å„ä¸ªç»„ä»¶ä¸­ä»‹ç»è¿‡äº†ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¸å†èµ˜è¿°ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨`Informer`ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨å‰é¢æ‰€è¯´ï¼Œ`Informer`ç»„ä»¶æœ¬èº«å¹¶ä¸å…·æœ‰ä»»ä½•å®è´¨æ€§çš„ç»„ä»¶ï¼Œæˆ‘ä»¬ä½¿ç”¨`Informer`æœ¬è´¨ä¸Šåœ¨ä½¿ç”¨å®ƒæ‰€**ä»£ä¸ºåˆ›å»º**çš„ä¸¤ä¸ªç»„ä»¶`Controller`å’Œ`Indexer`ã€‚

`NewInformer`å‡½æ•°å°†ä»£ä¸ºåˆ›å»ºçš„è¿™ä¸¤ä¸ªç»„ä»¶è¿”å›ä»¥ä¾›è°ƒè€…ä½¿ç”¨ï¼š
```go
localCache, controller  := cache.NewInformer(...)
```
ä¹‹åæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨`Controller`çš„`Run()`å‡½æ•°è®©æ•´ä¸ª`Informer`è¿è½¬èµ·æ¥ã€‚
```go
controller.Run()
```
è€Œ`Indexer`ä½œä¸ºä¸€ä¸ªæœ¬åœ°ç¼“å­˜ç»“æ„ï¼Œ`client-go`ä¸ºå®ƒæä¾›äº†ä¸°å¯Œçš„æ–¹æ³•ä»¥ä¾›æ£€ç´¢èµ„æºï¼š
```go title="k8s.io/client-go/tools/cache/store.go"
type Store interface {
	Add(obj interface{}) error
	Update(obj interface{}) error
	Delete(obj interface{}) error
	List() []interface{}
	ListKeys() []string
	Get(obj interface{}) (item interface{}, exists bool, err error)
	GetByKey(key string) (item interface{}, exists bool, err error)
	// ...
}
```

## å°ç»“

:::tip å°ç»“
æˆ‘ä»¬ä»æ„æˆ`Informer`çš„åŸºæœ¬ç»„ä»¶è¯´èµ·ï¼Œæœ€ç»ˆæç»˜äº†`Informer`çš„æ•´ä½“ç»“æ„ã€‚

ç®€å•æ¥è¯´ï¼Œä½ å¯ä»¥æŠŠ`Informer`ç†è§£æˆä¸€ä¸ªç”±æŸä¸€èµ„æºç±»å‹çš„`List()`å’Œ`Watch()`å‡½æ•°é©±åŠ¨çš„æœ¬åœ°èµ„æºç¼“å­˜ï¼ŒåŒæ—¶å®ƒä¹Ÿæä¾›äº†é’ˆå¯¹èµ„æºå˜æ›´äº‹ä»¶çš„é€šçŸ¥åŠå¤„ç†æœºåˆ¶ï¼›
:::

:::tip æ³¨
ä¸åŒäºå…¶ä»–æ–‡ç« æˆ–è€…åšå®¢ä»‹ç»`Informer`çš„æ€è·¯ï¼Œåœ¨æœ¬èŠ‚ä¸­ï¼š
1. æˆ‘ä»¬æ²¡æœ‰åŸºäº`client-go`ä¸­æ›´è¢«å¹¿æ³›ä½¿ç”¨çš„`SharedIndexInformer`ã€‚æˆ‘ä»¬è®¤ä¸ºä»‹ç»æ›´ä¸ºåŸºç¡€çš„`Informer`ç»“æ„æ›´å®¹æ˜“è®©è¯»è€…æ¥å—ã€‚å¦å¤–ï¼Œä¸ºäº†è®©å®ç°çš„æ§åˆ¶å™¨å°½å¯èƒ½ä¿æŒç²¾ç®€ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„ä¹Ÿæ˜¯`Informer`è€Œé`SharedIndexInformer`ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸å†ä»‹ç»`SharedIndexInformer`çš„æœ‰å…³å†…å®¹ã€‚
2. æˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨ä»‹ç»`Informer`çš„åŒæ—¶å¼•å…¥`client-go`ä¸­çš„`workqueue`ã€‚
æ ¹æ®`Informer`çš„æºç ï¼Œå®ƒæœ¬èº«è¿è¡Œå¹¶ä¸éœ€è¦`workqueue`ç»„ä»¶ã€‚`client-go`ä¸­æä¾›çš„`workqueue`ä»…ä»…æ˜¯ä¸€ç§**å¢å¼º**ã€‚
å®ƒå¯ä»¥è¢«ä½¿ç”¨åœ¨æœ¬èŠ‚æ‰€è¯´çš„"å›è°ƒå‡½æ•°"ä¸­ï¼Œç›¸æ¯”äºåœ¨"å›è°ƒå‡½æ•°"ä¸­å•ç‹¬**ç›´æ¥**å¤„ç†å„ä¸ªäº‹ä»¶ï¼Œ
æˆ‘ä»¬å¯ä»¥åœ¨å„ä¸ª"å›è°ƒå‡½æ•°"é‡ŒæŠŠäº‹ä»¶å…ˆæš‚æ—¶æ”¾å…¥åˆ°`workqueue`ä¸­ï¼Œæˆ‘ä»¬å†ç»Ÿä¸€ä»`workqueue`ä¸­"æå–"å¹¶å¤„ç†è¿™äº›äº‹ä»¶ã€‚
`client-go`ä¸­å·²ç»ä¸ºæˆ‘ä»¬æä¾›äº†å¤šç§é˜Ÿåˆ—ç±»å‹ï¼šé€šç”¨é˜Ÿåˆ—ã€é™é€Ÿé˜Ÿåˆ—ã€å»¶æ—¶é˜Ÿåˆ—ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿™äº›å®˜æ–¹å¼€å‘è€…å®ç°é«˜æ•ˆä¸”å¯é å®‰å…¨çš„é˜Ÿåˆ—æ¥å¸®åŠ©æˆ‘ä»¬ç¼–å†™é«˜è´¨é‡çš„ç¨‹åºã€‚
ä¸ºäº†é™ä½è¯»è€…é˜…è¯»çš„è´Ÿæ‹…ï¼Œå¹¶ä¸”ç”±äºæœ¬ä¹¦å®ç°çš„æ§åˆ¶å™¨æä¸ºç²¾ç®€ï¼Œå®ƒæ²¡æœ‰å†åˆ©ç”¨`workqueue`å¢å¼ºï¼Œæˆ‘ä»¬åœ¨æœ¬å°èŠ‚ä¹Ÿä¸å†èµ˜è¿°`workqueue`ç»„ä»¶ã€‚
:::
[^1]: è¯·æ³¨æ„ï¼Œinformeræ¡†æ¶æœ¬èº«å¹¶ä¸æ˜¯åœ¨[Kubernetes v1.5.0](https://github.com/kubernetes/kubernetes/tree/v1.5.0)æ—¶æ‰æå‡ºã€‚åœ¨[Kubernetes v1.5.0](https://github.com/kubernetes/kubernetes/tree/v1.5.0)ä¹‹å‰ï¼Œinformeræ¡†æ¶è€¦åˆåœ¨`kubernetes`åº“å†…ï¼ˆ`k8s.io/kubernetes/pkg/controller/framework/informers`ï¼‰ã€‚
      åœ¨[Kubernetes v1.4.0-alpha.3](https://github.com/kubernetes/kubernetes/tree/v1.4.0-alpha.3)ï¼ŒKubernetesç¤¾åŒºæ‰å¼€å§‹æœ‰äº†å•ç‹¬çš„å®¢æˆ·ç«¯åº“`client-go`ã€‚åœ¨[Kubernetes v1.5.0](https://github.com/kubernetes/kubernetes/tree/v1.5.0)æ—¶å®Œæˆäº†informeræ¡†æ¶åˆ°`client-go`çš„è¿ç§»ã€‚

      å…³äº`client-go`åº“çš„å†å²å¯ä»¥å‚è€ƒKubernetesçš„[Issue #28559](https://github.com/kubernetes/kubernetes/issues/28559)ã€‚

      å…³äºinformeræ¡†æ¶è¿å…¥`client-go`çš„å†å²å¯ä»¥å‚è€ƒ`client-go`çš„[<GitHubSVG /> Issue #4](https://github.com/kubernetes/client-go/issues/4)ä»¥åŠKubernetesçš„[<GitHubSVG /> Pull Request #32718](https://github.com/kubernetes/kubernetes/pull/32718)å’Œ[<GitHubSVG /> Pull Request #34989](https://github.com/kubernetes/kubernetes/pull/34989)ã€‚
[^2]: åœ¨æœ¬èŠ‚ä¸­ï¼Œ`cache`æŒ‡çš„æ˜¯`client-go`çš„`tools`åŒ…ä¸­çš„`cache`å­åŒ…ã€‚



